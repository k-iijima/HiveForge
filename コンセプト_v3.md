# HiveForge — Prototype Assembly（POC）v3

> 実験的・自律型ソフトウェア組立システム
> 
> v3の目的：**実装可能な粒度まで設計判断を確定し、Phase 0を着手可能にする**。

---

## 用語集

| 用語 | 説明 |
|------|------|
| **AR (Akashic Record)** | 全イベントを追記保存する不変ログ。プロジェクトの唯一の信頼源 |
| **SSOT (Single Source of Truth)** | 単一信頼源。情報の正規の保存場所 |
| **ULID** | Universally Unique Lexicographically Sortable Identifier。時系列ソート可能な一意ID |
| **MCP (Model Context Protocol)** | LLMとツール間の標準通信プロトコル |
| **投影 (Projection)** | イベントから導出した現在状態のスナップショット |
| **Core** | HiveForgeのバックエンド。AR書き込み権限を持つ唯一のコンポーネント |
| **Heartbeat** | 実行中のRunが生存していることを示す定期イベント |
| **Decision** | 人間の承認を要する意思決定ゲート |
| **Artifact** | タスク実行で生成された成果物（コード、ドキュメント等） |
| **transient障害** | 一時的な障害（タイムアウト等）。自動リトライ対象 |
| **permanent障害** | 恒久的な障害（認証失敗等）。即エスカレーション |

---

## 1. POCのゴール（測定可能な成果物）

### 1.0 POC成果物の定義

> **POCの成果物は「VS Code内で完結するHiveForgeシステム」である。**

| コンポーネント | 役割 |
|----------------|------|
| **Copilot Chat** | 要求投入、承認、状態確認などの対話的操作 |
| **VS Code拡張** | ダッシュボード、イベントログ、因果グラフなどの可視化 |
| **MCP Server** | Copilot ChatとCoreの橋渡し |
| **Hive Core** | バックエンド（AR、状態機械、LLM呼び出し） |

- HiveForgeが「別のアプリを自律生成してデプロイする」のはPhase 1以降
- POCでは「VS Code内で要求投入から状態確認まで完結」を示す

### 1.1 前提スコープ

- 成果物は **VS Code拡張 + MCP Server + Hive Core**
- チャットUI: **VS Code内GitHub Copilot Chat**
- 監視UI: **VS Code拡張**（Webviewでダッシュボード等）
- デプロイ形態：**ローカル（開発環境）** および **Docker**
- 外部依存：**GitHub Copilotサブスクリプション** 必須、LLM API（OpenAI互換）はオプション

### 1.2 必須成果物（Definition of Done）

- [x] VS CodeでCopilot Chat経由でHiveForgeと対話できる
- [x] VS Code拡張でダッシュボード・イベントログが確認できる
- [x] 要求を投入すると、AR（イベントログ）に記録される
- [x] タスクが生成・実行され、状態遷移が確認できる
- [x] 任意の成果物から「なぜ」を遡及できる（因果リンク）
- [x] 沈黙（タイムアウト）が検出され、記録・停止が発動する
- [x] 緊急停止（EmergencyStop）が機能する

### 1.3 POCの非目的

- 完全自律で正しいコードを出し続ける
- 本番SLA・法務レベル監査
- コスト最適化（暴走防止は設ける）
- HiveForgeが別アプリを生成・デプロイする（Phase 1）

---

## 2. 基本思想

- 万能AIは存在しない
- 知性は **構造・流れ・制約** から生まれる
- 人間は指揮し、AIは実行する
- 進捗は常に **可視・追跡・説明可能**
- 自律性は **制御され、中断可能**

> 「制御」= **状態機械 + 監査可能イベント列 + 強制停止条件 + Core API経由の書き込み**

---

## 3. 実行モデル

### 3.1 アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────┐
│                         VS Code                              │
│  ┌──────────────────┐  ┌────────────────────────────────┐   │
│  │  GitHub Copilot  │  │  HiveForge Extension           │   │
│  │      Chat        │  │  ├─ ダッシュボード (Webview)    │   │
│  │  （対話・操作）   │  │  ├─ イベントログ (TreeView)    │   │
│  └────────┬─────────┘  │  ├─ 因果グラフ (Webview)       │   │
│           │            │  └─ ステータスバー             │   │
│           │            └────────────────┬───────────────┘   │
└───────────┼─────────────────────────────┼───────────────────┘
            │ MCP                         │ Core API (内部)
            ▼                             ▼
┌─────────────────────────────────────────────────────────────┐
│                   HiveForge MCP Server                       │
│  ┌─────────────────────────────────────────────────────────┐│
│  │                    MCP Tools                            ││
│  │  submit_requirement / list_tasks / approve_decision     ││
│  │  get_lineage / emergency_stop / get_status ...          ││
│  └─────────────────────────────────────────────────────────┘│
│                           │                                  │
└───────────────────────────┼──────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      Hive Core                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  Orchestrator│  │ AR Writer   │  │ Projection Builder │  │
│  │  (状態機械)  │  │ (追記+連鎖) │  │  (同期更新)        │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
│         │                │                    │              │
│         ▼                ▼                    ▼              │
│  ┌─────────────────────────────────────────────────────────┐│
│  │              Akashic Record (AR)                        ││
│  │   events/ ──▶ snapshots/ ──▶ projections/               ││
│  └─────────────────────────────────────────────────────────┘│
│         │                                                    │
│         ▼                                                    │
│  ┌─────────────┐                                            │
│  │  LLM Client │ ◀── Copilot SDK / OpenAI互換API           │
│  └─────────────┘                                            │
└─────────────────────────────────────────────────────────────┘
```

### 3.1.1 GitHub Copilot統合の利点

| 項目 | 利点 |
|------|------|
| **既存UI活用** | VS Code + Copilot Chatは開発者が既に使用中。専用UI開発不要 |
| **MCPネイティブ対応** | CopilotはMCP Serverと直接通信可能 |
| **ツール呼び出し** | CopilotがHiveForgeのツールを自動で選択・実行 |
| **コンテキスト共有** | ファイル、ターミナル、Git状態を自動で参照 |
| **課金一元化** | Copilotサブスクリプションに含まれる |
| **BYOK対応** | 必要に応じて自前LLM API Keyも使用可 |

### 3.1.2 VS Code拡張の構成

> **監視・可視化UIはVS Code拡張として実装し、Copilot Chatと役割分担する。**

| 拡張機能コンポーネント | 実装方式 | 用途 |
|------------------------|----------|------|
| **ダッシュボード** | Webview Panel | システム状態、タスク進捗、メトリクス |
| **イベントログ** | TreeView | イベント一覧、フィルタ、検索 |
| **因果グラフ** | Webview Panel | 親子関係の可視化（D3.js等） |
| **要求一覧** | TreeView | 要求の状態、関連タスク |
| **承認キュー** | TreeView + QuickPick | 承認待ちアイテム、ワンクリック承認 |
| **ステータスバー** | StatusBarItem | 稼働状態、タスク数、アラート |
| **通知** | Information/Warning Message | 承認要求、エラー、完了通知 |

**役割分担:**

| 操作タイプ | UI | 例 |
|------------|-----|-----|
| 対話・指示 | Copilot Chat | 「要求を登録」「状況を教えて」「承認して」 |
| 監視・閲覧 | VS Code拡張 | ダッシュボード確認、ログ閲覧、グラフ表示 |
| 緊急操作 | 両方 | 緊急停止ボタン（拡張）/ 「緊急停止」（Chat） |

### 3.2 Agentの正体

> **POCでは「Agent」は独立プロセスではなく、CoreがLLMを呼び出す際の「役割プロンプト」である。**

| 概念 | 実装 |
|------|------|
| Agent | LLM呼び出し時のシステムプロンプト（役割定義） |
| Task実行 | Core → LLM API → 結果をARに記録 |
| Heartbeat | LLMストリーミング応答中にチャンク単位でARへ記録（下記参照） |
| 複数Agent協調 | Coreが順次または条件分岐でLLMを呼び出す |

#### 3.2.1 Heartbeat実装パターン

> **LLMストリーミング応答のチャンク受信をトリガーとしてHeartbeatを発行する。**

```
RunStarted
    │
    ├── LLMチャンク受信 ──▶ 前回Heartbeatから30秒経過？ ──Yes──▶ Heartbeat発行
    │                                │
    │                               No
    │                                │
    │                                └── 何もしない（次のチャンクを待つ）
    ▼
RunFinished
```

| 方式 | 説明 |
|------|------|
| チャンク駆動 | ストリーミング応答のチャンク受信時に経過時間を確認 |
| 時間間隔 | `heartbeat_interval_seconds`（デフォルト30秒）以上経過していれば発行 |
| 非ストリーミング時 | バックグラウンドタイマーで定期発行（asyncio.create_task等） |

**統一方針:**
> **ストリーミングが停止（チャンクが来ない）した場合、Heartbeatは発行せず沈黙検出に任せる。**

| 状況 | 動作 |
|------|------|
| チャンク受信中 | 30秒経過でHeartbeat発行 |
| チャンク停止（LLM無応答） | Heartbeat発行しない → 沈黙検出（90秒）でRunTimedOut |
| 非ストリーミングAPI | バックグラウンドタイマーで30秒ごとにHeartbeat |

将来的に外部ワーカー（人間、外部ツール）を追加する場合は、同じCore APIを経由する。

### 3.3 MCP Server インターフェース

> **HiveForge CoreはMCP Serverとしてツールを公開し、GitHub Copilotから直接呼び出される。**

#### 3.3.1 MCP Tools 一覧

| ツール名 | 説明 | パラメータ |
|----------|------|------------|
| `submit_requirement` | 要求を投入 | `title`, `description` |
| `list_requirements` | 要求一覧を取得 | `status?`, `limit?` |
| `list_tasks` | タスク一覧を取得 | `status?`, `requirement_id?` |
| `get_task_detail` | タスク詳細を取得 | `task_id` |
| `approve_decision` | 意思決定を承認 | `decision_id`, `comment?` |
| `reject_decision` | 意思決定を却下 | `decision_id`, `reason` |
| `get_lineage` | 因果リンクを辿る | `event_id`, `direction?`, `max_depth?` |
| `get_status` | システム状態を取得 | なし（下記参照） |
| `emergency_stop` | 緊急停止を発行 | `reason` |

**get_status レスポンス:**
```json
{
  "system_state": "running",       // running / paused / stopped
  "tasks": {
    "running": 3,
    "ready": 5,
    "succeeded": 42,
    "failed": 2,
    "aborted": 1
  },
  "pending_approvals": 2,           // 承認待ちDecision数
  "last_event_id": "01HZZ...",
  "last_event_at": "2026-01-31T12:00:00Z",
  "uptime_seconds": 3600
}
```
| `resume_system` | システムを再開 | なし |
| `list_events` | イベント一覧を取得 | `event_type?`, `since?`, `limit?` |
| `get_artifact` | 成果物情報を取得 | `artifact_id` |

#### 3.3.2 MCP Server 設定例

**VS Code settings.json:**
```json
{
  "mcp": {
    "servers": {
      "hiveforge": {
        "type": "stdio",
        "command": "python",
        "args": ["-m", "hiveforge.mcp_server"],
        "env": {
          "HIVEFORGE_VAULT_PATH": "./Vault"
        }
      }
    }
  }
}
```

**または HTTP モード:**
```json
{
  "mcp": {
    "servers": {
      "hiveforge": {
        "type": "http",
        "url": "http://localhost:8000/mcp/"
      }
    }
  }
}
```

#### 3.3.3 Copilot Chat での使用例

```
User: @hiveforge 新しい要求を登録して。ユーザー認証機能を追加したい

Copilot: submit_requirement ツールを使用して要求を登録します。
         → RequirementProposed イベントが記録されました (ID: req-001)
         
         要求「ユーザー認証機能」が登録されました。
         現在のステータス: Proposed
         次のステップ: 分析後、承認待ちになります。

User: @hiveforge 現在のタスク状況を教えて

Copilot: list_tasks ツールでタスク一覧を取得します。
         
         実行中のタスク:
         - task-042: API設計 (Running, 進捗 60%)
         - task-043: テスト作成 (Ready)
         
         完了済み: 15件 / 失敗: 2件
```

### 3.4 AR書き込み経路

```
[Copilot Chat] ──MCP──▶ [HiveForge MCP Server] ──▶ [Core] ──追記──▶ [AR events/]
                                                      │
[HTTP Client] ──REST──▶ [Core API] ────────────────────┤
                                                      │
                                                      ├──同期──▶ [projections/]
                                                      └──条件──▶ [snapshots/]
```

- **書き込み権限はCore APIのみ**
- 外部から直接 `events/` を書き換えることは禁止（ファイルシステム権限で保護）
- Core API は `idempotency_key` で重複排除

#### 3.4.1 ファイル権限保護

> **Vault/ディレクトリはCoreプロセスのみが書き込み可能とする。**

| OS | 推奨設定 |
|----|----------|
| Linux/macOS | `chmod 700 Vault/` + Coreプロセス専用ユーザーで実行 |
| Windows | Vault/フォルダのACLでCoreプロセス実行ユーザーのみ「変更」許可 |
| Docker | Vault/をボリュームマウントし、コンテナ内ユーザーのみ書き込み可 |

**POCでの簡易対応:**
- 開発環境ではOS権限設定は任意
- 本番/共有環境では上記設定を推奨

#### 3.4.2 idempotency_key 実装方式

> **idempotency_keyはインメモリ + 投影ファイルで永続化する。**

| 項目 | 仕様 |
|------|------|
| 保存先 | `projections/idempotency.json`（key → event_id のマップ） |
| 保持期間 | POCでは無期限（全履歴保持） |
| 衝突時の挙動 | 既存の `event_id` を返却（新規追記せず） |
| キー形式 | `{entity_type}:{entity_id}:{action}:{sequence}` 推奨 |

**例:**
```json
{
  "task-123:run-1:start": "01HZZ...",
  "task-123:run-1:finish": "01HZZ..."
}
```

**判定フロー:**
1. APIリクエスト受信
2. `idempotency_key` がインメモリキャッシュに存在 → 既存event_idを返却
3. 存在しない → イベント追記 → キャッシュと `idempotency.json` に追加

**原子更新方式:**
> **`idempotency.json` の更新も投影と同様に原子的に行う。**

1. `idempotency.json.tmp` に新しい内容を書き込み
2. `fsync` でディスクに強制書き込み
3. `os.replace()` でアトミックにリネーム

---

## 4. エンティティ定義

### 4.1 主要エンティティ

| エンティティ | 説明 | 状態を持つか |
|--------------|------|--------------|
| Requirement | 要求（ユーザー入力→分析→承認） | ✓ |
| Decision | 意思決定（ADR相当、承認ゲート） | ✓ |
| Task | 作業単位 | ✓ |
| Run | Taskの1回の試行 | ✓ |
| Artifact | 成果物（参照 + 実体ハッシュ） | ✓ |
| Constraint | 制約（実行時に参照） | ✗（適用/解除イベントで管理） |

### 4.2 Decisionデータモデル

> **Decisionは承認ゲートの核であり、何を承認するかを明確に記録する。**

| フィールド | 型 | 必須 | 説明 |
|------------|-----|------|------|
| `decision_id` | string | ✓ | ULID形式の一意識別子 |
| `kind` | enum | ✓ | `requirement_approval`, `destructive_operation`, `constraint_change` |
| `target` | string | ✓ | 対象のsubject（例: `requirement:req-001`） |
| `summary` | string | ✓ | 人間が読める要約（承認画面に表示） |
| `options` | array | - | 選択肢がある場合（例: 複数の実装案） |
| `chosen_option` | string | - | 承認時に選択されたオプション |
| `rationale` | string | - | 承認/却下の理由（ユーザー入力） |
| `requested_at` | timestamp | ✓ | DecisionRequested発行時刻 |
| `decided_at` | timestamp | - | 承認/却下時刻 |
| `decided_by` | actor | - | 承認/却下したアクター |

**Decisionの状態:**
- `Draft`: 下書き（まだRequestedでない）
- `Requested`: 承認待ち
- `Approved`: 承認済み
- `Rejected`: 却下済み
- `Superseded`: 新しいDecisionで置換

**Decisionの作成タイミング:**
> POCでは `Draft` 状態を経由せず、Coreが自動的に `DecisionRequested` を発行する。

| トリガー | 発行イベント | 説明 |
|----------|--------------|------|
| `RequirementAnalyzed` | `DecisionRequested` | 要求承認を求める |
| 破壊的操作の検出 | `DecisionRequested` | 操作承認を求める |
| Constraint変更 | `DecisionRequested` | 制約変更承認を求める |

**注意:** `Draft` 状態はPhase 1以降で複数案の事前作成に使用予定。POCでは未使用。

### 4.3 エラー分類

| 分類 | 説明 | 再試行 |
|------|------|--------|
| Transient | 一時的障害（タイムアウト、API rate limit、ネットワーク） | 自動（上限あり） |
| Permanent | 恒久的障害（認証失敗、スキーマ不正、ロジックエラー） | 不可（即エスカレーション） |

イベント例：
- `TaskFailed { error_class: "transient", reason: "timeout" }`
- `TaskFailed { error_class: "permanent", reason: "invalid_schema" }`

---

## 5. アカシックレコード（AR）

### 5.1 役割

- プロジェクトの**唯一の信頼できる情報源（SSOT）**
- **Coreのみが書き込み**、他は読み取り専用
- 因果関係（原因→結果）を保存

### 5.2 不変条件

- **追記のみ**（修正は訂正イベントを追記）
- **因果リンク必須**（`parents[]`）
- **ハッシュ連鎖**（`prev_hash` / `hash`）
- **全コマンドはイベント化**

### 5.3 ハッシュ連鎖

> **POCでは全イベントを1本のチェーンで連結する。**

```
event[0] ─hash─▶ event[1] ─hash─▶ event[2] ─hash─▶ ...
           │              │              │
        prev_hash      prev_hash      prev_hash
```

- 並列書き込みはCore内でシリアライズ（排他ロック）
- スケーラビリティはPhase 1以降で検討（エンティティ別チェーン等）

#### 5.3.1 POC脅威モデル

> **POCでは「ローカル単一ユーザー」を前提とし、外部攻撃者は想定しない。**

| 脅威 | POCでの対応 | Phase 1以降 |
|------|-------------|-------------|
| ファイル改ざん検知 | ハッシュ連鎖で検知可能 | 同左 |
| 改ざん者の特定 | **対応しない**（単一ユーザー前提） | イベント署名（鍵）を検討 |
| 中間者攻撃 | **対応しない**（localhost通信前提） | TLS必須化 |
| リプレイ攻撃 | idempotency_keyで防止 | 同左 + 有効期限 |
| 認証バイパス | API Key認証（オプション） | OAuth/OIDC |

**注意:** ハッシュ連鎖は「破損・改ざんの検知」が目的であり、「誰が改ざんしたか」の証明はPOCスコープ外。

### 5.4 ディレクトリ構造

```
Vault/
├── Akashic/
│   ├── events/
│   │   └── {YYYY-MM}/{YYYY-MM-DD}.jsonl   # 追記のみ
│   ├── snapshots/
│   │   ├── latest.json                    # 最新投影の複製
│   │   └── {timestamp}.json               # マイルストーン
│   ├── projections/
│   │   ├── requirements.json
│   │   ├── decisions.json
│   │   ├── tasks.json
│   │   ├── runs.json
│   │   └── artifacts.json
│   ├── schemas/
│   │   ├── event.v1.schema.json
│   │   └── projection.v1.schema.json
│   └── chain.json                         # prev_hash, latest_event_id
├── Artifacts/
│   └── {artifact_id}/
│       ├── content.*                      # 実体ファイル
│       └── manifest.json                  # hash, metadata
└── Context/
    ├── active_constraints.json      # 現在有効な制約一覧
    └── active_risks.json             # 検出済みリスク一覧（Phase 1で使用予定）
```

#### 5.4.1 JSONL仕様

> **行区切りはLF（`\n`）で統一する。**

| 項目 | 仕様 |
|------|------|
| 行区切り | LF（`\n`, `0x0A`）のみ。CRLFは使用しない |
| エンコーディング | UTF-8（BOMなし） |
| 1行 = 1イベント | 改行を含まない単一のJSONオブジェクト |
| 末尾 | 最終行もLFで終端 |

**Windows環境での注意:**
- Gitの `core.autocrlf` を `false` に設定
- エディタの改行コードをLFに固定
- Python: `open(..., newline='\n')` を使用

#### 5.4.2 ログローテーション

> **POCでもevents/の肥大化対策として上限を設定する。**

| 項目 | 設定 | 動作 |
|------|------|------|
| 日次ファイル分割 | 自動（`{YYYY-MM-DD}.jsonl`） | 日付変更時に新ファイル |
| 単一ファイル上限 | 100MB（推奨） | 超過時は `{YYYY-MM-DD}_001.jsonl` へ継続 |
| 月次フォルダ | 自動（`{YYYY-MM}/`） | 月変更時に新フォルダ |
| 古いイベントの削除 | **しない**（監査のため保持） | スナップショットで圧縮を検討（Phase 1） |

#### 5.4.3 バックアップ戦略

> **POCでは手動バックアップを推奨。Phase 1で自動化を検討。**

| 対象 | 頻度 | 方法 |
|------|------|------|
| `snapshots/` | 日次推奨 | ファイルコピーまたはGit commit |
| `events/` | 週次推奨 | フォルダ全体をアーカイブ |
| `Vault/` 全体 | マイルストーン時 | tar.gz または zip |

**復旧優先度:**
1. `events/` があれば全て再構築可能（最重要）
2. `snapshots/latest.json` があれば高速復旧可能
3. `projections/` は再生成可能（バックアップ不要）

### 5.5 イベントスキーマ（v1）

> **注意**: 有効なイベント型は **付録A** をSSOT（単一信頼源）とする。

```json
{
  "$schema": "event.v1.schema.json",
  "event_id": "01HZZ...",           // ULID（python-ulidで生成）
  "event_type": "RunStarted",       // 付録Aのイベント型のみ有効
  "version": 1,                     // スキーマバージョン
  "timestamp": "2026-01-31T12:00:00Z", // 常にUTC（ISO 8601形式）
  "actor": "core:orchestrator",     // または "user:{session_id}"
  "subject": "run:run-456",         // subjectはイベント型に対応
  "parents": ["01HZY..."],          // TaskAssignedのevent_id
  "idempotency_key": "task-123:run-456:start",
  "payload": {
    "task_id": "task-123",
    "timeout_seconds": 300
  },
  "prev_hash": "sha256:abc...",
  "hash": "sha256:def..."
}
```

#### 5.5.2 actor形式

| 形式 | 説明 | 例 |
|------|------|----|
| `core:{component}` | システムコンポーネント | `core:orchestrator`, `core:validator` |
| `user:{session_id}` | ユーザー操作 | `user:sess_abc123` |
| `external:{service}` | 外部サービス（将来用） | `external:github` |

#### 5.5.3 timestampとタイムゾーン

> **全てのtimestampは常にUTC（協定世界時）で記録する。**

- 形式: ISO 8601（`YYYY-MM-DDTHH:MM:SSZ`）
- ローカル時刻への変換はUIレイヤーで行う
- サーバー/クライアント間のタイムゾーン差異を排除

#### 5.5.4 payloadサイズ方針

> **payloadは64KB以下を推奨。超過するデータはArtifactに保存して参照する。**

| 項目 | 方針 |
|------|------|
| payload上限 | 64KB（推奨）。超過時は警告ログを出力 |
| LLMプロンプト | `prompt_artifact_id` としてArtifact参照を記録 |
| LLM応答 | `response_artifact_id` としてArtifact参照を記録 |
| 大きなテキスト | Artifact（kind: `text`）として保存 |
| バイナリ | 必ずArtifactとして保存（payloadには入れない） |

**例: RunFinishedイベントのpayload**
```json
{
  "task_id": "task-123",
  "success": true,
  "prompt_artifact_id": "artifact-456",   // プロンプト本体はArtifact
  "response_artifact_id": "artifact-789", // 応答本体はArtifact
  "summary": "APIエンドポイントを3件生成しました",  // 要約のみpayloadに
  "token_usage": { "prompt": 1500, "completion": 2000 }
}
```

**監査要件との整合:**
- LLM入出力の完全な記録はArtifactで担保
- イベントには参照（artifact_id）と要約のみを記録
- 因果追跡時にArtifactを辿れば完全な入出力を取得可能

### 5.5.1 ハッシュ正規化ルール

> **ハッシュ対象の正規化には RFC 8785 JSON Canonicalization Scheme (JCS) を採用する。**

| 項目 | ルール |
|------|--------|
| エンコーディング | UTF-8（BOMなし） |
| キー順序 | Unicode コードポイント昇順でソート |
| 数値 | 不要なゼロ・符号を除去（例: `1.0` → `1`） |
| 空白 | 不要な空白・改行を除去 |
| エスケープ | 必須エスケープのみ（`\"`, `\\`, 制御文字） |

**ハッシュ計算手順:**
1. イベントオブジェクトから `hash` フィールドを除外
2. JCS で正規化
3. SHA-256 でハッシュ
4. `sha256:{hex}` 形式で格納

### 5.6 投影更新

> **イベント追記時に同期更新する。**

1. Core がイベントを `events/` に追記
2. 追記成功後、`projections/*.json` を更新
3. ロック: **クロスプラットフォーム排他ロック**を使用（後述）

#### 5.6.1 クラッシュ整合性

> **設計原則: `events/` が正（SSOT）、`projections/` は派生データ（再構築可能）**

| シナリオ | 状態 | 復旧方法 |
|----------|------|----------|
| events追記成功、projection更新前にクラッシュ | eventsに最新、projectionは古い | 起動時に自動再構築 |
| events追記中にクラッシュ | 不完全なイベント行 | 起動時に末尾の不完全行を検出・破棄 |
| projection更新中にクラッシュ | projectionが破損 | 起動時に自動再構築 |

**投影更新手順（原子性確保）:**
1. `projections/{type}.json.tmp` に新しい内容を書き込み
2. `fsync` でディスクに強制書き込み
3. `os.replace()` でアトミックにリネーム（Windows/Unix両対応）

#### 5.6.2 ロック方式

> **クロスプラットフォーム対応のため、`portalocker` ライブラリ（Python）または同等のロックファイル方式を使用する。**

| プラットフォーム | 実装 |
|------------------|------|
| Windows | `LockFileEx` API（portalocker経由） |
| Unix/Linux | `fcntl.flock` または `fcntl.lockf`（portalocker経由） |

**ロック粒度:**
- POCでは `Vault/Akashic/.lock` 単一ファイルでグローバルロック
- Phase 1以降で細粒度ロック（エンティティ別）を検討

投影は「破棄して再構築可能」であるため、破損時は `events/` から再生成。

### 5.7 スキーマバージョニング

- イベントには `version` フィールドを持つ
- 投影再構築時、古いバージョンのイベントは変換ロジックを適用
- 破壊的変更時は新スキーマファイル（`event.v2.schema.json`）を追加

---

## 6. Artifact管理

### 6.1 実体の保存

- 成果物の実体は `Vault/Artifacts/{artifact_id}/content.*` に保存
- `manifest.json` にハッシュ（SHA-256）とメタデータを記録

**manifest.json スキーマ:**
```json
{
  "artifact_id": "artifact-001",
  "kind": "code",                    // code / text / binary / prompt / response
  "filename": "content.py",
  "mime_type": "text/x-python",
  "sha256": "abc123...",
  "size_bytes": 4096,
  "created_at": "2026-01-31T12:00:00Z",
  "source_event_id": "01HZZ...",    // ArtifactMaterializedのevent_id
  "metadata": {                      // kind固有の追加情報
    "language": "python",
    "line_count": 120
  }
}
```

### 6.2 改ざん検知

- 読み取り時に `manifest.json` のハッシュと実体を照合
- 不一致時は `ArtifactCorrupted` イベントを発行

### 6.3 Artifactイベント

| イベント | 意味 |
|----------|------|
| `ArtifactDeclared` | 存在を宣言（まだ実体なし） |
| `ArtifactMaterialized` | 実体を保存完了 |
| `ArtifactValidated` | 検証成功 |
| `ArtifactInvalidated` | 検証失敗（差し戻し） |
| `ArtifactCorrupted` | 改ざん/破損検知 |

---

## 7. 状態機械

### 7.1 Requirement

```
[Proposed] ──分析──▶ [Analyzed] ──承認──▶ [Approved] ──実装完了──▶ [Implemented] ──検証──▶ [Verified] (終端)
     │                    │                   │                          │
     └──却下──▶ [Rejected]  └──却下──▶ [Rejected]                          │
                                              │                          │
                                    [Superseded] ◀── 新要件で置換        │
                                              │                          │
                                    [Blocked] ◀── OscillationDetected ◀──┘
                                        │
                                        └── 人間介入後 → [Approved] へ復帰可
```

### 7.2 Decision

```
[Draft] ──提出──▶ [Requested] ──承認──▶ [Approved] ──置換──▶ [Superseded]
                       │
                       └──却下──▶ [Rejected]
```

### 7.3 Task

```
[Proposed] ──準備完了──▶ [Ready] ──割当──▶ [Assigned] ──開始──▶ [Running]
                            │                   ▲                    │
                            │                   │  ┌─────────────────┤
                            │                   │  ▼                 ▼
                            │                   │ [Succeeded]    [Failed]
                            │                   │      │              │
                            │                   │      ▼              │
                            │                   │ [Archived]         │
                            │                   │           ┌─transient┤
                            │                   │           ▼         ▼
                            │                   └────[Retrying]  permanent: [Aborted]
                            │                              │              │
                            │                              │              ▼
                            │                              │         [Archived]
                            │                              └── 上限超過 ──▶ [Aborted]
                            │
                            └── 依存タスク未完了: 待機（Ready維持）

※ いつでも EmergencyStop により [Aborted] へ強制遷移可能
※ Archived は完了タスクの長期保存状態（投影から除外可）
※ Retrying → Assigned: TaskRetryingイベント後、Coreが再割当
```

#### 7.3.1 遷移条件の詳細

| 遷移 | 条件 | 備考 |
|------|------|------|
| Proposed → Ready | 依存条件なし、または依存タスク全てSucceeded | Coreが自動判定 |
| Ready → Assigned | `max_concurrent_tasks`未満 かつ Ready状態タスクが存在 | Coreが自動割当（FIFO） |
| Assigned → Running | RunStartedイベント発行時 | 即時遷移 |
| Failed → Retrying | `retry_count < max_retries` かつ `error_class == "transient"` | Coreが自動判定 |
| Retrying → Assigned | Coreが再割当 | TaskAssignedイベント発行 |
| Succeeded → Archived | 一定期間経過（デフォルト7日）または手動 | 投影から除外してイベントのみ保持 |
| Aborted → Archived | 同上 | 同上 |

### 7.4 Run

> **注意:** `RunStarted`発行時点で状態は`Running`。`Started`は論理的な初期状態であり、
> 実際の投影では`Running`から開始する。Heartbeatは`Running`状態を維持する。

```
[Running] ──heartbeat──▶ [Running] ──完了──▶ [Finished]
    │                        │
    │                        ├──▶ [Crashed]（例外）
    │                        └──▶ [TimedOut]（沈黙検出）
    │
    └── timeout_seconds 超過（Heartbeatなし）──▶ [TimedOut]
```

**状態遷移の詳細:**
| イベント | 遷移 | 備考 |
|----------|------|------|
| `RunStarted` | - → Running | Runエンティティ作成 |
| `Heartbeat` | Running → Running | 最終Heartbeat時刻を更新 |
| `RunFinished` | Running → Finished | 正常完了 |
| `RunCrashed` | Running → Crashed | 例外発生 |
| `RunTimedOut` | Running → TimedOut | 沈黙検出 |

### 7.5 Artifact

```
[Declared] ──生成──▶ [Materialized] ──検証OK──▶ [Validated]
                            │                        │
                            └──検証NG──▶ [Invalidated]
                                              │
                            [Corrupted] ◀─────┘（ハッシュ不一致）
```

---

## 8. 統治（Governance）と人間介入

### 8.1 承認ゲート

| 操作 | 必要な承認 |
|------|------------|
| Requirement を Approved にする | `DecisionApproved`（User） |
| 破壊的操作（削除、外部デプロイ） | `DecisionApproved`（User） |
| Constraint の変更 | `DecisionApproved`（User） |

### 8.2 承認待ちタイムアウト

- 承認待ち状態が `approval_timeout_hours`（デフォルト: 24時間）を超過
- → `ApprovalTimedOut` イベント発行
- → 自動で `Rejected` または `Escalated`（ポリシーによる）

### 8.3 Break-glass（緊急介入）

- `POST /api/emergency-stop` で `EmergencyStopIssued` を発行
- 全 Running タスクを即座に `Aborted` へ遷移
- 新規タスク開始を禁止（`SystemPaused` 状態）
- 解除は `POST /api/resume` で `SystemResumed` を発行

### 8.4 暴走防止パラメータ

| パラメータ | デフォルト | 説明 |
|------------|------------|------|
| `max_retries` | 3 | Transient障害の最大再試行回数 |
| `max_oscillations` | 5 | Verify↔Build往復の最大回数 |
| `max_concurrent_tasks` | 10 | 同時実行タスク数 |
| `task_timeout_seconds` | 300 | タスク実行のタイムアウト |
| `heartbeat_interval_seconds` | 30 | Heartbeat間隔 |
| `approval_timeout_hours` | 24 | 承認待ちタイムアウト |

---

## 9. 失敗とリカバリ

### 9.1 沈黙検出（No Silent Failures）

**沈黙の定義:**
- `RunStarted` 後、`heartbeat_interval_seconds × 3` 以内に `Heartbeat` または `RunFinished/Crashed` がない

**検出時の挙動:**
1. `RunTimedOut` を発行
2. `TaskFailed { error_class: "transient", reason: "timeout" }` を発行
3. `retry_count < max_retries` なら `Retrying` → `Running`
4. 超過なら `Aborted` + `EscalationRequired` を発行

### 9.2 振動検出

- 同一Requirementに対する Verify→Build 差し戻しが `max_oscillations` を超過
- → `OscillationDetected` を発行
- → 該当Requirementを `Blocked` 状態にし、`ApprovalRequired` を発行

### 9.3 復旧手順

| 障害レベル | 検出 | 復旧 |
|------------|------|------|
| L1: タスク障害 | RunTimedOut / Crashed | 自動リトライ or Aborted |
| L2: 投影破損 | projection読み込みエラー | events/から再構築 |
| L3: イベント破損 | ハッシュ連鎖検証失敗 | 最終正常スナップショットから再開 |
| L4: システム停止 | プロセスクラッシュ | 再起動時にchain.jsonから継続 |

---

## 10. Core API エンドポイント

### 10.1 一覧

| Method | Path | 説明 |
|--------|------|------|
| GET | `/api/health` | ヘルスチェック |
| GET | `/api/projections/{type}` | 投影取得（requirements/tasks/...） |
| GET | `/api/events` | イベント一覧（ページネーション） |
| GET | `/api/events/{event_id}` | イベント詳細 |
| GET | `/api/events/{event_id}/lineage` | 因果リンク辿り（下記参照） |
| POST | `/api/requirements` | 要求投入 |
| POST | `/api/decisions/{id}/approve` | 承認 |
| POST | `/api/decisions/{id}/reject` | 却下 |
| POST | `/api/emergency-stop` | 緊急停止 |
| POST | `/api/resume` | 再開 |
| GET | `/api/artifacts/{id}` | Artifact取得 |
| GET | `/api/artifacts/{id}/content` | Artifact実体ダウンロード |

#### 10.1.0 ページング仕様

> **`/api/events` はcursor方式のページネーションを採用する。**

**リクエストパラメータ:**
| パラメータ | 型 | デフォルト | 説明 |
|------------|-----|------------|------|
| `cursor` | string | null | 前回レスポンスの`next_cursor`（初回は省略） |
| `limit` | int | 100 | 取得件数（最大500） |
| `event_type` | string | null | イベント型でフィルタ |
| `since` | timestamp | null | 指定時刻以降のイベント |
| `until` | timestamp | null | 指定時刻以前のイベント |

**レスポンス:**
```json
{
  "ok": true,
  "data": {
    "events": [ ... ],
    "next_cursor": "01HZZ...",  // 次ページがある場合
    "has_more": true
  }
}
```

**cursor仕様:**
- cursorは最後に返した`event_id`（ULID）をそのまま使用
- ULIDは時系列ソート可能なため、cursorとして最適
- cursorが無効な場合は`400 Bad Request`を返却

**読み取り一貫性:**
- ページング中に新規イベントが追記される可能性あり（best-effort）
- 厳密な一貫性が必要な場合は`until`で時刻を固定

**エラーコード:**
| コード | 説明 |
|--------|------|
| `INVALID_CURSOR` | cursorが無効または期限切れ |
| `LIMIT_EXCEEDED` | limitが上限を超過 |
| `VALIDATION_ERROR` | パラメータ不正 |
| `INTERNAL_ERROR` | サーバー内部エラー |

### 10.1.1 lineage API 実装方針

> **POCでは全走査を許容し、Phase 1でインデックスを導入する。**

| 方式 | POC | Phase 1以降 |
|------|-----|-------------|
| 親方向（ancestors） | `parents[]` を再帰的に辿る | 同左 |
| 子方向（descendants） | 全イベント走査で `parents` に含むものを検索 | `children[]` インデックス導入 |
| 計算量 | O(n) 許容（イベント数 < 10,000 想定） | インデックスで O(log n) |

**レスポンス例:**
```json
{
  "event_id": "01HZZ...",
  "ancestors": ["01HZY...", "01HZX..."],
  "descendants": ["01J00...", "01J01..."]
}
```

**POCでの制限:**
- `max_depth` パラメータで探索深度を制限（デフォルト: 10）
- 結果が多い場合は `truncated: true` を返却

### 10.2 認証（POC）

> **POCでもオプショナルでAPI Key認証を推奨（誤操作・意図しないアクセス防止）。**

| モード | 設定 | 用途 |
|--------|------|------|
| 無認証 | `auth.enabled: false` | ローカル開発（デフォルト） |
| API Key | `auth.enabled: true` + `auth.api_key` | 共有環境・Docker |

**API Key認証の動作:**
- リクエストヘッダー: `Authorization: Bearer {api_key}`
- 不正時: `401 Unauthorized` を返却
- `/api/health` は認証不要（ヘルスチェック用）

**設定例:**
```yaml
auth:
  enabled: true
  api_key_env: "HIVEFORGE_API_KEY"  # 環境変数から読み込み
```

#### 10.2.1 シークレット管理

> **API KeyやLLM API Keyは環境変数で管理し、リポジトリにコミットしない。**

| ファイル | 内容 | Git |
|----------|------|-----|
| `.env` | シークレット値 | `.gitignore`に追加（コミット禁止） |
| `.env.example` | テンプレート（値は空） | コミット可 |
| `hiveforge.config.yaml` | `*_env` で環境変数名を参照 | コミット可 |

**.env.example:**
```
OPENAI_API_KEY=
HIVEFORGE_API_KEY=
```

**.gitignore に追加:**
```
.env
.env.local
*.local.yaml
```

### 10.3 レスポンス形式

```json
{
  "ok": true,
  "data": { ... },
  "error": null
}
```

```json
{
  "ok": false,
  "data": null,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "..."
  }
}
```

---

## 11. Phase 0 デモフロー（シーケンス）

### 11.1 責任分担

> **Coreの自動処理トリガー:**
> - `RequirementProposed` → Coreが自動でLLM分析を開始 → `RequirementAnalyzed`
> - `RequirementAnalyzed` → Coreが自動で `DecisionRequested` を生成
> - `RequirementApproved` → Coreが自動でタスク分解 → `TaskProposed`

| ステップ | アクター | 入力 | 出力イベント |
|----------|----------|------|--------------|
| 1. 要求投入 | User（UI） | テキスト | `RequirementProposed` |
| 2. 要件分析 | Core（LLM） | Requirement | `RequirementAnalyzed` |
| 3. 承認 | User（UI） | 承認ボタン | `DecisionApproved`, `RequirementApproved` |
| 4. タスク生成 | Core | Requirement | `TaskProposed`, `TaskReady` |
| 5. タスク実行 | Core（LLM） | Task | `RunStarted`, `Heartbeat`..., `RunFinished` |
| 6. 成果物記録 | Core | 実行結果 | `ArtifactDeclared`, `ArtifactMaterialized` |
| 7. 検証 | Core（LLM） | Artifact | `ArtifactValidated` or `ArtifactInvalidated` |
| 8a. 成功 | Core | — | `TaskSucceeded`, `RequirementImplemented` |
| 8b. 差し戻し | Core | — | `TaskFailed`, 新`TaskProposed` |

### 11.2 シーケンス図

```
User          Copilot Chat    MCP Server      Core           AR            LLM
 │                 │               │            │              │              │
 │──@hiveforge────▶│               │            │              │              │
 │  要求登録       │──submit_req──▶│            │              │              │
 │                 │               │──POST────▶ │              │              │
 │                 │               │            │──append─────▶│ RequirementProposed
 │                 │               │            │              │              │
 │                 │               │            │──analyze────────────────────▶│
 │                 │               │            │◀─────────────────────result──│
 │                 │               │            │──append─────▶│ RequirementAnalyzed
 │                 │               │            │──append─────▶│ DecisionRequested
 │                 │               │            │              │              │
 │◀──承認待ち通知──│◀──────────────│◀───────────│              │              │
 │                 │               │            │              │              │
 │──承認──────────▶│               │            │              │              │
 │                 │──approve_dec─▶│            │              │              │
 │                 │               │──POST────▶ │              │              │
 │                 │               │            │──append─────▶│ DecisionApproved
 │                 │               │            │──append─────▶│ RequirementApproved
 │                 │               │            │──append─────▶│ TaskProposed
 │                 │               │            │──append─────▶│ TaskReady
 │                 │               │            │──append─────▶│ TaskAssigned
 │                 │               │            │──append─────▶│ RunStarted
 │                 │               │            │              │              │
 │                 │               │            │──execute────────────────────▶│
 │                 │               │            │    (streaming)               │
 │                 │               │            │◀───────────────────chunk─────│
 │                 │               │            │──append─────▶│ Heartbeat (30s)
 │                 │               │            │◀───────────────────chunk─────│
 │                 │               │            │◀─────────────────────done────│
 │                 │               │            │──append─────▶│ ArtifactMaterialized
 │                 │               │            │──append─────▶│ RunFinished
 │                 │               │            │──append─────▶│ TaskSucceeded
 │                 │               │            │              │              │
 │◀──完了通知─────│◀──────────────│◀───────────│              │              │
 │                 │               │            │              │              │
```

### 11.3 Phase 0 最小縦切りフロー

> **この縦切りが通れば、全コンポーネント（MCP/拡張/Core/AR/投影/状態機械/タイムアウト）が一度に検証できる。**

#### 11.3.1 最小検証パス

| ステップ | 操作 | 発行イベント | 検証ポイント |
|----------|------|--------------|--------------|
| 1 | `submit_requirement` | `RequirementProposed` | MCP → Core → AR追記 |
| 2 | Core自動処理 | `DecisionRequested` | 承認ゲート起動 |
| 3 | `approve_decision` | `DecisionApproved`, `RequirementApproved` | 承認フロー |
| 4 | Core自動処理 | `TaskProposed`, `TaskReady`, `TaskAssigned` | タスク生成・割当 |
| 5 | Core自動処理 | `RunStarted` | Run開始 |
| 6 | Core（LLM呼び出し） | `Heartbeat`（30秒ごと） | 沈黙検出の基盤 |
| 7 | Core自動処理 | `RunFinished` | Run完了 |
| 8 | Core自動処理 | `ArtifactMaterialized` | 成果物保存 |
| 9 | Core自動処理 | `TaskSucceeded` | タスク完了 |

#### 11.3.2 障害注入テスト（最小縦切りと同時に実施）

| テスト | 方法 | 期待結果 |
|--------|------|----------|
| 沈黙検出 | LLM呼び出しを意図的に遅延（91秒以上） | `RunTimedOut` → `TaskFailed` |
| 緊急停止 | `emergency_stop` 発行 | 全タスクが`Aborted`、新規タスク開始禁止 |
| 投影再構築 | `projections/` を削除して再起動 | `events/` から正常に再構築 |

#### 11.3.3 Phase 0 監視UIの最小スコープ

> **Phase 0ではVS Code拡張の3画面に絞る。因果グラフはPhase 1。**

| 画面 | 実装 | 優先度 |
|------|------|--------|
| **イベントログ** | TreeView | P0必須 |
| **タスク一覧** | TreeView | P0必須 |
| **承認キュー** | TreeView + QuickPick | P0必須 |
| ダッシュボード | Webview | P1（あれば便利） |
| 因果グラフ | Webview | P1 |
| 要求一覧 | TreeView | P1 |

---

## 12. 可観測性と監査

### 12.1 監査で答えるべき質問

- なぜこのタスクが作られたか → `parents[]` で Requirement/Decision を辿る
- なぜこのタスクが優先されたか → Constraint イベントを参照
- 何がどこで失敗したか → `TaskFailed` の `error_class` / `reason`
- どう判断して再試行/中断されたか → `Retrying` / `Aborted` イベントの根拠

### 12.2 ユーザーインターフェース

#### 12.2.1 チャットUI: GitHub Copilot Chat

| 操作 | Copilot Chat での実行例 |
|------|-------------------------|
| 要求投入 | `@hiveforge 新機能を登録: ログイン機能` |
| 状態確認 | `@hiveforge 現在のタスク状況は？` |
| 承認 | `@hiveforge decision-001 を承認して` |
| 因果追跡 | `@hiveforge task-042 はなぜ作られた？` |
| 緊急停止 | `@hiveforge 緊急停止！` |
| イベント検索 | `@hiveforge 直近の失敗イベントを見せて` |

**利点:**
- 自然言語で操作可能
- ファイル編集やターミナルと同じ画面で作業
- Copilotが適切なツールを自動選択

#### 12.2.2 監視UI: VS Code拡張（HiveForge Extension）

> **監視・可視化はVS Code拡張として実装。すべてVS Code内で完結。**

| コンポーネント | 表示形式 | 機能 |
|----------------|----------|------|
| **ダッシュボード** | Webview Panel | システム状態サマリー、タスク進捗円グラフ、直近イベント |
| **イベントログ** | TreeView (サイドバー) | イベント一覧、タイプ別フィルタ、時間範囲フィルタ |
| **要求一覧** | TreeView (サイドバー) | 要求の状態別表示、関連タスクへのナビゲーション |
| **承認キュー** | TreeView + QuickPick | 承認待ちアイテム、インライン承認/却下ボタン |
| **因果グラフ** | Webview Panel | イベント親子関係の可視化（ノード+エッジ） |
| **ステータスバー** | StatusBarItem | 🟢稼働中 / 🟡承認待ち3件 / 🔴緊急停止中 |
| **通知** | VS Code通知 | 承認要求、タスク完了、エラー発生 |

**拡張機能の画面構成:**
```
┌─────────────────────────────────────────────────────────────┐
│  [サイドバー]          │  [エディタ領域]                     │
│  ┌─────────────────┐   │  ┌─────────────────────────────┐   │
│  │ HiveForge       │   │  │ ダッシュボード (Webview)     │   │
│  │ ├─ 📋 要求      │   │  │ ┌─────┐ ┌─────┐ ┌─────┐   │   │
│  │ │  ├─ Proposed  │   │  │ │Tasks│ │Runs │ │Events│  │   │
│  │ │  ├─ Approved  │   │  │ │ 12  │ │ 5   │ │ 234 │   │   │
│  │ │  └─ ...       │   │  │ └─────┘ └─────┘ └─────┘   │   │
│  │ ├─ ✅ 承認待ち  │   │  │ [タスク進捗グラフ]          │   │
│  │ │  └─ dec-001   │   │  │ [直近イベント]              │   │
│  │ └─ 📜 イベント  │   │  └─────────────────────────────┘   │
│  │    ├─ 今日      │   │                                     │
│  │    └─ 昨日      │   │  [因果グラフ (Webview)]             │
│  └─────────────────┘   │                                     │
├─────────────────────────┴─────────────────────────────────────┤
│  [ステータスバー]  🐝 HiveForge: 🟢 稼働中 | Tasks: 3/12    │
└───────────────────────────────────────────────────────────────┘
```

**役割分担（再掲）:**
| 操作 | 推奨UI | 理由 |
|------|--------|------|
| 指示・対話 | Copilot Chat | 自然言語で柔軟に |
| 一覧確認 | 拡張TreeView | 構造化データの閲覧 |
| 詳細可視化 | 拡張Webview | グラフ・チャート表示 |
| 緊急操作 | 両方 | 冗長性確保 |

---

## 13. POC成功条件

### 13.1 定性的

- [x] Coreのみが AR に書き込む（権限分離）
- [x] 任意状態に対し「なぜ」をイベント列で説明可能
- [x] 沈黙が必ず検出・記録・停止/再試行される
- [x] EmergencyStop で全タスクが即停止する

### 13.2 定量

| 指標 | 目標 | 測定方法 |
|------|------|----------|
| 整合性破綻率 | < 1% | projection再構築失敗数 / 再構築総数 |
| 沈黙検出率 | 100% | 障害注入（強制遅延）で検出できた割合 |
| タスク完了率 | > 80% | Succeeded / Proposed |
| 承認待ちタイムアウト発動率 | 測定のみ | TimedOut / Requested |

---

## 14. ロードマップ

### Phase 0（最小核）— 本ドキュメントのスコープ

1. **MCP Server**（HiveForgeツールをCopilot Chatに公開）
2. **VS Code拡張**（ダッシュボード、イベントログ、ステータスバー）
3. Core（FastAPI + MCP統合）
4. AR（JSONL + ハッシュ連鎖 + 排他ロック）
5. 投影（同期更新）
6. 状態機械（Task/Run）
7. 沈黙検出 + 自動リトライ
8. **VS Code内で完結するデモフロー1本が動く**

### Phase 1（拡張）

- VS Code拡張の機能強化（因果グラフ可視化、通知強化）
- Copilot SDKを活用したタスク自動実行
- Webダッシュボード（可視化強化）
- Requirement/Artifact投影強化
- 複数タスク並列（競合検出）
- 外部ツール呼び出し（CLI、Git、Docker）
- **HiveForgeが別アプリを生成・デプロイする**

### Phase 2（成熟）

- リング分離（Drive/Build/Verify）
- 複数プロジェクト
- 認証・認可
- 監査エクスポート（法務対応）

---

## 付録A：イベント型一覧（POC最小）— SSOT

> **この一覧がイベント型の単一信頼源（SSOT）である。実装・スキーマ例はこの一覧に準拠すること。**

### A.1 subject正規形

> **subjectは `{entity_type}:{id}` 形式で統一する。**

| entity_type | 形式 | 例 |
|-------------|--------|-----|
| `requirement` | `requirement:{ulid}` | `requirement:01HZZ123ABC` |
| `decision` | `decision:{ulid}` | `decision:01HZZ456DEF` |
| `task` | `task:{ulid}` | `task:01HZZ789GHI` |
| `run` | `run:{ulid}` | `run:01HZZABCJKL` |
| `artifact` | `artifact:{ulid}` | `artifact:01HZZDEFMNO` |
| `constraint` | `constraint:{ulid}` | `constraint:01HZZGHIPQR` |
| `system` | `system` | `system`（システム全体） |

**注意:**
- `id` はULID形式を推奨（時系列ソート可能）
- `system` のみIDなし（システム全体を指す）
- 将来の拡張: `project:{id}`, `user:{id}` 等

### A.2 イベント型一覧

| イベント型 | subject | 説明 |
|------------|---------|------|
| `RequirementProposed` | requirement:{id} | 要求投入 |
| `RequirementAnalyzed` | requirement:{id} | 分析完了 |
| `RequirementApproved` | requirement:{id} | 承認 |
| `RequirementRejected` | requirement:{id} | 却下 |
| `RequirementImplemented` | requirement:{id} | 実装完了 |
| `DecisionRequested` | decision:{id} | 承認要求 |
| `DecisionApproved` | decision:{id} | 承認 |
| `DecisionRejected` | decision:{id} | 却下 |
| `ApprovalTimedOut` | decision:{id} | 承認タイムアウト |
| `TaskProposed` | task:{id} | タスク提案 |
| `TaskReady` | task:{id} | 準備完了 |
| `TaskAssigned` | task:{id} | 割当 |
| `TaskSucceeded` | task:{id} | 成功 |
| `TaskFailed` | task:{id} | 失敗（error_class, reason） |
| `TaskRetrying` | task:{id} | 再試行開始（transient障害後） |
| `TaskAborted` | task:{id} | 中断 |
| `TaskArchived` | task:{id} | アーカイブ（長期保存へ移行） |
| `RunStarted` | run:{id} | 実行開始 |
| `Heartbeat` | run:{id} | 生存確認 |
| `RunFinished` | run:{id} | 実行完了 |
| `RunCrashed` | run:{id} | 例外終了 |
| `RunTimedOut` | run:{id} | タイムアウト |
| `ArtifactDeclared` | artifact:{id} | 宣言 |
| `ArtifactMaterialized` | artifact:{id} | 実体保存 |
| `ArtifactValidated` | artifact:{id} | 検証OK |
| `ArtifactInvalidated` | artifact:{id} | 検証NG |
| `ArtifactCorrupted` | artifact:{id} | 破損検知 |
| `ConstraintApplied` | constraint:{id} | 制約適用 |
| `ConstraintRemoved` | constraint:{id} | 制約解除 |
| `OscillationDetected` | requirement:{id} | 振動検知 |
| `EscalationRequired` | {subject} | エスカレーション |
| `EmergencyStopIssued` | system | 緊急停止 |
| `SystemResumed` | system | 再開 |

---

## 付録B：技術スタック

| レイヤー | 選択肢 | 理由 |
|----------|--------|------|
| **チャットUI** | VS Code + GitHub Copilot Chat | 既存インフラ活用、MCP対応、自然言語操作 |
| **監視UI** | VS Code拡張 (TypeScript) | VS Code内完結、Webview/TreeView活用 |
| MCP Server | Python (FastMCP / mcp-python-sdk) | FastAPIと統合容易、型安全 |
| Core API | FastAPI (Python) | 型安全、OpenAPI自動生成、async対応 |
| AR保存 | JSONL + ファイルロック（portalocker） | シンプル、デバッグ容易、Git管理可、クロスプラットフォーム |
| 投影 | JSON ファイル | 同上 |
| ULID生成 | python-ulid | 標準的、型ヒント対応、メンテナンス継続 |
| JSON正規化 | jcs (RFC 8785) | ハッシュ計算用、標準準拠 |
| 拡張UIライブラリ | @vscode/webview-ui-toolkit | VS Code公式、一貫したUI |
| グラフ描画 | D3.js / Mermaid | 因果グラフ可視化用 |
| LLM | GitHub Copilot SDK / OpenAI API互換 | Copilot経由またはBYOK |
| コンテナ | Docker Compose | ローカル再現性 |

### B.1 VS Code拡張の技術詳細

| コンポーネント | 実装技術 |
|----------------|----------|
| TreeView（イベントログ、要求一覧） | `vscode.TreeDataProvider` |
| Webview（ダッシュボード、因果グラフ） | `vscode.WebviewPanel` + React/Svelte |
| ステータスバー | `vscode.StatusBarItem` |
| 通知 | `vscode.window.showInformationMessage` |
| Core通信 | HTTP (fetch) または WebSocket |
| 状態管理 | `vscode.Memento` (永続化) |

**拡張機能ID（予定）:** `hiveforge.hiveforge-vscode`

### B.2 GitHub Copilot SDK について

> **GitHub Copilot SDKはTechnical Preview段階。HiveForgeはMCP Serverとして実装し、Copilot Chat経由で呼び出される形を採用。**

| 方式 | 説明 | POCでの採用 |
|------|------|-------------|
| MCP Server | HiveForgeをMCP Serverとして実装、Copilot Chatから呼び出し | ✓ 採用 |
| Copilot SDK直接 | Copilot SDKをアプリに組み込んでLLM呼び出し | Phase 1で検討 |
| OpenAI API直接 | 従来型のAPI呼び出し | フォールバック用 |

**参考リンク:**
- [GitHub Copilot SDK](https://github.com/github/copilot-sdk)
- [MCP (Model Context Protocol)](https://modelcontextprotocol.io/)
- [FastMCP](https://github.com/jlowin/fastmcp)

---

## 付録C：設定ファイル例

```yaml
# hiveforge.config.yaml
hive:
  name: "poc-project"
  vault_path: "./Vault"

governance:
  max_retries: 3
  max_oscillations: 5
  max_concurrent_tasks: 10
  task_timeout_seconds: 300
  heartbeat_interval_seconds: 30
  approval_timeout_hours: 24
  archive_after_days: 7           # Succeeded/Abortedタスクのアーカイブ日数

llm:
  provider: "openai"
  model: "gpt-4o"
  api_key_env: "OPENAI_API_KEY"   # .envから読み込み
  max_tokens: 4096
  temperature: 0.2

auth:
  enabled: false                  # trueで API Key認証を有効化
  api_key_env: "HIVEFORGE_API_KEY"

server:
  host: "0.0.0.0"
  port: 8000

logging:
  events_max_file_size_mb: 100    # 単一JSONLファイルの上限
```

---

## 付録D：Quick Start

### D.1 前提条件

- **VS Code** + **GitHub Copilot拡張機能**（推奨）
- **GitHub Copilotサブスクリプション**（Free/Pro/Business）
- Python 3.11以上
- Docker（オプション）

### D.2 ローカルセットアップ

```bash
# 1. リポジトリをクローン
git clone https://github.com/your-org/hiveforge.git
cd hiveforge

# 2. Python仮想環境を作成・有効化
python -m venv .venv
# Windows:
.venv\Scripts\activate
# macOS/Linux:
source .venv/bin/activate

# 3. 依存パッケージをインストール
pip install -r requirements.txt

# 4. 環境変数を設定
cp .env.example .env
# .env を編集（Copilot使用時はOPENAI_API_KEY不要）

# 5. Vaultディレクトリを初期化
python -m hiveforge init

# 6. MCP Server + APIサーバーを起動
python -m hiveforge serve
# → MCP Server: stdio モード（Copilotから自動接続）
# → REST API: http://localhost:8000
```

### D.3 VS Code MCP設定

**`.vscode/settings.json` に追加:**
```json
{
  "mcp": {
    "servers": {
      "hiveforge": {
        "type": "stdio",
        "command": "python",
        "args": ["-m", "hiveforge.mcp_server"],
        "cwd": "${workspaceFolder}",
        "env": {
          "HIVEFORGE_VAULT_PATH": "${workspaceFolder}/Vault"
        }
      }
    }
  }
}
```

### D.4 Copilot Chatで動作確認

VS CodeでCopilot Chatを開き、以下を試す:

```
User: @hiveforge システムの状態を教えて

Copilot: HiveForgeシステムの状態を確認します。
         
         ステータス: 正常稼働中
         - 実行中タスク: 0件
         - 待機中タスク: 0件
         - 承認待ち: 0件
         
         システムは準備完了です。新しい要求を投入できます。

User: @hiveforge 新しい要求を登録: Hello Worldアプリを作成

Copilot: submit_requirement ツールで要求を登録しました。
         
         要求ID: req-001
         タイトル: Hello Worldアプリを作成
         ステータス: Proposed
         
         分析を開始しますか？
```

### D.5 Dockerセットアップ

```bash
# 1. 環境変数を設定
cp .env.example .env
# .env を編集

# 2. Docker Composeで起動
docker-compose up -d

# → REST API: http://localhost:8000
# → MCP (HTTP): http://localhost:8000/mcp/
```

**Docker使用時のMCP設定（HTTP モード）:**
```json
{
  "mcp": {
    "servers": {
      "hiveforge": {
        "type": "http",
        "url": "http://localhost:8000/mcp/"
      }
    }
  }
}
```

### D.6 REST APIでの動作確認（Copilot非使用時）

```bash
# ヘルスチェック
curl http://localhost:8000/api/health

# 要求を投入（例）
curl -X POST http://localhost:8000/api/requirements \
  -H "Content-Type: application/json" \
  -d '{"title": "Hello World", "description": "最初のテスト要求"}'
```

---

## 付録E：投影スキーマ

> **Phase 0の投影は「一覧に必要なキー」に絞る。詳細はイベントを辿る。**

### E.1 requirements.json

```json
{
  "req-001": {
    "id": "req-001",
    "title": "ユーザー認証機能",
    "status": "Approved",
    "created_at": "2026-01-31T10:00:00Z",
    "last_event_id": "01HZZ..."
  }
}
```

| フィールド | 型 | 説明 |
|------------|-----|------|
| `id` | string | ULID |
| `title` | string | 要求タイトル |
| `status` | enum | Proposed/Analyzed/Approved/Rejected/Implemented/Verified |
| `created_at` | timestamp | RequirementProposedのtimestamp |
| `last_event_id` | string | 最後に状態を変えたイベントID |

### E.2 decisions.json

```json
{
  "dec-001": {
    "id": "dec-001",
    "kind": "requirement_approval",
    "target": "requirement:req-001",
    "summary": "ユーザー認証機能の実装を承認するか？",
    "status": "Requested",
    "requested_at": "2026-01-31T10:05:00Z",
    "last_event_id": "01HZZ..."
  }
}
```

| フィールド | 型 | 説明 |
|------------|-----|------|
| `id` | string | ULID |
| `kind` | enum | requirement_approval/destructive_operation/constraint_change |
| `target` | string | 対象subject（`requirement:{id}` 等） |
| `summary` | string | 承認画面に表示する要約 |
| `status` | enum | Draft/Requested/Approved/Rejected/Superseded |
| `requested_at` | timestamp | DecisionRequestedのtimestamp |
| `last_event_id` | string | 最後に状態を変えたイベントID |

### E.3 tasks.json

```json
{
  "task-001": {
    "id": "task-001",
    "requirement_id": "req-001",
    "title": "APIエンドポイント設計",
    "status": "Running",
    "retry_count": 0,
    "last_run_id": "run-001",
    "created_at": "2026-01-31T10:10:00Z",
    "last_event_id": "01HZZ..."
  }
}
```

| フィールド | 型 | 説明 |
|------------|-----|------|
| `id` | string | ULID |
| `requirement_id` | string | 親 RequirementのID |
| `title` | string | タスク概要 |
| `status` | enum | Proposed/Ready/Assigned/Running/Succeeded/Failed/Retrying/Aborted/Archived |
| `retry_count` | int | 再試行回数 |
| `last_run_id` | string | 最新RunのID |
| `created_at` | timestamp | TaskProposedのtimestamp |
| `last_event_id` | string | 最後に状態を変えたイベントID |

### E.4 runs.json

```json
{
  "run-001": {
    "id": "run-001",
    "task_id": "task-001",
    "status": "Running",
    "started_at": "2026-01-31T10:10:05Z",
    "last_heartbeat_at": "2026-01-31T10:10:35Z",
    "finished_at": null,
    "last_event_id": "01HZZ..."
  }
}
```

| フィールド | 型 | 説明 |
|------------|-----|------|
| `id` | string | ULID |
| `task_id` | string | 親 TaskのID |
| `status` | enum | Started/Running/Finished/Crashed/TimedOut |
| `started_at` | timestamp | RunStartedのtimestamp |
| `last_heartbeat_at` | timestamp | 最新Heartbeatのtimestamp |
| `finished_at` | timestamp | 終了時刻（null=実行中） |
| `last_event_id` | string | 最後に状態を変えたイベントID |

### E.5 artifacts.json

```json
{
  "artifact-001": {
    "id": "artifact-001",
    "kind": "code",
    "status": "Validated",
    "sha256": "abc123...",
    "size_bytes": 4096,
    "path": "Vault/Artifacts/artifact-001/content.py",
    "created_at": "2026-01-31T10:15:00Z",
    "last_event_id": "01HZZ..."
  }
}
```

| フィールド | 型 | 説明 |
|------------|-----|------|
| `id` | string | ULID |
| `kind` | enum | code/text/binary/prompt/response |
| `status` | enum | Declared/Materialized/Validated/Invalidated/Corrupted |
| `sha256` | string | コンテンツのハッシュ |
| `size_bytes` | int | ファイルサイズ |
| `path` | string | 実体ファイルのパス |
| `created_at` | timestamp | ArtifactDeclaredのtimestamp |
| `last_event_id` | string | 最後に状態を変えたイベントID |

---

## 付録F：状態遷移対応表

> **「どのイベントでどの状態になるか」の対応表。実装時の参照用。**

### F.1 Requirement

| イベント | before | after | 備考 |
|----------|--------|-------|------|
| `RequirementProposed` | - | Proposed | 要求作成 |
| `RequirementAnalyzed` | Proposed | Analyzed | 分析完了 |
| `RequirementApproved` | Analyzed, Blocked | Approved | 承認 |
| `RequirementRejected` | Analyzed | Rejected | 却下 |
| `RequirementImplemented` | Approved | Implemented | 実装完了 |
| `OscillationDetected` | Implemented | Blocked | 振動検知（人間介入待ち） |

**Blockedからの復帰:** 人間が問題を解決後、新しいDecisionを作成し承認することでApprovedへ戻る。

### F.2 Decision

| イベント | before | after |
|----------|--------|-------|
| `DecisionRequested` | Draft | Requested |
| `DecisionApproved` | Requested | Approved |
| `DecisionRejected` | Requested | Rejected |
| `ApprovalTimedOut` | Requested | Rejected or Escalated |

### F.3 Task

| イベント | before | after | 備考 |
|----------|--------|-------|------|
| `TaskProposed` | - | Proposed | タスク作成 |
| `TaskReady` | Proposed | Ready | 依存解決済み |
| `TaskAssigned` | Ready, Retrying | Assigned | Coreが割当 |
| `RunStarted`（Taskに連動） | Assigned | Running | Run開始 |
| `TaskSucceeded` | Running | Succeeded | 成功 |
| `TaskFailed` | Running | Failed | 失敗 |
| `TaskRetrying` | Failed | Retrying | transient障害で再試行 |
| `TaskAborted` | * | Aborted | 永久障害または上限超過 |
| `TaskArchived` | Succeeded/Aborted | Archived | 長期保存へ |
| `EmergencyStopIssued` | Running | Aborted | 緊急停止 |

**Retrying遷移フロー:** `Failed` → `TaskRetrying` → `Retrying` → `TaskAssigned` → `Assigned` → `RunStarted` → `Running`

### F.4 Run

| イベント | before | after | 備考 |
|----------|--------|-------|------|
| `RunStarted` | - | Running | Runエンティティ作成、即座にRunning |
| `Heartbeat` | Running | Running | 最終Heartbeat時刻を更新 |
| `RunFinished` | Running | Finished | 正常完了 |
| `RunCrashed` | Running | Crashed | 例外終了 |
| `RunTimedOut` | Running | TimedOut | 沈黙検出（Heartbeat途絶） |

### F.5 Artifact

| イベント | before | after |
|----------|--------|-------|
| `ArtifactDeclared` | - | Declared |
| `ArtifactMaterialized` | Declared | Materialized |
| `ArtifactValidated` | Materialized | Validated |
| `ArtifactInvalidated` | Materialized | Invalidated |
| `ArtifactCorrupted` | Validated | Corrupted |
```
