# HiveForge v5 — Multi-Agent Collaborative Development System

> **ビジョン**: Web会議のように複数の専門家エージェントとリアルタイムに対話し、
> チーム開発の体験でソフトウェアを組み立てる

作成日: 2026-02-01

---

## 0. v4からの継続性

### v4で達成したこと（基盤）

| 機能 | 状態 | v5での活用 |
|------|------|-----------|
| Akashic Record (AR) | ✅ 安定 | 全エージェントのイベント永続化基盤 |
| Run/Task状態機械 | ✅ 安定 | Colony内のワークフロー管理に拡張 |
| 因果リンク (Lineage) | ✅ 安定 | エージェント間の依存追跡に拡張 |
| MCP Server | ✅ 安定 | Worker Beeのツール基盤 |
| VS Code拡張 | ✅ 安定 | Conference View等の土台 |
| 確認要請 (Requirement) | ✅ 安定 | 委任レベル付き承認フローに拡張 |

### v5の位置づけ

```
v4 (POC完了)          v5 (マルチエージェント)
    │                        │
    │  単一エージェント        │  複数エージェント協調
    │  ユーザー↔Copilot       │  ユーザー↔Beekeeper↔Colony群
    │  1 Run = 1作業          │  1 Colony = N Run（専門領域）
    │                        │
    └────────────────────────┘
           既存基盤を拡張
```

---

## 1. コンセプト概要

### 1.1 メタファー: 養蜂場（Hive）としての開発チーム

```
┌─────────────────────────────────────────────────────────────────┐
│                         Hive (プロジェクト)                       │
│  ┌─────────────┐                                                │
│  │   ユーザー    │◄─── 音声/テキスト/スケッチ ───►               │
│  └──────┬──────┘                                                │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Beekeeper（養蜂家 / ファシリテーター）         │   │
│  │  - ユーザーとの主対話                                      │   │
│  │  - 大局的コンテキスト管理                                   │   │
│  │  - Colony間の調整・優先順位付け                            │   │
│  │  - 最終判断の提示・委任管理                                │   │
│  └──────────────────────┬──────────────────────────────────┘   │
│                         │                                       │
│         ┌───────────────┼───────────────┐                       │
│         ▼               ▼               ▼                       │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐               │
│  │Colony:UI/UX│  │Colony: API │  │Colony:Infra│  ...         │
│  │  Queen Bee │  │  Queen Bee │  │  Queen Bee │               │
│  │  (調停)    │  │  (調停)    │  │  (調停)    │               │
│  │ ┌─────────┐│  │┌─────────┐ │  │┌─────────┐ │               │
│  │ │Worker A ││  ││Worker D │ │  ││Worker G │ │               │
│  │ │(Design) ││  ││(Backend)│ │  ││(Docker) │ │               │
│  │ └─────────┘│  │└─────────┘ │  │└─────────┘ │               │
│  │ ┌─────────┐│  │┌─────────┐ │  │┌─────────┐ │               │
│  │ │Worker B ││  ││Worker E │ │  ││Worker H │ │               │
│  │ │(A11y)   ││  ││(DB)     │ │  ││(K8s)    │ │               │
│  │ └─────────┘│  │└─────────┘ │  │└─────────┘ │               │
│  └────────────┘  └────────────┘  └────────────┘               │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 用語体系

| 用語 | 英語 | 説明 |
|------|------|------|
| Hive | Hive | プロジェクト全体の環境。複数のColonyを含む |
| Beekeeper | Beekeeper | ユーザーとの対話窓口。Colony間の調整役 |
| Colony | Colony | 専門領域のエージェント群れ（UI/UX, API等） |
| Queen Bee | Queen Bee | Colonyの調停エージェント。1つのColonyに1体 |
| Worker Bee | Worker Bee | 実務を行うエージェント。専門スキルを持つ |

### 1.3 核心的な価値観

1. **開発の意思決定の中心は人間**
   - エージェントは提案・実行するが、重要な判断はユーザーが行う
   - ただし「信頼できるエージェント」には判断を委任できる

2. **チーム開発の体験**
   - 一人で全部やるのではなく、専門家チームと相談しながら進める
   - 各専門家の視点からのフィードバックが自然に集まる

3. **スピード感と試行錯誤**
   - 音声・スケッチ・リアルタイム生成で素早くイテレーション
   - 「完璧な仕様」より「動くプロトタイプ」を素早く

---

## 2. エージェント階層構造

### 2.1 Beekeeper（養蜂家エージェント）

**役割**: ファシリテーター、プロジェクト統括

- ユーザーからの入力（音声/テキスト/スケッチ）を受け取る
- 全体コンテキスト（プロジェクトの目標、制約、履歴）を保持
- 各Colonyへの「意見要求」を作成・配信
- Colonyからの報告を統合し、ユーザーに分かりやすく提示
- 判断の委任レベルを管理

**技術的実現**:
- 大規模コンテキストを扱えるLLM（Claude, GPT-4等）
- HiveForgeのRunを統括するメタレイヤー
- ユーザーとの対話履歴・決定履歴をARに記録

### 2.2 Queen Bee（Colony調停エージェント）

**役割**: 専門領域の代表、チームリーダー

- Beekeeperから「意見要求」を受け取る
- 自Colonyに関係する情報を分析・抽出
- 配下のWorker Beeに詳細タスクを振り分け
- Worker Beeの意見を整理・統合してBeekeeperに報告
- 情報不足時は追加情報を要請

**技術的実現**:
- 各Colonyは独立したRunとして管理可能
- Colony間の依存関係はLineage（因果リンク）で追跡
- Queen Beeは「要約・統合」に特化したプロンプト

### 2.3 Worker Bee（専門家エージェント）

**役割**: 実務担当、専門知識の提供

- Queen Beeからタスクを受け取る
- Web調査、コード生成、設計提案など実務を実行
- 成果物と根拠をQueen Beeに報告

**技術的実現**:
- MCPツールを活用（Web検索、ファイル操作、コード実行等）
- Worker Beeごとに異なるシステムプロンプト/ツールセット
- 軽量なLLMでも可（タスクが限定的なため）

---

## 3. Colony（専門領域）の例

Web開発プロジェクトの場合:

| Colony名 | 専門領域 | Worker Beeの例 |
|----------|----------|---------------|
| UI/UX | フロントエンド、デザイン | デザイナー、アクセシビリティ、アニメーション |
| API | バックエンド、API設計 | REST設計、認証、パフォーマンス |
| Data | データベース、データモデル | スキーマ設計、マイグレーション、クエリ最適化 |
| Infra | インフラ、DevOps | Docker、CI/CD、監視 |
| QA | テスト、品質保証 | ユニットテスト、E2E、セキュリティ |
| PM | 進捗管理、リスク管理 | スケジュール、依存関係、リソース |

---

## 4. 対話フロー例

### 4.1 要求定義フェーズ

```
ユーザー: 「ECサイトを作りたい。商品一覧と購入機能が必要」

Beekeeper: 「ECサイトですね。いくつか確認させてください。
             各Colonyに意見を求めます...」

[同時並行で各Colonyが分析]

UI/UX Queen: 「商品一覧のレイアウト、カート、決済フローについて
              Workerと相談しました。モバイルファーストで進めますか？」

API Queen: 「決済は外部サービス（Stripe等）を使う想定ですか？
            認証方式はどうしますか？」

Data Queen: 「商品情報のスキーマ案を作成しました。
             在庫管理も必要ですか？」

Beekeeper: 「各Colonyからの確認事項をまとめました:
            1. モバイルファースト設計でよいか
            2. 決済サービスの選定
            3. 在庫管理の要否
            優先度の高い順にお答えください」

ユーザー: 「モバイルファーストでOK。決済はStripe。在庫管理は後でいい」

Beekeeper: 「了解しました。各Colonyに伝達し、詳細設計に入ります」
```

### 4.2 ビジュアル検討フェーズ

```
ユーザー: [tldrawでラフなワイヤーフレームを描く]
         「こんな感じのレイアウトで」

Beekeeper: 「ラフを受け取りました。UI/UX Colonyに詳細化を依頼します」

UI/UX Queen: 
  Design Worker: [ラフを元にFigma風のモックアップを生成]
  A11y Worker: 「コントラスト比とフォントサイズの改善提案があります」

Beekeeper: 「3つのデザイン案を生成しました:
            A: オリジナルに忠実
            B: アクセシビリティ改善版
            C: モダンUI適用版
            [プレビュー表示]」

ユーザー: [B案を指差して] 「Bベースで、ここの色だけAと同じにして」

Beekeeper: 「修正を反映します...」 [リアルタイムで更新]
```

---

## 5. 技術アーキテクチャ

### 5.1 全体構成

```
┌────────────────────────────────────────────────────────────────┐
│                      VS Code Extension                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Conference   │  │ Canvas       │  │ Dashboard    │         │
│  │ View         │  │ (tldraw)     │  │ View         │         │
│  │ (チャット)    │  │ (スケッチ)    │  │ (進捗)       │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
│         │                 │                 │                  │
│         └─────────────────┼─────────────────┘                  │
│                           ▼                                    │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │                  Beekeeper Coordinator                    │ │
│  │  - WebSocket / LSP で各Colonyと通信                       │ │
│  │  - 音声認識 (Whisper) / 音声合成 (TTS)                    │ │
│  └──────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────────┐
│                     HiveForge Core (API)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │ Colony:  │  │ Colony:  │  │ Colony:  │  │ Colony:  │      │
│  │ UI/UX    │  │ API      │  │ Data     │  │ Infra    │      │
│  │ (Run)    │  │ (Run)    │  │ (Run)    │  │ (Run)    │      │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘      │
│                              │                                 │
│                              ▼                                 │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │                   Akashic Record (AR)                     │ │
│  │  - 全イベント永続化                                        │ │
│  │  - Colony間のLineage追跡                                  │ │
│  └──────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
```

### 5.2 新規コンポーネント

| コンポーネント | 説明 | 技術候補 |
|--------------|------|---------|
| Conference View | Web会議風のチャットUI | VS Code Webview + React |
| Canvas View | tldraw風スケッチ | tldraw React component |
| Voice I/O | 音声入力/読み上げ | Whisper API + Web Speech API |
| Image Generation | ラフ→ビジュアル生成 | Stable Diffusion / DALL-E |
| Colony Coordinator | 複数Colony間の調整 | 新規API層 |

### 5.3 拡張すべき既存機能

| 機能 | 現状 | v5での拡張 |
|-----|------|-----------|
| Run | 単一エージェントの作業単位 | Colony（複数エージェント）の単位に |
| Task | 単一タスク | サブタスク階層、Colony間依存 |
| Lineage | イベント間の因果 | Colony間の因果リンク |
| Requirement | 確認要請 | 委任レベル付き（自動承認可） |

---

## 6. 委任レベル（Trust Level）

エージェントへの判断委任を制御する仕組み:

| レベル | 名称 | 説明 |
|-------|------|------|
| 0 | 報告のみ | 全ての判断をユーザーに確認 |
| 1 | 提案＋確認 | 提案するが実行前に確認（デフォルト） |
| 2 | 自動＋通知 | 自動実行するが結果を通知 |
| 3 | 完全委任 | 自動実行、問題時のみ通知 |

- Colony単位で委任レベルを設定可能
- Worker Bee単位でも設定可能（例: テスト実行は完全委任、DB変更は確認必須）
- 委任履歴はARに記録し、後で監査可能

---

## 7. 実現に向けたフェーズ分け

> **原則**: 各フェーズで「動くもの」を作り、フィードバックを得てから次へ進む

### Phase 0: 設計検証（1週間）

**目標**: Hive概念とエージェント間通信の設計を固める

タスク:
- [ ] Hive/Run/Taskの関係をER図で整理
- [ ] エージェント間メッセージ型を定義（TypeScript/Python両方）
- [ ] 最小ユースケースのシーケンス図作成
- [ ] 既存ARスキーマへの影響調査

**成功基準 (DoD)**:
- [ ] 設計ドキュメントがレビュー済み
- [ ] 破壊的変更がないことを確認
- [ ] Phase 1のタスクがIssue化済み

**成果物**: `docs/design/v5-hive-design.md`

---

### Phase 1: 単一Colony動作（2週間）

**目標**: 1つのColonyがQueen Bee経由でタスクを実行できる

タスク:
- [ ] `ColonyStartedEvent`, `ColonyCompletedEvent` イベント型追加
- [ ] Colony状態機械の実装（IDLE → ACTIVE → COMPLETED）
- [ ] Queen BeeのMCPツール実装（`create_colony`, `query_colony`）
- [ ] VS Code拡張にColony TreeView追加

**成功基準 (DoD)**:
- [ ] `pytest` でColony関連テストが全パス
- [ ] MCPで `create_colony` → タスク作成 → 完了 のフローが動作
- [ ] VS Code拡張でColonyとその配下Runが表示される

**最小動作ユースケース**:
```
ユーザー: "UI/UX Colonyを作成して、ログイン画面のワイヤーフレームを検討して"
システム: 
  1. UI/UX Colony作成
  2. Queen Beeがタスク「ワイヤーフレーム検討」を作成
  3. （この段階ではシングルエージェント=Copilotが実行）
  4. 結果をColony経由で報告
```

---

### Phase 2: Beekeeper + マルチColony（3週間）

**目標**: Beekeeperが複数Colonyを束ねて1つの問題に取り組める

タスク:
- [ ] Beekeeperエージェントのプロンプト設計
- [ ] Beekeeper → Queen Beeへの「意見要求」メッセージ型
- [ ] Queen Bee → Beekeeperへの「報告」メッセージ型
- [ ] 複数Colonyへの同時ブロードキャスト機能
- [ ] Conference View（チャットUI）のプロトタイプ

**成功基準 (DoD)**:
- [ ] 3つのColony（UI/UX, API, Data）が同時に稼働
- [ ] Beekeeperからの質問に各Colonyが回答を返す
- [ ] Conference ViewでBeekeeperと3 Colonyの対話が表示される

**最小動作ユースケース**:
```
ユーザー: "ECサイトを作りたい"
Beekeeper: [3 Colonyに意見要求を送信]
UI/UX Queen: "モバイルファースト？商品一覧のレイアウトは？"
API Queen: "決済はStripe？認証方式は？"
Data Queen: "商品スキーマ案を作成。在庫管理は必要？"
Beekeeper: [3つの質問を統合してユーザーに提示]
```

---

### Phase 3: リッチ入力（2週間）

**目標**: 音声とスケッチで対話できる

タスク:
- [ ] 音声入力（Whisper API）統合
- [ ] 音声読み上げ（Web Speech API / TTS）統合
- [ ] Canvas View（tldraw React component）統合
- [ ] スケッチ → テキスト説明変換（VLM活用）

**成功基準 (DoD)**:
- [ ] マイクボタンで音声入力 → テキスト化 → 養蜂家に送信
- [ ] 養蜂家の回答が読み上げられる
- [ ] tldrawで描いた図がVLMで解釈される

---

### Phase 4: ビジュアル生成（3週間）

**目標**: ラフスケッチからUIデザイン候補を生成

タスク:
- [ ] 画像生成API統合（Stable Diffusion / DALL-E）
- [ ] ラフ → UI候補の生成パイプライン
- [ ] 候補選択 → 修正指示 → 再生成のフロー
- [ ] 生成物のAR記録・因果リンク

**成功基準 (DoD)**:
- [ ] tldrawのラフから3つのデザイン案が生成される
- [ ] ユーザーが選択・修正指示できる
- [ ] 生成履歴がARに記録され、Lineageで追跡可能

---

### Phase 5: 委任システム（2週間）

**目標**: 信頼できるエージェントに判断を委任できる

タスク:
- [ ] 委任レベルモデルの実装（Hive/専門家単位）
- [ ] 自動承認フローの実装
- [ ] 委任履歴の監査UI
- [ ] 異常検知 → エスカレーション機能

**成功基準 (DoD)**:
- [ ] QA Colonyに「テスト実行」を完全委任できる
- [ ] Data Colonyの「スキーマ変更」は必ず確認が必要
- [ ] 委任履歴がダッシュボードで確認できる

---

### Phase 6: 会議参加Bot（4週間）

**目標**: Beekeeperがビデオ会議に参加し、リアルタイムで開発支援

> **経営層へのインパクト**: 顧客との打ち合わせに「AI開発アシスタント」が同席し、
> 技術的な質問に即答、決定事項を自動記録、議事録生成。開発効率と顧客対応の両立。

**対応プラットフォーム**:

| プラットフォーム | 技術 | 備考 |
|----------------|------|------|
| Microsoft Teams | Azure Bot Service + Graph API | 企業向け最有力 |
| Zoom | Zoom Meeting SDK + Bot API | 幅広い利用 |
| Google Meet | Google Meet API (限定公開) | Google Workspace連携 |
| Slack Huddles | Slack API | 開発チーム向け |
| Discord | Discord Bot API | OSS/ゲーム開発 |

**アーキテクチャ**:

```
┌─────────────────────────────────────────────────────────────────┐
│                    ビデオ会議プラットフォーム                     │
│         (Teams / Zoom / Google Meet / Slack / Discord)          │
│                                                                 │
│  [参加者A] [参加者B] [参加者C]  [🐝 Beekeeper Bot]               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼ 音声ストリーム / チャット
┌─────────────────────────────────────────────────────────────────┐
│                 Meeting Adapter Layer                           │
│                                                                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │ Teams    │ │ Zoom     │ │ Meet     │ │ Slack    │  ...     │
│  │ Adapter  │ │ Adapter  │ │ Adapter  │ │ Adapter  │          │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘          │
│                              │                                  │
│                              ▼                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │           Unified Meeting Interface                       │  │
│  │  - transcribe() : 音声→テキスト                          │  │
│  │  - speak() : テキスト→音声（任意）                        │  │
│  │  - sendChat() : チャット送信                              │  │
│  │  - onMessage() : メッセージ受信                           │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Beekeeper Meeting Agent                      │
│                                                                 │
│  機能:                                                          │
│  - 会議内容のリアルタイム理解                                    │
│  - 技術仕様・過去の決定事項への即答                              │
│  - 決定事項をHiveForgeに自動記録                                │
│  - 議事録の自動生成                                             │
│  - アクションアイテム → Task自動登録                            │
│  - Colony群への情報共有                                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    HiveForge Core                               │
│                                                                 │
│  新規イベント:                                                   │
│  - MEETING_STARTED: 会議開始                                    │
│  - MEETING_TRANSCRIPT: 発言記録                                 │
│  - MEETING_DECISION: 会議中の決定事項                           │
│  - MEETING_ACTION_ITEM: アクションアイテム抽出                   │
│  - MEETING_ENDED: 会議終了（議事録生成）                         │
└─────────────────────────────────────────────────────────────────┘
```

**ユースケース例**:

```
【Zoom会議中 - 顧客との要件定義】

顧客: 「ログイン画面は2段階認証が必須ですか？」

🐝 Beekeeper: 「過去の決定（Decision #42）では『初期リリースは
              パスワードのみ、Phase 2で2FA追加』となっています。
              変更が必要であれば、この場で決定を更新できます」

PM: 「じゃあ初期から2FAにしよう」

🐝 Beekeeper: 「了解しました。決定事項として記録します。
              - 変更: 初期リリースから2FA必須
              - 影響範囲: UI/UX Colony, API Colony
              - 見積もり影響: +2日（概算）
              
              議事録に追記しました。各Colonyに通知しますか？」

開発者: 「お願い」

🐝 Beekeeper: 「通知しました。UI/UX Queenから10分以内に
              デザイン影響の報告が届く予定です」

【会議終了後】
- 議事録が自動生成され、参加者にメール送信
- 決定事項がARに記録（Lineage付き）
- アクションアイテムがTaskとして各Colonyに登録
```

タスク:
- [ ] Meeting Adapter Layer設計
- [ ] 最初のAdapter実装（Teams or Zoom）
- [ ] 音声認識統合（Whisper / Azure Speech）
- [ ] 議事録生成パイプライン
- [ ] 決定事項抽出・AR記録
- [ ] アクションアイテム → Task変換

**成功基準 (DoD)**:
- [ ] 1つ以上のプラットフォームでBot参加が動作
- [ ] 会議中の質問にリアルタイムで回答できる
- [ ] 会議終了後に議事録が自動生成される
- [ ] 決定事項・アクションアイテムがHiveForgeに記録される

**想定コスト（月額）**:
- 音声認識: $50-200（会議時間による）
- LLM API: $100-500（会議数による）
- プラットフォームライセンス: 組織による

---

### Phase 7: Requirements Discovery System（4週間）

**目標**: 要求の「発見」と「トレーサビリティ」を支援するシステム

> **核心的価値**: 忖度しないBotが「聞きにくい質問」を代わりに聞き、
> 暗黙の前提・本音・深層ニーズを引き出す。人間関係を壊さずに情報収集。

**背景哲学**:
```
顧客が言うこと ≠ 顧客が欲しいもの ≠ 顧客が本当に必要なもの

要求には3層ある:
- 明示的要求: 言葉で言ったこと
- 暗黙的要求: 当然だと思って言わないこと
- 潜在的要求: 本人も気づいていないニーズ
```

**Discovery Tree構造**:

```
📌 背景 (Context) ──────────────────────────────────────────
│
├─ 👤 ステークホルダー
│   ├─ ✅ 担当者: 山田さん（課長、決定権あり）
│   ├─ ⚠️ 上長の意向 [要確認]
│   ├─ ❓ エンドユーザーの声 [未収集]
│   └─ ❓ 経営層の期待 [未確認]
│
├─ 🏢 組織・制約
│   ├─ ✅ 予算: 500万円（概算）
│   ├─ ⚠️ 期限: 6月末 [バッファ不明]
│   ├─ ❓ 社内政治・力関係 [未把握]
│   └─ ❓ 過去の類似案件の失敗経験 [未確認]
│
├─ 📊 現行業務
│   ├─ ✅ 業務フロー: 発注→入荷→検品→棚入れ
│   ├─ ⚠️ 例外処理 [一部不明]
│   ├─ ❓ 担当者の本音・不満 [未収集]
│   └─ ❓ 非公式な回避策 [未把握]
│
└─ 🎯 価値観・優先度
    ├─ ⚠️ 品質 vs スピード vs コスト [要確認]
    ├─ ❓ 本当に解決したい課題 [深掘り必要]
    └─ ❓ 成功の定義 [未合意]

📋 業務課題 (Problems) ──────────────────────────────────────
│
├─ ✅ 在庫数の不整合 → 派生要求: リアルタイム同期
├─ ⚠️ 発注タイミング遅れ [根本原因未特定]
└─ ❓ [潜在] 属人化リスク [未認識の可能性]

🎯 要求 (Requirements) ──────────────────────────────────────
│
├─ ✅ 在庫をリアルタイムで把握したい
│   ├─ 要件: ダッシュボード
│   └─ 要件: モバイル対応
├─ ⚠️ 発注を自動化したい [条件未確認]
└─ ❓ [暗黙] ログイン・権限管理

📝 要件 → 🔧 機能 → 📱 画面/API
```

**忖度しないBot質問例**:

```
【予算・期限系】
🐝 「予算の上限と、これ以上は絶対無理というラインを教えてください」
🐝 「6月末は『絶対死守』ですか？それとも交渉の余地はありますか？」
🐝 「予算オーバーした場合、機能削減と期限延長のどちらが現実的ですか？」

【組織・政治系】
🐝 「この件、最終的に誰がOKを出せば進められますか？」
🐝 「反対しそうな人や部署はありますか？」
🐝 「以前、似たプロジェクトが頓挫したことはありますか？理由は？」

【本音系】
🐝 「正直なところ、今のシステムで一番イライラするのは何ですか？」
🐝 「もし魔法で何でも実現できるとしたら、何を最初に解決しますか？」
🐝 「このプロジェクト、本当に必要だと思いますか？（率直に）」

【深掘り系】
🐝 「『使いやすく』とは具体的にどういう状態ですか？」
🐝 「『なるべく早く』は、今日中？今週中？今月中？」
🐝 「それ、本当にシステムで解決すべき問題ですか？運用で回避できません？」
```

**自動収集される背景情報**:

| 情報カテゴリ | 収集方法 | 例 |
|------------|---------|-----|
| ステークホルダー | 会議参加者、メール宛先 | 決定権者、影響力のある人 |
| 組織構造 | 会話中の言及、名刺情報 | 部署関係、承認フロー |
| 制約条件 | 明示的質問、会話から抽出 | 予算、期限、技術制約 |
| 優先度 | 発言頻度、感情分析 | 本当に気にしていること |
| 懸念事項 | ネガティブ発言の分析 | リスク、過去の失敗 |
| 暗黙の前提 | 省略された主語/目的語 | 「当然こうだよね」 |

**チェックリスト機能**:

```
┌─────────────────────────────────────────────────────────────────┐
│ 📋 要件定義チェックリスト（Webシステム共通）                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 【ユーザー・認証】                                               │
│ ☑ 利用者の種類は明確か                                          │
│ ☐ 権限レベルは定義されているか                                   │
│ ☐ 認証方式は決まっているか（ID/PW, SSO, 2FA）                    │
│ ☐ パスワードポリシーは確認したか                                 │
│                                                                 │
│ 【データ・保存】                                                 │
│ ☑ 管理するデータ項目は洗い出したか                               │
│ ☐ データ保存期間は確認したか                                     │
│ ☐ 削除要件は確認したか（論理削除/物理削除）                      │
│ ☐ 個人情報の取り扱いは確認したか                                 │
│                                                                 │
│ 【業務フロー】                                                   │
│ ☑ 正常系フローは確認したか                                       │
│ ☐ 例外・エラー時の対応は確認したか                               │
│ ☐ 承認フローは確認したか                                         │
│ ☐ 取消・修正のルールは確認したか                                 │
│                                                                 │
│ 【非機能】                                                       │
│ ☐ 同時接続数の想定は確認したか                                   │
│ ☐ レスポンス要件は確認したか                                     │
│ ☐ 可用性要件は確認したか（24/365？営業時間？）                   │
│ ☐ バックアップ・DR要件は確認したか                               │
│                                                                 │
│ 進捗: ████░░░░░░ 40% (8/20項目)                                 │
│                                                                 │
│ [未確認項目を質問リストに追加] [次の会議で確認]                  │
└─────────────────────────────────────────────────────────────────┘
```

タスク:
- [ ] Discovery Tree データモデル設計
- [ ] 背景→課題→要求→要件→機能のトレーサビリティ
- [ ] 状態管理（✅確定/⚠️要確認/❓未着手/❌却下）
- [ ] 案件横断チェックリストテンプレート
- [ ] 会話からの自動情報抽出
- [ ] 「忖度しない質問」生成エンジン
- [ ] VS Code拡張でのTree表示

**成功基準 (DoD)**:
- [ ] Discovery TreeがVS Codeで表示・編集できる
- [ ] 会議Bot（Phase 6）から自動で情報が収集される
- [ ] 未確認項目から質問リストが自動生成される
- [ ] 任意のノードから上流/下流へのトレースが可能

### 8.1 メッセージ型定義

エージェント間の通信は以下のメッセージ型で行う:

```typescript
// Beekeeper → Queen Bee
interface OpinionRequest {
  id: string;                    // リクエストID
  from: "beekeeper";
  to: string;                    // Colony ID
  context: string;               // ユーザーからの要求・背景
  question: string;              // 具体的な質問
  deadline?: string;             // 回答期限（ISO8601）
  priority: "low" | "normal" | "high" | "urgent";
}

// Queen Bee → Beekeeper
interface OpinionResponse {
  id: string;                    // レスポンスID
  request_id: string;            // 対応するリクエストID
  from: string;                  // Colony ID
  to: "beekeeper";
  summary: string;               // 回答要約
  details?: string;              // 詳細説明
  questions?: string[];          // 追加質問（あれば）
  confidence: number;            // 確信度 (0.0-1.0)
  sources?: string[];            // 根拠となるイベントID
}

// Queen Bee → Worker Bee
interface TaskAssignment {
  id: string;
  from: string;                  // Colony ID
  to: string;                    // Worker Bee ID
  task_type: string;             // "research" | "generate" | "review" | ...
  instruction: string;           // 具体的な指示
  context: string;               // 背景情報
  tools_allowed: string[];       // 使用可能なMCPツール
}

// Worker Bee → Queen Bee
interface TaskResult {
  id: string;
  assignment_id: string;
  from: string;                  // Worker Bee ID
  to: string;                    // Colony ID
  status: "completed" | "failed" | "needs_input";
  result?: string;               // 成果物（テキスト）
  artifacts?: ArtifactRef[];     // 成果物（ファイル等）
  error?: string;                // エラー時
  questions?: string[];          // 追加情報が必要な場合
}
```

### 8.2 通信フロー

```
ユーザー入力
    │
    ▼
┌──────────┐ OpinionRequest   ┌─────────────┐
│Beekeeper │ ───────────────► │ Queen(UI/UX)│
│          │                  │             │
│          │ OpinionRequest   │ TaskAssign  │
│          │ ───────────────► ─┼────────────►│ Worker A
│          │                  │             │◄────────── TaskResult
│          │ OpinionRequest   │             │
│          │ ───────────────► ─┼────────────►│ Worker B
└──────────┘                  └─────────────┘◄────────── TaskResult
    ▲                               │
    │       OpinionResponse         │
    └───────────────────────────────┘
```

---

## 9. リスクと対策

| リスク | 影響 | 対策 | 検知方法 |
|-------|------|------|---------|
| LLMコスト増大 | 複数エージェント=API呼び出し増 | 軽量LLM活用、キャッシュ、要約で圧縮 | 月次コスト監視 |
| レイテンシ | 複数エージェント=応答遅延 | 並列実行、ストリーミング、プログレス表示 | P95レイテンシ計測 |
| コンテキスト分断 | Colony間で情報が共有されない | Beekeeperによる統合、共有コンテキスト層 | ユーザーフィードバック |
| 複雑性 | システムが複雑すぎて使えない | 段階的リリース、シンプルなデフォルト | ユーザビリティテスト |
| 既存機能の破壊 | v4機能が動かなくなる | 後方互換性テスト、Feature Flag | 既存テストの継続実行 |

---

## 10. コスト見積もり（概算）

### 開発工数

| Phase | 期間 | 主な作業 |
|-------|------|---------|
| Phase 0 | 1週間 | 設計、ドキュメント |
| Phase 1 | 2週間 | Colony基盤、単一Colony動作 |
| Phase 2 | 3週間 | Beekeeper、マルチColony、Conference View |
| Phase 3 | 2週間 | 音声I/O、Canvas |
| Phase 4 | 3週間 | 画像生成、リアルタイム修正 |
| Phase 5 | 2週間 | 委任システム |
| Phase 6 | 4週間 | 会議参加Bot（Teams/Zoom/Meet対応） |
| Phase 7 | 4週間 | Requirements Discovery System |
| **合計** | **約21週間** | |

### LLMコスト（1日あたり概算）

| シナリオ | 想定 | 月額概算 |
|---------|------|---------|
| 開発・テスト | 10回/日 × 3 Colony | $30-50 |
| 軽い利用 | 50回/日 × 3 Colony | $100-200 |
| 本格利用 | 200回/日 × 5 Colony | $500-1000 |
| 会議Bot込み | 上記 + 週5回会議 | +$200-400 |
| Discovery込み | 上記 + 自動抽出 | +$50-100 |

※Claude/GPT-4レベル想定。軽量LLM活用で大幅削減可能

---

## 11. 実装の第一歩（Phase 0）

最初の一歩として、**設計検証**から始める:

### Phase 0 の成果物

1. **Hive設計ドキュメント** (`docs/design/v5-hive-design.md`)
   - Hive / Run / Task のER図
   - Hive状態機械の定義
   - イベント型一覧

2. **メッセージ型定義** 
   - TypeScript: `vscode-extension/src/types/hive.ts`
   - Python: `src/hiveforge/core/hive.py`

3. **シーケンス図**
   - 単一Hive動作フロー
   - マルチHive協調フロー

4. **既存実装への影響調査**
   - ARスキーマの拡張箇所
   - API追加エンドポイント
   - VS Code拡張の変更箇所

### やらないこと（Phase 0では）

- 実装（コード変更）
- 音声入力/読み上げ
- Canvas/スケッチ
- 画像生成

---

## 12. 次のアクション

1. [x] このドキュメントをレビュー・改善
2. [x] Phase 0 の設計ドキュメント作成開始
3. [x] Hive/Run/Taskの関係をER図で整理
4. [x] 最小ユースケースのシーケンス図作成
5. [ ] 設計ドキュメントのレビュー・承認
6. [ ] Phase 1のタスクをIssue化

---

## 付録A: 用語集（v5）

| 用語 | 定義 |
|-----|------|
| Hive | プロジェクト全体を表す最上位概念。複数のColonyを含む |
| Beekeeper（養蜂家） | ファシリテーターエージェント、ユーザーとの主対話を担当 |
| Colony（群れ） | 専門領域を担当するエージェント群の単位（UI/UX, API等） |
| Queen Bee（女王蜂） | Colonyの代表・調停エージェント。Worker Beeを束ねる |
| Worker Bee（働き蜂） | 実務を担当する個別エージェント。専門スキルを持つ |
| Trust Level（委任レベル） | エージェントへの判断委任の度合い |
| Conference（会議） | BeekeeperとColony群が同時に対話するセッション |
| OpinionRequest | BeekeeperからQueen Beeへの意見要求メッセージ |
| OpinionResponse | Queen BeeからBeekeeperへの回答メッセージ |

---

## 付録B: v4→v5 の概念対応

| v4の概念 | v5での位置づけ | 変更点 |
|---------|---------------|--------|
| Run | Colony内の作業単位（変更なし） | Colonyに所属するようになる |
| Task | Run内のタスク（変更なし） | サブタスク階層を追加予定 |
| Requirement | 確認要請（変更なし） | 委任レベルを追加 |
| Decision | 確認要請の解決結果（変更なし） | 変更なし |
| Lineage | 因果リンク | Colony間リンクを追加 |
| AR | イベント永続化 | Hive/Colonyイベントを追加 |
| MCP Server | ツール提供 | Colony操作ツールを追加 |

---

## 付録C: 参考リンク

- [v4仕様書](コンセプト_v4.md)
- [v3仕様書](コンセプト_v3.md)
- [アーキテクチャ](ARCHITECTURE.md)
- [クイックスタート](QUICKSTART.md)
- [tldraw](https://tldraw.com/) - スケッチツール
- [Whisper](https://openai.com/research/whisper) - 音声認識
