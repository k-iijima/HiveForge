# ColonyForge v5 — Multi-Agent Collaborative Development System

> **ビジョン**: Web会議のように複数の専門家エージェントとリアルタイムに対話し、
> チーム開発の体験でソフトウェアを組み立てる

> **本書の役割**: 「なぜ」を説明するドキュメント。設計思想・ビジョン・ユースケースを記述。
> 状態機械・イベント型・プロトコルの正式定義は [v5-hive-design.md](design/v5-hive-design.md) を参照。

作成日: 2026-02-01
フィードバック対応:
  - v5.1 (2026-02-01): Decision Protocol, Project Contract, Action Class, Conflict Detection
  - v5.2 (2026-02-01): Conference エンティティ, Decision scope/owner, Conflict category/severity, Policy Gate, UnknownEvent前方互換
  - v5.3 (2026-02-07): Sentinel Hornet（Hive内監視エージェント）追加

---

## 0. v4からの継続性

### v4で達成したこと（基盤）

| 機能 | 状態 | v5での活用 |
|------|------|-----------|
| Akashic Record (AR) | ✅ 安定 | 全エージェントのイベント永続化基盤 |
| Run/Task状態機械 | ✅ 安定 | Colony内のワークフロー管理に拡張 |
| 因果リンク (Lineage) | ✅ 安定 | エージェント間の依存追跡に拡張 |
| MCP Server | ✅ 安定 | Worker Beeのツール基盤 |
| VS Code拡張 | ✅ 安定 | Conference View等の土台 |
| 確認要請 (Requirement) | ✅ 安定 | 委任レベル付き承認フローに拡張 |

### v5の位置づけ

```
v4 (POC完了)          v5 (マルチエージェント)
    │                        │
    │  単一エージェント        │  複数エージェント協調
    │  ユーザー↔Copilot       │  ユーザー↔Beekeeper↔Hive群
    │  1 Run = 1作業          │  1 Hive = N Colony（専門領域）
    │                        │
    └────────────────────────┘
           既存基盤を拡張
```

---

## 1. コンセプト概要

### 1.1 メタファー: 養蜂場（Hive）としての開発チーム

```
┌─────────────────────────────────────────────────────────────────┐
│   ユーザー ◄─── 音声/テキスト/スケッチ ───►                      │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Beekeeper（養蜂家 / ファシリテーター）         │   │
│  │  - ユーザーとの主対話                                      │   │
│  │  - 複数Hiveの統括管理                                      │   │
│  │  - Hive間の調整・優先順位付け                              │   │
│  │  - 最終判断の提示・委任管理                                │   │
│  └──────────────────────┬──────────────────────────────────┘   │
│                         │                                       │
│         ┌───────────────┼───────────────┐                       │
│         ▼               ▼               ▼                       │
│  ┌────────────────────────────────────────────────────────────┐│
│  │                     Hive A (プロジェクトA)                  ││
│  │                                                            ││
│  │  ┌──────────────────────────────────────────────────────┐  ││
│  │  │  🐝 Sentinel Hornet（監視エージェント）               │  ││
│  │  │  - 全Colonyの行動・状態を常時監視                    │  ││
│  │  │  - 暴走/ループ/コスト超過/セキュリティ侵害を検出     │  ││
│  │  │  - Colonyの強制停止 → Beekeeperへ報告               │  ││
│  │  └──────────────────────────────────────────────────────┘  ││
│  │                                                            ││
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐           ││
│  │  │Colony:UI/UX│  │Colony: API │  │Colony:Infra│  ...      ││
│  │  │  Queen Bee │  │  Queen Bee │  │  Queen Bee │           ││
│  │  │  (調停)    │  │  (調停)    │  │  (調停)    │           ││
│  │  │ ┌─────────┐│  │┌─────────┐ │  │┌─────────┐ │           ││
│  │  │ │Worker A ││  ││Worker D │ │  ││Worker G │ │           ││
│  │  │ │(Design) ││  ││(Backend)│ │  ││(Docker) │ │           ││
│  │  │ └─────────┘│  │└─────────┘ │  │└─────────┘ │           ││
│  │  └────────────┘  └────────────┘  └────────────┘           ││
│  └────────────────────────────────────────────────────────────┘│
│  ┌────────────────────────────────────────────────────────────┐│
│  │                     Hive B (プロジェクトB)                  ││
│  │  ┌────────────┐  ┌────────────┐                            ││
│  │  │Colony:Data │  │Colony:ML   │  ...                       ││
│  │  │  Queen Bee │  │  Queen Bee │                            ││
│  │  └────────────┘  └────────────┘                            ││
│  └────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 用語体系

| 用語 | 英語 | 説明 |
|------|------|------|
| Beekeeper | Beekeeper | Hiveの外にいる統括者。複数のHiveを管理し、ユーザーとの対話窓口となる |
| Hive | Hive | 1つのプロジェクト環境。複数のColonyを含む |
| Colony | Colony | 専門領域のエージェント群れ（UI/UX, API等） |
| Sentinel Hornet | Sentinel Hornet | Hive内の監視エージェント。全Colony/エージェントの行動を監視し、異常時に強制停止・報告 |
| Queen Bee | Queen Bee | Colonyの調停エージェント。1つのColonyに1体 |
| Worker Bee | Worker Bee | 実務を行うエージェント。専門スキルを持つ |

### 1.3 核心的な価値観

1. **開発の意思決定の中心は人間**
   - エージェントは提案・実行するが、重要な判断はユーザーが行う
   - ただし「信頼できるエージェント」には判断を委任できる

2. **チーム開発の体験**
   - 一人で全部やるのではなく、専門家チームと相談しながら進める
   - 各専門家の視点からのフィードバックが自然に集まる

3. **スピード感と試行錯誤**
   - 音声・スケッチ・リアルタイム生成で素早くイテレーション
   - 「完璧な仕様」より「動くプロトタイプ」を素早く

---

## 2. エージェント階層構造

### 2.1 Beekeeper（養蜂家エージェント）

**役割**: 複数Hiveの統括者、ファシリテーター

- **Hiveの外に存在**し、複数のHiveを横断的に管理
- ユーザーからの入力（音声/テキスト/スケッチ）を受け取る
- 全体コンテキスト（複数プロジェクトの目標、制約、履歴）を保持
- 適切なHiveへタスクを振り分け、Hive間の調整を行う
- 各Hive内のQueen Beeからの報告を統合し、ユーザーに提示
- 判断の委任レベルを管理

**技術的実現**:
- 大規模コンテキストを扱えるLLM（Claude, GPT-4等）
- 複数HiveのRunを統括するメタレイヤー
- ユーザーとの対話履歴・決定履歴をARに記録

### 2.2 Sentinel Hornet（Hive内監視エージェント）

**役割**: Hive内の全Colony・全エージェントの行動監視と異常検出・強制停止

- **1つのHiveに1体**存在し、全Colonyを横断的に監視
- エージェントの行動ログ・イベントストリームをリアルタイムに分析
- 異常を検出した場合、該当Colonyを強制停止（`colony.suspended`）し、Beekeeperに報告
- Beekeeperとは独立して動作し、Beekeeperからの指示なしに停止判断を下せる
- 停止判断の根拠は全てARに記録され、監査可能

**監視対象と検出パターン**: 無限ループ、暴走、コスト超過、セキュリティ侵害、沈黙、リソース枯渇

> 検出パターンの詳細・強制停止フロー・イベント型は [v5-hive-design.md](design/v5-hive-design.md) §3.1 を参照。

**強制停止フロー**: 異常検出 → `sentinel.alert_raised` イベント発行 → Colonyを `colony.suspended` に遷移 → Beekeeperに `sentinel.report` 送信

> イベント型・payloadの詳細は [v5-hive-design.md §3.1](design/v5-hive-design.md) を参照。
    │
    ├─► 該当Colonyを colony.suspended に遷移
    │     - 全進行中タスクを一時停止
    │     - 新規タスク受付を停止
    │
    └─► Beekeeperに sentinel.report 送信
          - 何が起きたか
          - なぜ停止したか（根拠）
          - 推奨アクション（再開 / 調査 / 破棄）
```

**Beekeeperとの関係**:
- Sentinel HornetはBeekeeperとは独立した権限で停止を実行できる（安全弁）
- Beekeeperは報告を受けて、再開（`colony.activated`）または完全停止（`colony.failed`）を判断
- 停止閾値はBeekeeper経由でユーザーが調整可能（`colonyforge.config.yaml`）

**技術的実現**:
- ActivityBus / ARのイベントストリームを購読し、リアルタイムに異常パターンを検出
- 既存のSilence Detector (`silence.py`) を統合・拡張
- Action Class / Trust Level のポリシー違反チェック
- 設定ベースの閾値（ループ回数、コスト上限、レート制限等）

### 2.3 Queen Bee（Colony調停エージェント）

**役割**: 専門領域の代表、チームリーダー

- Beekeeperから「意見要求」を受け取る
- 自Colonyに関係する情報を分析・抽出
- 配下のWorker Beeに詳細タスクを振り分け
- Worker Beeの意見を整理・統合してBeekeeperに報告
- 情報不足時は追加情報を要請

**技術的実現**:
- 各Colonyは独立したRunとして管理可能
- Colony間の依存関係はLineage（因果リンク）で追跡
- Queen Beeは「要約・統合」に特化したプロンプト

### 2.4 Worker Bee（専門家エージェント）

**役割**: 実務担当、専門知識の提供

- Queen Beeからタスクを受け取る
- Web調査、コード生成、設計提案など実務を実行
- 成果物と根拠をQueen Beeに報告

**技術的実現**:
- MCPツールを活用（Web検索、ファイル操作、コード実行等）
- Worker Beeごとに異なるシステムプロンプト/ツールセット
- 軽量なLLMでも可（タスクが限定的なため）

---

## 3. Colony（専門領域）の例

Web開発プロジェクトの場合:

| Colony名 | 専門領域 | Worker Beeの例 |
|----------|----------|---------------|
| UI/UX | フロントエンド、デザイン | デザイナー、アクセシビリティ、アニメーション |
| API | バックエンド、API設計 | REST設計、認証、パフォーマンス |
| Data | データベース、データモデル | スキーマ設計、マイグレーション、クエリ最適化 |
| Infra | インフラ、DevOps | Docker、CI/CD、監視 |
| QA | テスト、品質保証 | ユニットテスト、E2E、セキュリティ |
| PM | 進捗管理、リスク管理 | スケジュール、依存関係、リソース |

---

## 4. 対話フロー例

### 4.1 要求定義フェーズ

```
ユーザー: 「ECサイトを作りたい。商品一覧と購入機能が必要」

Beekeeper: 「ECサイトですね。いくつか確認させてください。
             各Colonyに意見を求めます...」

[同時並行で各Colonyが分析]

UI/UX Queen: 「商品一覧のレイアウト、カート、決済フローについて
              Workerと相談しました。モバイルファーストで進めますか？」

API Queen: 「決済は外部サービス（Stripe等）を使う想定ですか？
            認証方式はどうしますか？」

Data Queen: 「商品情報のスキーマ案を作成しました。
             在庫管理も必要ですか？」

Beekeeper: 「各Colonyからの確認事項をまとめました:
            1. モバイルファースト設計でよいか
            2. 決済サービスの選定
            3. 在庫管理の要否
            優先度の高い順にお答えください」

ユーザー: 「モバイルファーストでOK。決済はStripe。在庫管理は後でいい」

Beekeeper: 「了解しました。各Colonyに伝達し、詳細設計に入ります」
```

### 4.2 ビジュアル検討フェーズ

```
ユーザー: [tldrawでラフなワイヤーフレームを描く]
         「こんな感じのレイアウトで」

Beekeeper: 「ラフを受け取りました。UI/UX Colonyに詳細化を依頼します」

UI/UX Queen:
  Design Worker: [ラフを元にFigma風のモックアップを生成]
  A11y Worker: 「コントラスト比とフォントサイズの改善提案があります」

Beekeeper: 「3つのデザイン案を生成しました:
            A: オリジナルに忠実
            B: アクセシビリティ改善版
            C: モダンUI適用版
            [プレビュー表示]」

ユーザー: [B案を指差して] 「Bベースで、ここの色だけAと同じにして」

Beekeeper: 「修正を反映します...」 [リアルタイムで更新]
```

---

## 5. 技術アーキテクチャ

### 5.1 全体構成

```
┌────────────────────────────────────────────────────────────────┐
│                      VS Code Extension                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Conference   │  │ Canvas       │  │ Dashboard    │         │
│  │ View         │  │ (tldraw)     │  │ View         │         │
│  │ (チャット)    │  │ (スケッチ)    │  │ (進捗)       │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
│         │                 │                 │                  │
│         └─────────────────┼─────────────────┘                  │
│                           ▼                                    │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │                  Beekeeper Coordinator                    │ │
│  │  - WebSocket / LSP で各Colonyと通信                       │ │
│  │  - 音声認識 (Whisper) / 音声合成 (TTS)                    │ │
│  └──────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────────┐
│                     ColonyForge Core (API)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │ Colony:  │  │ Colony:  │  │ Colony:  │  │ Colony:  │      │
│  │ UI/UX    │  │ API      │  │ Data     │  │ Infra    │      │
│  │ (Run)    │  │ (Run)    │  │ (Run)    │  │ (Run)    │      │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘      │
│                              │                                 │
│                              ▼                                 │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │                   Akashic Record (AR)                     │ │
│  │  - 全イベント永続化                                        │ │
│  │  - Colony間のLineage追跡                                  │ │
│  └──────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
```

### 5.2 新規コンポーネント

| コンポーネント | 説明 | 技術候補 |
|--------------|------|---------|
| Conference View | Web会議風のチャットUI | VS Code Webview + React |
| Canvas View | tldraw風スケッチ | tldraw React component |
| Voice I/O | 音声入力/読み上げ | Whisper API + Web Speech API |
| Image Generation | ラフ→ビジュアル生成 | Stable Diffusion / DALL-E |
| Colony Coordinator | 複数Colony間の調整 | 新規API層 |

### 5.3 拡張すべき既存機能

| 機能 | 現状 | v5での拡張 |
|-----|------|-----------|
| Run | 単一エージェントの作業単位 | Colony（複数エージェント）の単位に |
| Task | 単一タスク | サブタスク階層、Colony間依存 |
| Lineage | イベント間の因果 | Colony間の因果リンク |
| Requirement | 確認要請 | 委任レベル付き（自動承認可） |

---

## 6. 委任レベル（Trust Level）と操作分類（Action Class）

### 6.1 委任レベル（Trust Level）

エージェントへの判断委任を制御する仕組み:

| レベル | 名称 | 説明 |
|-------|------|------|
| 0 | 報告のみ | 全ての判断をユーザーに確認 |
| 1 | 提案＋確認 | 提案するが実行前に確認（デフォルト） |
| 2 | 自動＋通知 | 自動実行するが結果を通知 |
| 3 | 完全委任 | 自動実行、問題時のみ通知 |

- Colony単位で委任レベルを設定可能
- Worker Bee単位でも設定可能（例: テスト実行は完全委任、DB変更は確認必須）
- 委任履歴はARに記録し、後で監査可能

### 6.2 操作分類（Action Class）

全ての操作を**リスクレベル**で分類し、Trust Levelと連携:

| Action Class | 説明 | 例 | Trust Level制約 |
|-------------|------|-----|----------------|
| **Read-only** | 読み取り専用、副作用なし | ファイル参照、検索、分析 | Level 0-3 全て許可 |
| **Reversible** | 元に戻せる操作 | ファイル編集（Git管理）、テスト実行 | Level 1以上で自動可 |
| **Irreversible** | 元に戻せない/高リスク操作 | 本番DB変更、外部API課金、公開 | Level 3でも確認推奨 |

**Action Classの自動判定ルール**: ツール名とパラメータから自動分類。判定はPolicy Gateで中央集権的に実行。

**Trust Level × Action Class マトリクス**:

| | Read-only | Reversible | Irreversible |
|---|:---:|:---:|:---:|
| **Level 0** | ✅ 自動 | ❌ 確認必須 | ❌ 確認必須 |
| **Level 1** | ✅ 自動 | ❌ 確認必須 | ❌ 確認必須 |
| **Level 2** | ✅ 自動 | ✅ 自動+通知 | ❌ 確認必須 |
| **Level 3** | ✅ 自動 | ✅ 自動 | ⚠️ 確認推奨（設定可）|

> 判定ロジック・設定カスタマイズの詳細は [v5-hive-design.md §9.5 Policy Gate](design/v5-hive-design.md) を参照。

---

## 7. 実現ロードマップ（ビジョン）

> **⚠️ 注**: 実装計画・タスク管理は [DEVELOPMENT_PLAN_v1.md](DEVELOPMENT_PLAN_v1.md) の**マイルストーンベース計画（M1〜M4）** に移行済みです。
> 以下は**ビジョンとしての段階的発展構想**であり、実装タスクの管理には使用しません。

> **原則**: 各段階で「動くもの」を作り、フィードバックを得てから次へ進む

### Phase 0: 設計検証 ✅ 完了

**目標**: Hive概念とエージェント間通信の設計を固める

成果物: `docs/design/v5-hive-design.md`

---

### Phase 1: 単一Colony動作

**目標**: 1つのColonyがQueen Bee経由でタスクを実行できる

**最小動作ユースケース**:
```
ユーザー: "UI/UX Colonyを作成して、ログイン画面のワイヤーフレームを検討して"
システム:
  1. UI/UX Colony作成
  2. Queen Beeがタスク「ワイヤーフレーム検討」を作成
  3. （この段階ではシングルエージェント=Copilotが実行）
  4. 結果をColony経由で報告
```

---

### Phase 2: Beekeeper + マルチColony

**目標**: Beekeeperが複数Colonyを束ねて1つの問題に取り組める

**最小動作ユースケース**:
```
ユーザー: "ECサイトを作りたい"
Beekeeper: [3 Colonyに意見要求を送信]
UI/UX Queen: "モバイルファースト？商品一覧のレイアウトは？"
API Queen: "決済はStripe？認証方式は？"
Data Queen: "商品スキーマ案を作成。在庫管理は必要？"
Beekeeper: [3つの質問を統合してユーザーに提示]
```

---

### Phase 3: リッチ入力

**目標**: 音声とスケッチで対話できる（Whisper API、tldraw、VLM連携）

---

### Phase 4: ビジュアル生成

**目標**: ラフスケッチからUIデザイン候補を生成（Stable Diffusion / DALL-E連携）

---

### Phase 5: 委任システム

**目標**: 信頼できるエージェントに判断を委任できる（Trust Level × Action Class の実運用）

---

### Phase 6: 会議参加Bot

> ⚠️ **ゲート条件**: Phase 6開始前に以下が安定稼働していること:
> - Decision Protocol（決定ログ）が正常に記録・参照可能
> - Conflict Detection による調停フローが動作
> - メトリクス基盤（基本的なテレメトリ）が導入済み

**目標**: Beekeeperがビデオ会議に参加し、リアルタイムで開発支援

> **経営層へのインパクト**: 顧客との打ち合わせに「AI開発アシスタント」が同席し、
> 技術的な質問に即答、決定事項を自動記録、議事録生成。開発効率と顧客対応の両立。

**対応プラットフォーム**:

| プラットフォーム | 技術 | 備考 |
|----------------|------|------|
| Microsoft Teams | Azure Bot Service + Graph API | 企業向け最有力 |
| Zoom | Zoom Meeting SDK + Bot API | 幅広い利用 |
| Google Meet | Google Meet API (限定公開) | Google Workspace連携 |
| Slack Huddles | Slack API | 開発チーム向け |
| Discord | Discord Bot API | OSS/ゲーム開発 |

**アーキテクチャ**:

```
┌─────────────────────────────────────────────────────────────────┐
│                    ビデオ会議プラットフォーム                     │
│         (Teams / Zoom / Google Meet / Slack / Discord)          │
│                                                                 │
│  [参加者A] [参加者B] [参加者C]  [🐝 Beekeeper Bot]               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼ 音声ストリーム / チャット
┌─────────────────────────────────────────────────────────────────┐
│                 Meeting Adapter Layer                           │
│                                                                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │ Teams    │ │ Zoom     │ │ Meet     │ │ Slack    │  ...     │
│  │ Adapter  │ │ Adapter  │ │ Adapter  │ │ Adapter  │          │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘          │
│                              │                                  │
│                              ▼                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │           Unified Meeting Interface                       │  │
│  │  - transcribe() : 音声→テキスト                          │  │
│  │  - speak() : テキスト→音声（任意）                        │  │
│  │  - sendChat() : チャット送信                              │  │
│  │  - onMessage() : メッセージ受信                           │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Beekeeper Meeting Agent                      │
│                                                                 │
│  機能:                                                          │
│  - 会議内容のリアルタイム理解                                    │
│  - 技術仕様・過去の決定事項への即答                              │
│  - 決定事項をColonyForgeに自動記録                                │
│  - 議事録の自動生成                                             │
│  - アクションアイテム → Task自動登録                            │
│  - Colony群への情報共有                                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ColonyForge Core                               │
│                                                                 │
│  新規イベント:                                                   │
│  - MEETING_STARTED: 会議開始                                    │
│  - MEETING_TRANSCRIPT: 発言記録                                 │
│  - MEETING_DECISION: 会議中の決定事項                           │
│  - MEETING_ACTION_ITEM: アクションアイテム抽出                   │
│  - MEETING_ENDED: 会議終了（議事録生成）                         │
└─────────────────────────────────────────────────────────────────┘
```

**ユースケース例**:

```
【Zoom会議中 - 顧客との要件定義】

顧客: 「ログイン画面は2段階認証が必須ですか？」

🐝 Beekeeper: 「過去の決定（Decision #42）では『初期リリースは
              パスワードのみ、Phase 2で2FA追加』となっています。
              変更が必要であれば、この場で決定を更新できます」

PM: 「じゃあ初期から2FAにしよう」

🐝 Beekeeper: 「了解しました。決定事項として記録します。
              - 変更: 初期リリースから2FA必須
              - 影響範囲: UI/UX Colony, API Colony
              - 見積もり影響: +2日（概算）

              議事録に追記しました。各Colonyに通知しますか？」

開発者: 「お願い」

🐝 Beekeeper: 「通知しました。UI/UX Queenから10分以内に
              デザイン影響の報告が届く予定です」

【会議終了後】
- 議事録が自動生成され、参加者にメール送信
- 決定事項がARに記録（Lineage付き）
- アクションアイテムがTaskとして各Colonyに登録
```

---

### Phase 7: Requirements Discovery System

> ⚠️ **ゲート条件**: Phase 7開始前に以下が安定稼働していること:
> - Phase 6（会議Bot）が少なくとも1プラットフォームで動作
> - Project Contract スキーマが実運用でテスト済み
> - Discovery Tree データモデルの設計レビュー完了

**目標**: 要求の「発見」と「トレーサビリティ」を支援するシステム

> **核心的価値**: 忖度しないBotが「聞きにくい質問」を代わりに聞き、
> 暗黙の前提・本音・深層ニーズを引き出す。人間関係を壊さずに情報収集。

**背景哲学**:
```
顧客が言うこと ≠ 顧客が欲しいもの ≠ 顧客が本当に必要なもの

要求には3層ある:
- 明示的要求: 言葉で言ったこと
- 暗黙的要求: 当然だと思って言わないこと
- 潜在的要求: 本人も気づいていないニーズ
```

**Discovery Tree構造**:

```
📌 背景 (Context) ──────────────────────────────────────────
│
├─ 👤 ステークホルダー
│   ├─ ✅ 担当者: 山田さん（課長、決定権あり）
│   ├─ ⚠️ 上長の意向 [要確認]
│   ├─ ❓ エンドユーザーの声 [未収集]
│   └─ ❓ 経営層の期待 [未確認]
│
├─ 🏢 組織・制約
│   ├─ ✅ 予算: 500万円（概算）
│   ├─ ⚠️ 期限: 6月末 [バッファ不明]
│   ├─ ❓ 社内政治・力関係 [未把握]
│   └─ ❓ 過去の類似案件の失敗経験 [未確認]
│
├─ 📊 現行業務
│   ├─ ✅ 業務フロー: 発注→入荷→検品→棚入れ
│   ├─ ⚠️ 例外処理 [一部不明]
│   ├─ ❓ 担当者の本音・不満 [未収集]
│   └─ ❓ 非公式な回避策 [未把握]
│
└─ 🎯 価値観・優先度
    ├─ ⚠️ 品質 vs スピード vs コスト [要確認]
    ├─ ❓ 本当に解決したい課題 [深掘り必要]
    └─ ❓ 成功の定義 [未合意]

📋 業務課題 (Problems) ──────────────────────────────────────
│
├─ ✅ 在庫数の不整合 → 派生要求: リアルタイム同期
├─ ⚠️ 発注タイミング遅れ [根本原因未特定]
└─ ❓ [潜在] 属人化リスク [未認識の可能性]

🎯 要求 (Requirements) ──────────────────────────────────────
│
├─ ✅ 在庫をリアルタイムで把握したい
│   ├─ 要件: ダッシュボード
│   └─ 要件: モバイル対応
├─ ⚠️ 発注を自動化したい [条件未確認]
└─ ❓ [暗黙] ログイン・権限管理

📝 要件 → 🔧 機能 → 📱 画面/API
```

**忖度しないBot質問例**:

```
【予算・期限系】
🐝 「予算の上限と、これ以上は絶対無理というラインを教えてください」
🐝 「6月末は『絶対死守』ですか？それとも交渉の余地はありますか？」
🐝 「予算オーバーした場合、機能削減と期限延長のどちらが現実的ですか？」

【組織・政治系】
🐝 「この件、最終的に誰がOKを出せば進められますか？」
🐝 「反対しそうな人や部署はありますか？」
🐝 「以前、似たプロジェクトが頓挫したことはありますか？理由は？」

【本音系】
🐝 「正直なところ、今のシステムで一番イライラするのは何ですか？」
🐝 「もし魔法で何でも実現できるとしたら、何を最初に解決しますか？」
🐝 「このプロジェクト、本当に必要だと思いますか？（率直に）」

【深掘り系】
🐝 「『使いやすく』とは具体的にどういう状態ですか？」
🐝 「『なるべく早く』は、今日中？今週中？今月中？」
🐝 「それ、本当にシステムで解決すべき問題ですか？運用で回避できません？」
```

**自動収集される背景情報**:

| 情報カテゴリ | 収集方法 | 例 |
|------------|---------|-----|
| ステークホルダー | 会議参加者、メール宛先 | 決定権者、影響力のある人 |
| 組織構造 | 会話中の言及、名刺情報 | 部署関係、承認フロー |
| 制約条件 | 明示的質問、会話から抽出 | 予算、期限、技術制約 |
| 優先度 | 発言頻度、感情分析 | 本当に気にしていること |
| 懸念事項 | ネガティブ発言の分析 | リスク、過去の失敗 |
| 暗黙の前提 | 省略された主語/目的語 | 「当然こうだよね」 |

**チェックリスト機能**:

```
┌─────────────────────────────────────────────────────────────────┐
│ 📋 要件定義チェックリスト（Webシステム共通）                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 【ユーザー・認証】                                               │
│ ☑ 利用者の種類は明確か                                          │
│ ☐ 権限レベルは定義されているか                                   │
│ ☐ 認証方式は決まっているか（ID/PW, SSO, 2FA）                    │
│ ☐ パスワードポリシーは確認したか                                 │
│                                                                 │
│ 【データ・保存】                                                 │
│ ☑ 管理するデータ項目は洗い出したか                               │
│ ☐ データ保存期間は確認したか                                     │
│ ☐ 削除要件は確認したか（論理削除/物理削除）                      │
│ ☐ 個人情報の取り扱いは確認したか                                 │
│                                                                 │
│ 【業務フロー】                                                   │
│ ☑ 正常系フローは確認したか                                       │
│ ☐ 例外・エラー時の対応は確認したか                               │
│ ☐ 承認フローは確認したか                                         │
│ ☐ 取消・修正のルールは確認したか                                 │
│                                                                 │
│ 【非機能】                                                       │
│ ☐ 同時接続数の想定は確認したか                                   │
│ ☐ レスポンス要件は確認したか                                     │
│ ☐ 可用性要件は確認したか（24/365？営業時間？）                   │
│ ☐ バックアップ・DR要件は確認したか                               │
│                                                                 │
│ 進捗: ████░░░░░░ 40% (8/20項目)                                 │
│                                                                 │
│ [未確認項目を質問リストに追加] [次の会議で確認]                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. メッセージ型と通信プロトコル

### 8.1 メッセージ型定義

エージェント間の通信は以下のメッセージ型で行う:

```typescript
// ============================================
// Project Contract（構造化コンテキスト）
// ============================================

/** 構造化されたプロジェクトコンテキスト */
interface ProjectContract {
  goals: string[];           // 達成すべき目標
  constraints: string[];     // 守るべき制約
  non_goals: string[];       // スコープ外（やらないこと）
  decisions: DecisionRef[];  // 決定済み事項への参照
  open_questions: string[];  // 未解決の質問
}

interface DecisionRef {
  id: string;                // 決定ID
  summary: string;           // 決定内容の要約
  decided_at: string;        // 決定日時（ISO8601）
}

// ============================================
// Decision Protocol（意思決定ライフサイクル）
// ============================================

/** 提案 */
interface Proposal {
  id: string;
  proposer: string;          // 提案者（Colony ID or "user"）
  title: string;
  description: string;
  options?: string[];        // 選択肢（あれば）
  context: ProjectContract;  // 提案時のコンテキスト
  created_at: string;
}

/** 決定（v5.2拡張: 所有者・適用範囲・ロールバック追加） */
interface Decision {
  id: string;
  proposal_id: string;
  decided_by: string;        // 決定者（"user" or "beekeeper"）
  choice: string;            // 選択された内容
  rationale?: string;        // 決定理由
  decided_at: string;

  // v5.2追加: 所有者と適用範囲
  hive_id: string;                      // 必須
  conference_id?: string;               // 会議中の決定の場合
  scope: "hive" | "colony" | "run" | "task";  // 適用範囲
  scope_id: string;                     // scope対象のID
  recorded_by: "user" | "beekeeper" | `queen:${string}`;  // 誰が記録したか
  supersedes_decision_id?: string;      // 上書き元の決定ID

  // v5.2追加: 影響分析・ロールバック
  impact?: {
    affected_colonies: string[];
    estimated_effort_hours?: number;
    risk_level?: "low" | "medium" | "high";
  };
  rollback_plan?: string;               // ロールバック計画
}

/** 決定状態 */
type DecisionStatus =
  | "proposed"      // 提案中
  | "recorded"      // 決定記録済
  | "applied"       // 適用済み
  | "superseded";   // 新しい決定で上書き

// ============================================
// Conflict Detection（衝突検出、v5.2拡張: カテゴリ・深刻度追加）
// ============================================

/** 衝突カテゴリ（v5.2追加） */
type ConflictCategory =
  | "assumption"     // 前提条件の不一致
  | "priority"       // 優先順位の衝突
  | "dependency"     // 依存関係の矛盾
  | "constraint";    // 制約条件の対立

/** 衝突深刻度（v5.2追加） */
type ConflictSeverity =
  | "low"            // 軽微: 後で調整可能
  | "medium"         // 中程度: 1-2日以内に解決必要
  | "high"           // 重大: 即座に解決必要
  | "blocker";       // 阻害: 解決するまで作業停止

/** Colony間意見衝突 */
interface ConflictDetected {
  id: string;
  conference_id?: string;    // 会議中の衝突の場合
  colonies: string[];        // 衝突しているColony IDs
  topic: string;             // 衝突している論点
  opinions: ConflictOpinion[];
  detected_at: string;

  // v5.2追加
  category: ConflictCategory;        // 衝突カテゴリ
  severity: ConflictSeverity;        // 深刻度
  evidence_event_ids: string[];      // 衝突の根拠となるイベントID
  suggested_resolutions?: string[];  // 解決案
}

interface ConflictOpinion {
  colony_id: string;
  position: string;          // そのColonyの立場
  rationale: string;         // 根拠
}

/** 衝突解決 */
interface ConflictResolution {
  conflict_id: string;
  resolved_by: string;       // "user" or "beekeeper"
  resolution: string;        // 解決内容
  merge_rule?: string;       // 適用したマージルール
  resolved_at: string;
}

// ============================================
// Agent Communication（エージェント間通信）
// ============================================

// Beekeeper → Queen Bee
interface OpinionRequest {
  id: string;                    // リクエストID
  conference_id: string;         // 必須（v5.2追加: イベント束ね用）
  from: "beekeeper";
  to: string;                    // Colony ID
  context: ProjectContract;      // 構造化コンテキスト（旧: string）
  question: string;              // 具体的な質問
  deadline?: string;             // 回答期限（ISO8601）
  priority: "low" | "normal" | "high" | "urgent";
}

// Queen Bee → Beekeeper
interface OpinionResponse {
  id: string;                    // レスポンスID
  request_id: string;            // 対応するリクエストID
  conference_id: string;         // 必須（v5.2追加: イベント束ね用）
  from: string;                  // Colony ID
  to: "beekeeper";
  summary: string;               // 回答要約
  details?: string;              // 詳細説明
  questions?: string[];          // 追加質問（あれば）
  confidence: number;            // 確信度 (0.0-1.0)
  sources?: string[];            // 根拠となるイベントID
  conflicts_with?: string[];     // 他Colonyと衝突する可能性がある場合
}

// Queen Bee → Worker Bee
interface TaskAssignment {
  id: string;
  from: string;                  // Colony ID
  to: string;                    // Worker Bee ID
  task_type: string;             // "research" | "generate" | "review" | ...
  instruction: string;           // 具体的な指示
  context: string;               // 背景情報
  tools_allowed: string[];       // 使用可能なMCPツール
  action_class: "read_only" | "reversible" | "irreversible";  // 操作分類
}

// Worker Bee → Queen Bee
interface TaskResult {
  id: string;
  assignment_id: string;
  from: string;                  // Worker Bee ID
  to: string;                    // Colony ID
  status: "completed" | "failed" | "needs_input" | "timeout";
  result?: string;               // 成果物（テキスト）
  artifacts?: ArtifactRef[];     // 成果物（ファイル等）
  error?: string;                // エラー時
  questions?: string[];          // 追加情報が必要な場合
  failure_reason?: string;       // 失敗理由（標準化）
}

// ============================================
// Standard Failure/Timeout（標準失敗・タイムアウト）
// ============================================

/** 標準失敗理由 */
type FailureReason =
  | "timeout"           // タイムアウト
  | "tool_error"        // ツール実行エラー
  | "context_missing"   // コンテキスト不足
  | "permission_denied" // 権限不足
  | "conflict"          // 他操作との競合
  | "cancelled"         // ユーザーキャンセル
  | "unknown";          // 不明なエラー
```

### 8.2 通信フロー

```
ユーザー入力
    │
    ▼
┌──────────┐ OpinionRequest   ┌─────────────┐
│Beekeeper │ ───────────────► │ Queen(UI/UX)│
│          │                  │             │
│          │ OpinionRequest   │ TaskAssign  │
│          │ ───────────────► ─┼────────────►│ Worker A
│          │                  │             │◄────────── TaskResult
│          │ OpinionRequest   │             │
│          │ ───────────────► ─┼────────────►│ Worker B
└──────────┘                  └─────────────┘◄────────── TaskResult
    ▲                               │
    │       OpinionResponse         │
    └───────────────────────────────┘
```

---

## 9. リスクと対策

| リスク | 影響 | 対策 | 検知方法 |
|-------|------|------|---------|
| LLMコスト増大 | 複数エージェント=API呼び出し増 | 軽量LLM活用、キャッシュ、要約で圧縮 | 月次コスト監視 |
| レイテンシ | 複数エージェント=応答遅延 | 並列実行、ストリーミング、プログレス表示 | P95レイテンシ計測 |
| コンテキスト分断 | Colony間で情報が共有されない | Beekeeperによる統合、共有コンテキスト層 | ユーザーフィードバック |
| 複雑性 | システムが複雑すぎて使えない | 段階的リリース、シンプルなデフォルト | ユーザビリティテスト |
| 既存機能の破壊 | v4機能が動かなくなる | 後方互換性テスト、Feature Flag | 既存テストの継続実行 |

---

## 10. コスト見積もり（概算）

> 開発スケジュールは [DEVELOPMENT_PLAN_v1.md](DEVELOPMENT_PLAN_v1.md) のマイルストーン（M1〜M4）を参照。

### LLMコスト（1日あたり概算）

| シナリオ | 想定 | 月額概算 |
|---------|------|---------|
| 開発・テスト | 10回/日 × 3 Colony | $30-50 |
| 軽い利用 | 50回/日 × 3 Colony | $100-200 |
| 本格利用 | 200回/日 × 5 Colony | $500-1000 |
| 会議Bot込み | 上記 + 週5回会議 | +$200-400 |
| Discovery込み | 上記 + 自動抽出 | +$50-100 |

※Claude/GPT-4レベル想定。軽量LLM活用で大幅削減可能

---

## 11. 次のステップ

開発の現在の状況・次のアクションは [DEVELOPMENT_PLAN_v1.md](DEVELOPMENT_PLAN_v1.md) を参照。

---

## 付録A: 用語集（v5）

| 用語 | 定義 |
|-----|------|
| Hive | プロジェクト全体を表す最上位概念。複数のColonyを含む |
| Beekeeper（養蜂家） | ファシリテーターエージェント、ユーザーとの主対話を担当 |
| Colony（群れ） | 専門領域を担当するエージェント群の単位（UI/UX, API等） |
| Queen Bee（女王蜂） | Colonyの代表・調停エージェント。Worker Beeを束ねる |
| Worker Bee（働き蜂） | 実務を担当する個別エージェント。専門スキルを持つ |
| Sentinel Hornet（監視エージェント） | Hive内の全Colonyを監視し、暴走/ループ/コスト超過時に強制停止 |
| Trust Level（委任レベル） | エージェントへの判断委任の度合い |
| Conference（会議） | BeekeeperとColony群が同時に対話するセッション |
| OpinionRequest | BeekeeperからQueen Beeへの意見要求メッセージ |
| OpinionResponse | Queen BeeからBeekeeperへの回答メッセージ |

---

## 付録B: v4→v5 の概念対応

| v4の概念 | v5での位置づけ | 変更点 |
|---------|---------------|--------|
| Run | Colony内の作業単位（変更なし） | Colonyに所属するようになる |
| Task | Run内のタスク（変更なし） | サブタスク階層を追加予定 |
| Requirement | 確認要請（変更なし） | 委任レベルを追加 |
| Decision | 確認要請の解決結果（変更なし） | 変更なし |
| Lineage | 因果リンク | Colony間リンクを追加 |
| AR | イベント永続化 | Hive/Colonyイベントを追加 |
| MCP Server | ツール提供 | Colony操作ツールを追加 |

---

## 付録C: 参考リンク

- [v4仕様書](archive/コンセプト_v4.md)
- [v3仕様書](archive/コンセプト_v3.md)
- [アーキテクチャ](ARCHITECTURE.md)
- [クイックスタート](QUICKSTART.md)
- [tldraw](https://tldraw.com/) - スケッチツール
- [Whisper](https://openai.com/research/whisper) - 音声認識
