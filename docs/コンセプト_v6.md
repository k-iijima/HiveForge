# HiveForge v1.5 — Multi-Agent Collaborative Development System

> **ビジョン**: 信頼できる部品を、信頼できる組み合わせ方をして、信頼できるシステムを作る。
> エージェント群が証拠に基づいて協調し、学習しながら進化する開発プラットフォーム。

> **本書の役割**: 「なぜ」を説明するドキュメント。設計思想・ビジョン・ユースケースを記述。
> 状態機械・イベント型・プロトコルの正式定義は [v5-hive-design.md](design/v5-hive-design.md) を参照。

作成日: 2026-02-01
改訂履歴:
  - v5.0 (2026-02-01): 初版 — マルチエージェント協調開発システム
  - v5.1 (2026-02-01): Decision Protocol, Project Contract, Action Class, Conflict Detection
  - v5.2 (2026-02-01): Conference, Decision scope/owner, Conflict category/severity, Policy Gate, UnknownEvent
  - v5.3 (2026-02-07): Sentinel Hornet（Hive内監視エージェント）
  - **v1.5 (2026-02-07): Swarming Protocol, Guard Bee, Honeycomb, Scout Bee, Waggle Dance, KPI体系**
  - **v1.5.1 (2026-02-07): Forager Bee（探索的テスト・影響分析エージェント）追加**
  - **v1.5.2 (2026-02-07): 「大量生成→自動検証→生存選抜」パラダイム、Referee Bee追加**

> **バージョン注記**: v5.0〜v5.3は本ドキュメントの改訂番号（ファイル名がコンセプト_v5.mdの時代）。
> v1.5以降はシステムバージョン（ファイルをコンセプト_v6.mdに統合済み）。

---

## 0. v5からの進化 — 「信頼できるシステム」への道

### v5で達成したこと

| 機能 | 状態 | v1.5での活用 |
|------|------|-----------|
| マルチエージェント階層 (Beekeeper/Queen/Worker) | ✅ 設計・基盤実装 | Guard Bee（品質検証）で拡張 |
| Hive/Colony AR永続化 | ✅ M1-1完了 | Honeycomb（経験蓄積）の基盤 |
| Beekeeper全ハンドラ | ✅ M1-2完了 | ガバナンスの実効性確認済み |
| Sentinel Hornet監視 | ✅ M2-0完了 | KPI劣化検出を追加 |
| Decision Protocol | ✅ 実装済 | Swarming Protocol の基盤 |
| Conflict Detection | ✅ 実装済 | Evidence-first検証の入力源 |
| Policy Gate | ✅ 実装済 | Waggle Dance（構造化I/O）へ発展 |
| テスト・動作確認 | ✅ pytest実装済 | Forager Bee（探索的テスト）へ発展 |
| １回正解前提 | — 暗黙的前提 | 大量生成→Referee Bee自動選抜へ転換 |

### v1.5の位置づけ

```
v5 (マルチエージェント)          v1.5 (適応的協調)
    │                                │
    │  静的なColony構成              │  Swarming Protocol で適応的編成
    │  経験は蓄積されない            │  Honeycomb で学習
    │  人手の編成判断                 │  Scout Bee で最適編成提案
    │  暗黙的な品質基準              │  Guard Bee による証拠ベース検証
    │  自由形式のI/O                 │  Waggle Dance で構造化I/O
    │  変更影響は人手で探索          │  Forager Bee で影響グラフ探索
    │  「賢い１回」が前提              │  N案並列生成 + Referee Bee 自動選抜
    │                                │
    └────────────────────────────────┘
           証拠と学習に基づく進化
```

---

## 1. 核心原則

### 1.1 Evidence-first（証拠第一）

> **意見ではなく、証拠で語る。**

すべてのエージェント行動は証拠に基づく：

| 従来 | Evidence-first |
|------|---------------|
| 「できたと思います」 | diff + テスト結果 + 理由 |
| 「問題ないでしょう」 | カバレッジ数値 + エッジケース検証 |
| 「この方針でいきましょう」 | 選択肢の比較表 + 選定理由 + ロールバック計画 |

**実装への反映**:
- Decision には `rationale` + `options` + `selected` が必須
- Task完了時は成果物 (artifact) + テスト結果が必須
- Guard Bee が証拠の妥当性を検証

### 1.2 Evolving SOP（進化する標準作業手順）

> **SOPは固定的なルールではなく、レビューサイクルを通じて進化する。**

```
初期SOP → 実行 → Honeycomb記録 → KPI計測 → レビュー → SOP改訂
  │                                                │
  └──────────── フィードバックループ ────────────────┘
```

- Honeycomb に実行履歴と結果を蓄積
- KPI の変化傾向を Scout Bee が分析
- 改善提案を Beekeeper 経由でユーザーに提示
- 承認された変更が新しい SOP として反映

### 1.3 養蜂場メタファー（拡張）

```
┌──────────────────────────────────────────────────────────────────┐
│   ユーザー ◄─── テキスト/音声/スケッチ ───►                       │
│      │                                                           │
│      ▼                                                           │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │              Beekeeper（養蜂家 / ファシリテーター）          │    │
│  │  - ユーザーとの主対話、複数Hiveの統括管理                   │    │
│  │  - Swarming Protocol によるColony編成                      │    │
│  │  - 最終判断の提示・委任管理                                 │    │
│  └──────────────────────┬───────────────────────────────────┘    │
│                         │                                        │
│  ┌──────────────────────▼───────────────────────────────────┐    │
│  │                     Hive A (プロジェクトA)                 │    │
│  │                                                           │    │
│  │  ┌─────────────────────────────────────────────────────┐  │    │
│  │  │  🐝 Sentinel Hornet（監視・執行エージェント）        │  │    │
│  │  │  - 全Colonyの行動・状態を常時監視                   │  │    │
│  │  │  - 異常検出 → 強制停止 / ロールバック / 隔離         │  │    │
│  │  ├─────────────────────────────────────────────────────┤  │    │
│  │  │  🛡️ Guard Bee（門番蜂 / 品質検証エージェント）        │  │    │
│  │  │  - 選抜案の品質・コンプライアンス最終判定             │  │    │
│  │  │  - 証拠ベースの合格/差戻し判定                       │  │    ││  │  ├─────────────────────────────────────────────────┤  │    │
│  │  │  ⚖️ Referee Bee（審判蜂 / 自動採点・選抜エージェント）   │  │    │
│  │  │  - N案候補の多面的スコアリング・生存選抜              │  │    │
│  │  │  - Forager証拠 + 独自計測で自動採点                  │  │    ││  │  ├─────────────────────────────────────────────────┤  │    │
│  │  │  🌻 Forager Bee（採餌蜂 / 探索的テストエージェント）     │  │    │
│  │  │  - 変更影響グラフの探索・含意シナリオ生成             │  │    │
│  │  │  - 探索実行・違和感検知 → Referee/Guard Beeへ証拠提供 │  │    ││  │  └─────────────────────────────────────────────────────┘  │    │
│  │                                                           │    │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐          │    │
│  │  │Colony:UI/UX│  │Colony: API │  │Colony:Infra│  ...     │    │
│  │  │  Queen Bee │  │  Queen Bee │  │  Queen Bee │          │    │
│  │  │  Worker(s) │  │  Worker(s) │  │  Worker(s) │          │    │
│  │  └────────────┘  └────────────┘  └────────────┘          │    │
│  └───────────────────────────────────────────────────────────┘    │
│                                                                   │
│  ┌───────────────────────────────────────────────────────────┐    │
│  │  🍯 Honeycomb（ハニカム）    │  🔍 Scout Bee（偵察蜂）    │    │
│  │  - 実行履歴蓄積（巣房）     │  - 過去実績から編成提案     │    │
│  │  - 失敗分類・学習           │  - Colony テンプレート選択   │    │
│  └───────────────────────────────────────────────────────────┘    │
│                                                                   │
│  ── 💃 Waggle Dance（ワグルダンス / 構造化通信）──                │
│     エージェント間のI/Oを構造化し、プロトコル準拠を検証            │
└───────────────────────────────────────────────────────────────────┘
```

### 1.4 大量生成→自動検証→生存選抜（v1.5.2）

> **「賢い1回」から「雑でも多回 + 厳密な自動審判」へ。**

LLMの根本的な弱点は「単発回答の不安定性」にある。
人間には1案読むだけでも重い作業だが、機械なら30案生成して上位だけ残すことができる。
この非対称性を活用し、**精度不足を「検証付き選抜」で埋める**。

#### パラダイムシフト

```
従来: UserInput → Agent(1回) → 成果物 → レビュー
v1.5: UserInput → Agent(N案) → 自動検証 → 選抜 → 成果物
```

#### 人間には重すぎるが機械なら実行可能な検証手法

| 手法 | 説明 | HiveForgeでの活用 |
|------|------|-------------------|
| **N案並列 + トーナメント** | 同一課題にN実装を同時生成し、多面的に自動選抜 | Worker Bee × N → Referee Bee |
| **Mutation Testing（変異テスト）** | コードに小さなバグを人工注入し、テストが検出できるか逆検証 | Forager Bee フェーズ3 |
| **Differential Testing（差分実行）** | 新旧実装に同一入力を大量投入し、出力差を自動検知 | Referee Bee スコアリング |
| **Metamorphic Testing** | 「入力をこう変えたら出力はこうなるべき」という関係で検証 | Forager Bee シナリオ生成 |
| **Property-based Testing** | 不変条件でランダム入力を何千ケースも回し、境界バグを掘る | Forager Bee フェーズ2 |
| **Shadow Execution（影実行）** | 本番相当トラフィックを新ロジックに流し、結果だけ比較 | Sentinel Hornet 拡張 |
| **Runtime Invariant Monitor** | 「壊れてはいけない性質」を実行時に常時監視 | Sentinel Hornet 常時監視 |

#### 実行パイプライン

```
Worker Bee × N案生成
       │
       ▼
Forager Bee（探索シナリオ拡張・Mutation/Property-based Testing）
       │
       ▼
Referee Bee（多面的採点・生存選抜トーナメント）
       │  FinalScore = 0.40×Correctness + 0.20×Robustness
       │             + 0.20×Consistency + 0.10×Security + 0.10×Latency
       ▼
Guard Bee（最終品質ゲート — PASS/CONDITIONAL_PASS/FAIL）
       │
       ▼
Sentinel Hornet（本番相当監視・Runtime Invariant）
```

#### スコアリング（Referee Bee）

| 指標 | 重み | 計測方法 |
|------|------|---------|
| **Correctness** | 0.40 | 仕様適合テスト合格率 |
| **Robustness** | 0.20 | 変異テスト・境界値耐性 |
| **Consistency** | 0.20 | 差分実行一致性（旧実装 or 他候補との比較） |
| **Security** | 0.10 | 静的/動的セキュリティチェック |
| **Latency** | 0.10 | 実行性能（レスポンスタイム） |

#### 導入順序（効果の早い順）

| 順序 | 手法 | 理由 |
|------|------|------|
| 1️⃣ | Differential Testing | 既存テストインフラで即実行可能、仕様の曖昧箇所を炙り出せる |
| 2️⃣ | Property-based Testing | Hypothesis等の既存ライブラリで低コスト導入、境界バグの発見力が高い |
| 3️⃣ | Mutation Testing | テストの「質」を逆証明、mutmut等で自動化可能 |
| 4️⃣ | Shadow Execution | 本番相当データが必要なため最後、ただし効果は最大 |

---

## 2. エージェント階層構造

### 2.1 Beekeeper（養蜂家エージェント）

**役割**: 複数Hiveの統括者、ファシリテーター、Swarming Protocol実行者

- ユーザーからの入力を受け取り、タスクを分析
- **Swarming Protocol** によりタスク特性に応じたColony編成を決定
- 全体コンテキスト（複数プロジェクトの目標、制約、履歴）を保持
- 各Hive内のQueen Beeからの報告を統合し、ユーザーに提示
- Honeycomb の学習結果を Scout Bee 経由で活用

**技術的実現**:
- 大規模コンテキストを扱えるLLM（Claude, GPT-4等）
- Swarming Protocolの入力特徴量からColonyテンプレートを選択
- ユーザーとの対話履歴・決定履歴をARに記録

### 2.2 Sentinel Hornet（監視・執行エージェント）

**役割**: Hive内の全Colony・全エージェントの**行動監視と異常検出・強制停止**

> v5.3で導入。検出と執行を一体で担当する（実際の蜂と同様に脅威の察知から排除まで一貫して行う）。

- **1つのHiveに1体**存在し、全Colonyを横断的に監視
- イベントストリームをリアルタイムに分析
- 異常を検出した場合、**即座に対処を実行**
- 検出根拠と執行ログは全てARに記録
- Beekeeperとは**独立した権限**で緊急停止を実行可能（安全弁）

**監視対象**:

| パターン | 検出方法 |
|---------|---------|
| 無限ループ | タスク完了/失敗の周期性検出 |
| 暴走 | イベント発行レート閾値 |
| コスト超過 | トークン/APIコール累積 |
| セキュリティ違反 | ActionClass × TrustLevel ポリシーチェック |
| 沈黙 | 一定時間イベントなし |
| KPI劣化 | Correctness/Lead Time の急激な変化 |

**執行アクション**:

| アクション | 内容 | 復帰 |
|-----------|------|------|
| **強制停止** | Colony を `SUSPENDED` に遷移、進行中タスクを一時停止 | Beekeeper承認で再開 |
| **ロールバック** | 指定時点までの成果物を巻き戻し | 新しいRunとして再実行 |
| **隔離** | 問題Colonyを切り離し、他Colonyへの影響を遮断 | 原因解消後に再接続 |

### 2.3 Guard Bee（門番蜂 / 品質検証エージェント）

> 実際の蜂の巣では、門番蜂が巣の入口で帰還した蜂を検査し、
> 異物や敵の侵入を防ぐ。Guard Beeは成果物の「門番」として品質ゲートを担当する。

**役割**: 成果物の品質・コンプライアンスを**証拠に基づいて**検証

- Colony の成果物（コード、設計、テスト）を受け取り、品質ゲートを実施
- Evidence-first 原則に基づく検証:

| 検証項目 | 証拠 | 合格基準 |
|---------|------|---------|
| コード品質 | diff + lint結果 + テストカバレッジ | カバレッジ閾値以上、lint警告0 |
| 設計整合性 | Decision記録 + 設計ドキュメント | 既存Decisionとの矛盾なし |
| セキュリティ | 脆弱性スキャン結果 | 既知脆弱性0 |
| コンプライアンス | SOP準拠チェックリスト | 全項目クリア |

- 合格 → 成果物を承認、Honeycomb に成功記録
- 差戻し → 具体的な改善指示と共にColonyに返却
- Honeycomb の過去事例を参照し、再発パターンを警告

#### Guard Bee 判定レベル

Guard Bee 判定は2層で実施する:

| レベル | 名称 | 内容 |
|--------|------|------|
| **L1** | ルール検証 | 機械可判定（lint, カバレッジ閾値, スキーマ準拠） |
| **L2** | 文脈検証 | 設計意図・リスク・既存Decisionとの整合性 |

判定結果:

| 結果 | 説明 |
|------|------|
| **PASS** | 全検証項目をクリア |
| **CONDITIONAL_PASS** | 軽微な指摘あり。期限付きで承認し、期限内に是正を要求 |
| **FAIL** | 重大な問題あり。差戻し |

### 2.4 Queen Bee（Colony調停エージェント）

**役割**: 専門領域の代表、チームリーダー（v5から継続）

- Beekeeperから「意見要求」を受け取り、Colonyの方針を決定
- Worker Beeにタスクを振り分け、結果を統合
- Guard Bee からの差戻しに対応

### 2.5 Worker Bee（専門家エージェント）

**役割**: 実務担当、専門知識の提供（v5から継続）

- Queen Beeからタスクを受け取り、実務を実行
- 成果物と**証拠（diff, テスト結果, 根拠）**を報告

### 2.6 Forager Bee（採餌蜂 / 探索的テストエージェント）

> 実際の採餌蜂（forager bee）は巣の外を広範囲に探索し、蜜源を発見して花粉と蜜を巣に持ち帰る。
> Forager Bee は同様に、変更の影響範囲を広く探索し、潜在的な不整合や違和感を
> 証拠として収集し、Guard Bee に渡す。

**背景**: 単体テストが通っても、他機能との結合部・暗黙の前提・経験的に「嫌な予感」がするパターンは
機械的なテストだけでは捕捉できない。経験豊富な開発者が「関係しそうな」箇所を
包括的に動作させ、脳内の大量の想定から「おかしい」を拾い上げるような役割を担う。

**役割**: Colonyの成果物の影響範囲を探索し、含意的シナリオを発見・実行し、証拠をGuard Beeに渡す

#### フェーズ1: 変更影響グラフの構築

変更ファイルだけでなく、以下を再帰的に展開する:

| 展開対象 | 例 |
|---------|----|
| モジュール依存 | `import` チェーン、パッケージ依存 |
| 呼び出しグラフ | 変更のあった関数/クラスの全呼出元 |
| イベントフロー | 変更EventTypeの発行元・購読先・状態機械遷移 |
| 設定影響 | `hiveforge.config.yaml` の閾値・フラグ変更の波及 |
| スキーマ変更 | Pydanticモデルのフィールド変更のAPI/MCPへの波及 |

#### フェーズ2: 含意シナリオの生成

影響グラフから「関係しそう」な経路をユースケース単位で列挙:

| シナリオ種別 | 説明 |
|-----------|------|
| **正常系交差** | 変更対象と依存先の標準フローが正常に通るか |
| **境界値** | 空リスト・ゼロ値・最大長・型境界での挙動 |
| **順序違い** | イベントが想定外の順序で到着した場合 |
| **同時操作** | 複数Colonyが同じリソースに触れる場合 |
| **リトライ・タイムアウト** | 失敗後のリトライやタイムアウト後の状態整合性 |
| **設定・環境差異** | デフォルト値依存・未設定時の挙動 |

#### フェーズ3: 探索実行

生成されたシナリオを実際に実行し、結果を収集:

- ユニットテストだけでなく、シナリオベースの統合テストを動的に生成・実行
- APIエンドポイントの実際の呼び出しシーケンス
- 状態機械の遷移パスの網羅的検証

#### フェーズ4: 違和感検知

「テストは通るが何かおかしい」を検出する:

| 検知パターン | 具体例 |
|-----------|--------|
| **期待値差分** | レスポンス構造の微妙な変化、返り値の型変化 |
| **過去Run比較** | 同一シナリオの過去実行との挙動差分 |
| **副作用検出** | 想定外のイベント発行、状態変化、ファイル変更 |
| **性能回帰** | レスポンスタイムの有意な増加 |
| **ログ異常** | 警告・エラーログの増加パターン |

#### Guard Bee との連携フロー（N案選抜パイプライン統合）

```
Worker Bee × N案生成
       │
       ▼
┌──────────────────────────────────────┐
│  Forager Bee                           │
│  ① 変更影響グラフ構築                  │
│  ② 含意シナリオ生成（Mutation/Property/│
│     Metamorphic Testing含む）          │
│  ③ 探索実行                              │
│  ④ 違和感検知                              │
└──────────────────┬───────────────────┘
                   │
    ForagerReport:  │  • 影響グラフ
                   │  • 実行済みシナリオ結果
                   │  • 検知された違和感リスト
                   │  • テスト強度証明（変異テスト等）
                   ▼
┌──────────────────────────────────────┐
│  Referee Bee（N案の場合）               │
│  多面的スコアリング → 生存選抜           │
│  Forager証拠 + 独自計測で自動採点        │
└──────────────────┬───────────────────┘
                   │  上位候補のみ
                   ▼
┌──────────────────────────────────────┐
│  Guard Bee                             │
│  選抜案 + Forager/Referee証拠で最終判定  │
│  → PASS / CONDITIONAL_PASS / FAIL     │
└──────────────────────────────────────┘
```

> **単一案の場合**: Referee Beeはスキップされ、Forager → Guard の従来フローが適用される。

#### Sentinel Hornetとの役割分担

| 観点 | Sentinel Hornet | Forager Bee | Referee Bee |
|------|-----------------|-------------|-------------|
| **タイミング** | 実行中リアルタイム | 成果物生成後、判定前 | Forager後、Guard前 |
| **関心** | 暴走・ループ・コスト超過 | 変更影響・含意的不整合・違和感 | N候補間の相対品質差 |
| **アクション** | 強制停止・ロールバック | 証拠収集・レポート作成 | スコアリング・選抜 |
| **判断権** | あり（緊急停止） | なし（Guard Beeに委譲） | 候補選抜のみ（最終判定はGuard） |

### 2.7 Referee Bee（審判蜂 / 自動採点・選抜エージェント）

**役割**: N案の候補実装を多面的に自動採点し、上位候補のみを次段階（Guard Bee）へ送る

> 蜂の群れでは、偵察蜂が持ち帰った複数の候補巣を「ダンスの激しさ」で競わせ、
> 集団がより良い候補に収束していく。Referee Beeはこの「自動評価トーナメント」をソフトウェア品質に適用する。

- **1つのHiveに1体**（Guard Beeと対）
- N案の並列生成結果を受け取り、多次元スコアで自動採点
- 上位K件（デフォルトK=1）のみをGuard Beeに渡す
- 単一案の場合はスキップ（Forager → Guard の従来フロー）

#### スコアリングモデル

```
FinalScore = 0.40 × Correctness
           + 0.20 × Robustness
           + 0.20 × Consistency
           + 0.10 × Security
           + 0.10 × Latency
```

| 指標 | 計測方法 | データソース |
|------|---------|-------------|
| **Correctness** | 仕様適合テスト合格率（全テスト/合格数） | Forager Bee テスト結果 |
| **Robustness** | 変異テスト耐性 + 境界値テスト合格率 | Forager Bee Mutation Testing |
| **Consistency** | 差分実行一致性（旧実装 or 他候補との出力比較） | Referee Bee 独自計測 |
| **Security** | 静的解析ルール違反数 + 動的セキュリティチェック | Guard Bee ルール + Referee実行 |
| **Latency** | ベンチマーク実行時間（相対比較） | Referee Bee 独自計測 |

#### トーナメント実行フロー

```
┌───────────────────────────────────────────────────┐
│  Worker Bee × N案                                  │
│  各案: コード + テスト + 自己説明                     │
└──────────────────────┬────────────────────────────┘
                       │
                       ▼
┌───────────────────────────────────────────────────┐
│  Forager Bee                                       │
│  各案に対して:                                     │
│    - 影響グラフ構築                                 │
│    - Mutation Testing（テストの質を逆証明）          │
│    - Property-based Testing（境界バグ探索）          │
│    - 含意シナリオ生成・実行                          │
│  → ForagerReport × N を Referee Bee へ              │
└──────────────────────┬────────────────────────────┘
                       │
                       ▼
┌───────────────────────────────────────────────────┐
│  Referee Bee — トーナメント                         │
│  ① 全候補の ForagerReport を収集                    │
│  ② Differential Testing（候補間の出力差分を比較）    │
│  ③ 5次元スコアを計算                                │
│  ④ 上位K件を選抜（デフォルトK=1）                   │
│  ⑤ RefereeReport（スコア詳細+選抜理由）をGuardへ    │
└──────────────────────┬────────────────────────────┘
                       │  上位候補のみ
                       ▼
┌───────────────────────────────────────────────────┐
│  Guard Bee — 最終品質ゲート                         │
│  RefereeReport + ForagerReport を踏まえ最終判定     │
│  → PASS / CONDITIONAL_PASS / FAIL                  │
└───────────────────────────────────────────────────┘
```

#### Guard Beeとの役割分担

| 観点 | Referee Bee | Guard Bee |
|------|-------------|----------|
| **目的** | N候補から最良を選ぶ | 選抜案が品質基準を満たすか判定 |
| **入力** | N案 + ForagerReport × N | 選抜1案 + RefereeReport + ForagerReport |
| **出力** | RefereeReport（スコア + 選抜理由） | PASS / CONDITIONAL_PASS / FAIL |
| **判断基準** | 相対評価（候補間比較） | 絶対評価（品質基準適合） |
| **スキップ条件** | 単一案の場合 | なし（常に実行） |

**技術的実現**:
- スコアリングエンジン: 各指標の計算ロジック + 重み付け合成
- 候補比較フレームワーク: Differential Testing（同一入力での出力差分比較）
- RefereeReport: 構造化レポート（Pydanticモデル）
- ARへ全スコア詳細・選抜根拠を記録（透明性保証）

---

## 3. Swarming Protocol — 適応的Colony編成

> 蜂が分蜂（swarming）する際、偵察蜂の情報をもとに集団で新しい巣の場所を決定する。
> Swarming Protocol は同様に、タスクの特性に応じて最適なColony編成を決定する。

### 3.1 入力特徴量

初期は3軸で評価（将来的に拡張可能）:

| 軸 | 説明 | 評価 |
|----|------|------|
| **Complexity（複雑さ）** | 技術的な困難度、コンポーネント間の結合度 | 1-5 |
| **Risk（リスク）** | 失敗時の影響範囲、不可逆性 | 1-5 |
| **Urgency（緊急度）** | 期限までの時間的余裕 | 1-5 |

> **将来の拡張軸**: Novelty（新規性）、Dependency（依存度）、Domain（専門度）を追加予定。
> 拡張はHoneycombにデータが十分蓄積された段階で、データに基づいて有用な軸を選定する。

### 3.2 Colony テンプレート

特徴量の組み合わせから4つのテンプレートを選択:

| テンプレート | 選択条件 | 構成 | 特徴 |
|------------|---------|------|------|
| **Speed** | 低Complexity + 低Risk + 高Urgency | Queen + 1 Worker | 最小構成で高速実行 |
| **Balanced** | 中程度の全指標 | Queen + 2-3 Workers + Guard Bee | 標準的な品質保証付き |
| **Quality** | 高Complexity or 高Risk | Queen + 3-5 Workers + Guard Bee + レビュアー | 厳格な品質ゲート |
| **Recovery** | 障害復旧、過去の失敗タスク | Queen + Worker + Sentinel Hornet連携 | 問題解決特化 |

### 3.3 編成フロー

```
ユーザー入力
    │
    ▼
┌──────────────┐
│  Beekeeper   │
│  タスク分析   │
│  特徴量抽出   │
└──────┬───────┘
       │
       ▼
┌──────────────┐     ┌──────────────┐
│  Swarming    │────►│  Scout Bee   │
│  Protocol    │     │  過去実績参照 │
│  3軸スコア   │     │              │
└──────┬───────┘     └──────┬───────┘
       │                    │
       ▼                    ▼
┌──────────────────────────────────┐
│      テンプレート選択            │
│  Speed / Balanced / Quality     │
│  / Recovery                     │
│  ※ Override適用時は §3.4 参照   │
└──────────────┬───────────────────┘
               │
               ▼
┌──────────────────────────────────┐
│    Beekeeper → ユーザー提案     │
│   「Quality テンプレートで       │
│    3 Colony編成を提案します」    │
└──────────────┬───────────────────┘
               │ ユーザー承認
               ▼
       Colony群を生成・開始
```

### 3.4 Override規約（例外編成）

Swarming Protocol の提案に対し、Beekeeper またはユーザーは例外的に編成を上書き（Override）できる。
上書き時は以下を必須記録とする:

| フィールド | 説明 |
|-----------|------|
| `override_reason` | 上書きの理由（なぜ標準テンプレートでは不適か） |
| `override_scope` | 影響範囲（対象Colony、変更内容） |
| `override_reviewer` | 上書きを承認した人物/エージェント |
| `expiry` | 有効期限（ISO 8601形式） |

- Override記録はARイベントとして永続化し、Honeycombにも記録する
- 期限到達時は標準テンプレート選択に**自動復帰**する
- Override頻度はKPI（Incident Rate）に含めて計測し、テンプレート改善の入力とする

---

## 4. Honeycomb（ハニカム）— 経験の蓄積と学習

> 蜂が六角形の巣房（honeycomb）に蜜と花粉を蓄えるように、
> HiveForgeは実行エピソードをHoneycombに蓄積し、経験から学習する。

### 4.1 Episode構造

```python
class Episode:
    episode_id: str          # ULID
    run_id: str              # 対応するRun
    colony_id: str           # 対応するColony
    template_used: str       # 使用したColonyテンプレート
    
    # 入力
    task_features: SwarmingFeatures  # Swarming Protocol スコア
    
    # 結果
    outcome: "success" | "failure" | "partial"
    duration_seconds: float
    token_count: int
    
    # 失敗分類（失敗時のみ）
    failure_class: FailureClass | None
    
    # KPI計測値
    kpi_scores: KPIScores
    
    # 因果リンク
    parent_episode_ids: list[str]  # 前回の試行等
```

### 4.2 失敗分類（Failure Classification）

| 分類 | 説明 | 学習ポイント |
|------|------|-------------|
| **Specification Error** | 仕様の不明確さ・矛盾 | 事前確認項目の追加 |
| **Design Error** | 設計判断の誤り | Decision記録の改善 |
| **Implementation Error** | コーディングミス | テスト戦略の見直し |
| **Integration Error** | Colony間の結合不整合 | 依存管理の強化 |
| **Environment Error** | 環境固有の問題 | 環境検証の追加 |
| **Timeout** | 時間切れ | 見積もり精度の改善 |

### 4.3 学習サイクル

```
Honeycomb蓄積 → パターン分析 → 改善提案 → SOP更新
                                  │
                      ┌───────────┤
                      │           │
              失敗パターンの     成功パターンの
              早期検出           テンプレート最適化
```

---

## 5. Scout Bee（偵察蜂）— 過去実績に基づく編成最適化

> 偵察蜂は新しい蜜源を探し、仲間にワグルダンスで最適な場所を伝える。
> Scout Beeは同様に、Honeycombの蓄積データから最適なColony編成を提案する。

### 5.1 動作原理

1. 新しいタスクの Swarming Protocol 特徴量を算出
2. Honeycomb から類似特徴量の過去エピソードを検索
3. 成功率・KPI が最も良かったテンプレートを特定
4. Beekeeper に編成提案として提示

### 5.2 最適化指標

| 指標 | 重み | 説明 |
|------|------|------|
| 成功率 | 高 | 類似タスクでの成功確率 |
| Lead Time | 中 | 完了までの所要時間 |
| トークンコスト | 低 | LLM API呼び出しコスト |
| Recurrence Rate | 中 | 同一失敗の再発率 |

### 5.3 コールドスタート問題

Honeycomb のデータが不足している初期段階では:
- デフォルトテンプレート（Balanced）を使用
- 全エピソードを積極的に記録
- 設定可能な閾値を超えたらScout Beeの推薦を有効化

---

## 6. Waggle Dance（ワグルダンス）— 構造化 I/O 検証

> 蜂のワグルダンスは、角度で方向を、持続時間で距離を伝える**構造化された通信プロトコル**。
> HiveForgeのWaggle Danceは、エージェント間のI/Oを同様に構造化し、プロトコル準拠を検証する。

### 6.1 目的

- エージェント間通信の**型安全性**を保証
- 不正なメッセージや不完全なデータを早期に検出
- 通信ログを構造化して Honeycomb に記録

### 6.2 検証対象

| 通信 | 検証内容 |
|------|---------|
| Beekeeper → Queen Bee (OpinionRequest) | ProjectContract の完全性、質問の明確さ |
| Queen Bee → Beekeeper (OpinionResponse) | 回答の具体性、confidence 値の妥当性 |
| Queen Bee → Worker Bee (TaskAssignment) | 指示の具体性、tools_allowed の妥当性 |
| Worker Bee → Queen Bee (TaskResult) | 成果物の存在、証拠の添付 |
| Guard Bee 検証結果 | 判定根拠の具体性 |

### 6.3 実装方針

- Pydantic モデルによるスキーマ検証（既存インフラを活用）
- 検証失敗時は送信者に差し戻し + ARにエラーイベント記録
- Waggle Dance 自体はステートレスなミドルウェア

---

## 7. KPI体系

> 定量的な指標でシステム全体の健全性を計測する。

### 7.1 KPI定義

| KPI | 定義 | 計測方法 | 目標 |
|-----|------|---------|------|
| **Correctness（正確性）** | Guard Bee の一次合格率 | 合格数 / 検証数 | > 85% |
| **Repeatability（再現性）** | 同一タスク種別の成功率分散 | σ(成功率) | < 0.1 |
| **Lead Time（リードタイム）** | タスク開始→完了の所要時間 | Honeycomb から算出 | 改善傾向 |
| **Incident Rate（インシデント率）** | Sentinel Hornet の介入頻度 | アラート数 / タスク数 | < 5% |
| **Recurrence Rate（再発率）** | 同一分類の失敗が再発する率 | 再発数 / 初発数 | < 10% |

### 7.2 KPI ダッシュボード

- VS Code 拡張の Hive Monitor Webview に統合
- トレンドグラフ（日次/週次）
- Colony 別・テンプレート別の比較

### 7.3 KPI運用規約（v1.5）

| KPI | 計測ルール |
|-----|----------|
| **Correctness** | 日次・週次の2窓で集計する |
| **Repeatability** | 同一タスク種別で N=3 回再実行し算出する |
| **Incident Rate** | 「警告（warning）」と「介入（intervention）」を分離して計測する |
| **Recurrence Rate** | 30日移動窓で計測する |

- KPI計測ロジック変更時は**バージョンを付与**し、Honeycombに保存する
- バージョン間の比較が可能なように、旧ロジックでの遡及計算も保持する

### 7.4 KPI による調整（将来ビジョン）

> **⚠️ 注**: 以下は十分なHoneycombデータ蓄積後の将来構想です。
> 初期段階ではBeekeeperがKPIを参照して手動で調整を判断します。

| KPI変化 | 調整アクション |
|--------|-------------|
| Correctness 低下 | Quality テンプレートの使用率を上げる |
| Lead Time 増大 | 並列度を上げる / タスク分割を細かくする |
| Incident Rate 上昇 | Sentinel Hornet の監視閾値を厳格化 |
| Recurrence Rate 上昇 | 失敗分類に基づく事前チェック項目を追加 |

---

## 8. 委任レベル（Trust Level）と操作分類（Action Class）

> v5 から継続。Evidence-first 原則を組み合わせて強化。

### 8.1 Trust Level

| レベル | 名称 | 説明 |
|-------|------|------|
| 0 | 報告のみ | 全ての判断をユーザーに確認 |
| 1 | 提案＋確認 | 提案するが実行前に確認（デフォルト） |
| 2 | 自動＋通知 | 自動実行するが結果を通知 |
| 3 | 完全委任 | 自動実行、問題時のみ通知 |

### 8.2 Action Class

| Action Class | 説明 | 例 |
|-------------|------|-----|
| **Read-only** | 読み取り専用 | ファイル参照、検索 |
| **Reversible** | 元に戻せる操作 | ファイル編集（Git管理下） |
| **Irreversible** | 高リスク操作 | 本番DB変更、外部API課金 |

### 8.3 Trust Level × Action Class マトリクス

| | Read-only | Reversible | Irreversible |
|---|:---:|:---:|:---:|
| **Level 0** | ✅ 自動 | ❌ 確認必須 | ❌ 確認必須 |
| **Level 1** | ✅ 自動 | ❌ 確認必須 | ❌ 確認必須 |
| **Level 2** | ✅ 自動 | ✅ 自動+通知 | ❌ 確認必須 |
| **Level 3** | ✅ 自動 | ✅ 自動 | ⚠️ 確認推奨 |

> **v1.5 強化点**: Level 2以上の自動実行でも、Guard Bee の事後検証は常に実施される。

---

## 9. 技術アーキテクチャ

### 9.1 全体構成

```
┌────────────────────────────────────────────────────────────────┐
│                      VS Code Extension                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Conference   │  │ Hive Monitor │  │ Activity     │         │
│  │ View         │  │ (Dashboard)  │  │ TreeView     │         │
│  │ (チャット)    │  │ (KPI+状態)   │  │ (イベント)   │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
│         └─────────────────┼─────────────────┘                  │
│                           ▼                                    │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │                  HiveForge API / MCP                      │ │
│  └──────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────────┐
│                     エージェント階層                             │
│                                                                │
│  Beekeeper ─── Swarming Protocol + Scout Bee                   │
│      │                                                         │
│      ├── Waggle Dance (構造化I/O検証)                          │
│      │                                                         │
│      └── Hive ─── Sentinel Hornet (監視・執行)                 │
│              │                                                 │
│              ├── Guard Bee (最終品質判定)                       │
│              ├── Referee Bee (N案自動採点・選抜)                │
│              │                                                 │
│              ├── Colony: UI/UX ── Queen + Workers              │
│              ├── Colony: API   ── Queen + Workers              │
│              └── Colony: Infra ── Queen + Workers              │
│                                                                │
│  Honeycomb ◄──── 全実行履歴                                    │
└────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────────┐
│                     永続化層                                    │
│                                                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Akashic      │  │ Hive Store   │  │ Honeycomb    │         │
│  │ Record (AR)  │  │ (Hive/Colony)│  │ (実行履歴)   │         │
│  │ Run/Task     │  │ JSONL永続化  │  │ JSONL永続化  │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└────────────────────────────────────────────────────────────────┘
```

### 9.2 新規コンポーネント（v1.5追加）

| コンポーネント | 蜂の生態との対応 | 説明 | 実装方針 |
|--------------|----------------|------|---------|
| **Swarming Protocol** | 分蜂時の集団意思決定 | タスク特徴量→テンプレート選択 | Pydanticモデル + ルールベース |
| **Guard Bee** | 門番蜂（巣の入口で検査） | 品質検証エージェント | 検証ルール定義 + LLM判定 |
| **Forager Bee** | 採餌蜂（広範囲探索・持ち帰り） | 探索的テスト・影響分析 | 依存グラフ + シナリオ生成 + LLM |
| **Referee Bee** | 審判蜂（ダンス品質評価） | N案の多面的採点・選抜 | スコアリングエンジン + 比較フレームワーク |
| **Honeycomb** | 巣房（蜜と花粉の蓄積） | 実行履歴永続化 | HiveStore と同様のJSONLベース |
| **Scout Bee** | 偵察蜂（最適な蜜源を提案） | テンプレート最適化 | Honeycomb検索 + 統計分析 |
| **Waggle Dance** | ワグルダンス（構造化通信） | I/O検証ミドルウェア | Pydanticバリデーション |
| **KPI Calculator** | — | KPI算出 | Honeycomb 集計 |

### 9.3 既存コンポーネントの拡張

| コンポーネント | 変更内容 |
|--------------|---------|
| Sentinel Hornet | KPI劣化検出を追加（ロールバック・隔離は段階的実装） |
| Beekeeper | Swarming Protocol統合、Scout Bee連携 |
| Hive Monitor (VS Code) | KPIダッシュボード追加 |
| Config | Swarmingパラメータ、テンプレート定義を追加 |

---

## 10. ビジョンロードマップ

> **⚠️ 注**: 実装計画は [DEVELOPMENT_PLAN_v2.md](DEVELOPMENT_PLAN_v2.md) のマイルストーンを参照。
> 以下はビジョンとしての段階的発展構想です。

### Phase 0: 設計検証 ✅ 完了
**成果物**: v5-hive-design.md, 本書

### Phase 1: 単一Colony動作 ✅ 基盤完了
**成果物**: Hive/Colony AR永続化, Beekeeper全ハンドラ, Sentinel Hornet

### Phase 2: 適応的協調 ← **現在のフォーカス**
**目標**: Swarming Protocol + Guard Bee + Honeycomb で「学習するシステム」の基盤

### Phase 3: マルチColony自律
**目標**: LLMタスク分解 + Worker Bee並列実行 + Colony間自律調整

### Phase 4: リッチ入力/出力
**目標**: 音声対話、ビジュアル生成、Conference View

### Phase 5: 会議Bot + Requirements Discovery
**目標**: ビデオ会議参加、忖度しない質問Bot

---

## 11. 用語集（v1.5）

| 用語 | 蜂の生態 | 定義 |
|-----|---------|------|
| **Beekeeper** | 養蜂家 | ファシリテーターエージェント。ユーザーとの主対話、Hive統括 |
| **Hive** | 巣箱 | プロジェクト全体を表す最上位概念 |
| **Colony** | 群れ | 専門領域を担当するエージェント群の単位 |
| **Queen Bee** | 女王蜂 | Colonyの代表・調停エージェント |
| **Worker Bee** | 働き蜂 | 実務を担当する個別エージェント |
| **Sentinel Hornet** | スズメバチ | Hive内の監視・異常検出・強制停止エージェント |
| **Guard Bee** | 門番蜂 | 成果物の品質・コンプライアンス検証エージェント |
| **Forager Bee** | 採餌蜂 | 変更影響の探索的テスト・違和感検知・証拠収集エージェント |
| **Referee Bee** | 審判蜂 | N案候補の多面的採点・生存選抜トーナメントエージェント |
| **Scout Bee** | 偵察蜂 | 過去実績に基づくColony編成最適化 |
| **Honeycomb** | 巣房（蜜蝋） | 実行履歴の蓄積と学習基盤 |
| **Waggle Dance** | 尻振りダンス | エージェント間I/Oの構造化通信プロトコル |
| **Swarming Protocol** | 分蜂 | タスク適応的なColony編成プロトコル |
| **Trust Level** | — | エージェントへの判断委任の度合い (0-3) |
| **Action Class** | — | 操作のリスクレベル分類 (Read-only/Reversible/Irreversible) |
| **Evidence-first** | — | 意見ではなく証拠で判断する原則 |
| **Evolving SOP** | — | レビューサイクルで進化する標準作業手順 |
| **Conference** | — | 複数Colonyが参加する対話セッション |
| **Lineage** | — | イベント間の因果リンク |

---

## 付録A: v5→v1.5 の変更対応

| v5の概念 | v1.5での位置づけ | 変更点 |
|---------|---------------|--------|
| Sentinel Hornet | **Sentinel Hornet（維持）** | KPI劣化検出・ロールバック・隔離を追加 |
| 静的Colony構成 | **Swarming Protocol** | テンプレートベースの適応的編成 |
| （なし） | **Guard Bee（門番蜂）** | 品質検証の専門ロール |
| （なし） | **Forager Bee（採餌蜂）** | 探索的テスト・影響分析・違和感検知 |
| （なし） | **Referee Bee（審判蜂）** | N案の自動採点・生存選抜トーナメント |
| （なし） | **Honeycomb（巣房）** | 実行履歴からの学習基盤 |
| （なし） | **Scout Bee（偵察蜂）** | 過去実績に基づく最適化 |
| Policy Gate | **Waggle Dance** | I/O検証を構造化通信プロトコルに発展 |
| 暗黙の品質基準 | **KPI体系** | 5指標で健全性を計測 |
| （暗黙的） | **Evidence-first 原則** | 全判断に証拠を要求 |
| （暗黙的） | **Evolving SOP 原則** | SOPをフィードバックで進化 |

## 付録B: 参考リンク

- [v5コンセプト（アーカイブ）](archive/コンセプト_v5.md)
- [v5-hive-design.md — 詳細設計](design/v5-hive-design.md)
- [開発計画 v2](DEVELOPMENT_PLAN_v2.md)
- [アーキテクチャ](ARCHITECTURE.md)
- [クイックスタート](QUICKSTART.md)
