# E2E テスト — master/develop マージ時のみ実行（Git Flow）
#
# クラウド LLM/VLM API (OpenAI, Anthropic) を使用するため、
# push トリガーのみ（pull_request では secrets にアクセスできない）。
#
# 安全対策:
#   - heavyweight マーカー付きテストを除外（API呼出 >50回のテスト）
#   - MAX_AGENT_ITERATIONS でエージェントループ回数を制限
#   - test_github_projection_e2e.py は heavyweight のためCI対象外
#
# 3 層構成:
#   L1: API フローテスト（外部依存なし、FastAPI TestClient のみ）
#   L2: LLM エージェントチェーンテスト（OpenAI API, 最大~30呼出）
#   L3: VLM ビジュアルテスト（Anthropic Claude Vision + Playwright MCP）
#
# コスト目安: ~$0.10-0.20/実行, ~$4-8/月（週5マージ想定）

name: E2E Tests

on:
  push:
    branches: [master, develop]

# 同一ブランチ上の前回実行をキャンセル
concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"

jobs:
  # =================================================================
  # L1: API フローテスト（外部依存なし）
  # =================================================================
  e2e-api:
    name: "E2E L1: API Flow"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run L1 E2E tests (API flow)
        run: |
          pytest tests/e2e/test_hive_flow.py \
            -v --tb=short \
            --timeout=60

      - name: Upload E2E report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-report-l1
          path: test_results/e2e_report/
          retention-days: 30

  # =================================================================
  # L2: LLM エージェントチェーンテスト
  # =================================================================
  e2e-llm:
    name: "E2E L2: LLM Agent Chain"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # L1 が通ってから実行
    needs: [e2e-api]
    # LLM テストは非決定的なので失敗しても全体を止めない
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run L2 E2E tests (LLM agent chain)
        env:
          LLM_PROVIDER: "openai"
          LLM_MODEL: "gpt-4o-mini"
          LLM_API_KEY_ENV: "OPENAI_API_KEY"
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LLM_TIMEOUT: "60"
          MAX_AGENT_ITERATIONS: "5"  # クラウドAPIコスト制御
        run: |
          pytest tests/e2e/test_agent_chain_llm.py \
            -v --tb=short \
            --timeout=120 \
            -m "e2e and not heavyweight" \
            -x

      - name: Annotate on LLM test failure
        if: failure()
        run: |
          echo "::warning::LLM E2E tests failed — this may be due to non-deterministic LLM responses. Review test output."

      - name: Upload E2E report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-report-l2
          path: test_results/e2e_report/
          retention-days: 30

  # =================================================================
  # L3: VLM ビジュアルテスト（Playwright MCP + Anthropic Vision）
  # =================================================================
  e2e-vlm:
    name: "E2E L3: VLM Visual"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [e2e-api]
    # VLM テストは非決定的なので失敗しても全体を止めない
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
      - name: Set up Node.js (for Playwright MCP)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,vlm]"
      - name: Start Playwright MCP server
        run: |
          npx -y @playwright/mcp@0.0.64 --port 8931 --headless &
          # サーバー起動を待機（SSEエンドポイントで確認）
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8931/sse -o /dev/null -m 2 2>/dev/null; then
              echo "Playwright MCP server ready"
              break
            fi
            echo "Waiting for Playwright MCP server... ($i/30)"
            sleep 2
          done
      - name: Run L3 E2E tests (VLM visual)
        env:
          VLM_PROVIDER: "anthropic"
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PLAYWRIGHT_MCP_URL: "http://localhost:8931"
        run: |
          pytest tests/e2e/test_kpi_dashboard_visual.py \
            -v --tb=short -m e2e \
            --timeout=180
      - name: Annotate on VLM test failure
        if: failure()
        run: |
          echo "::warning::VLM E2E tests failed — this may be due to non-deterministic VLM responses or Playwright MCP issues."

      - name: Upload E2E report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-report-l3
          path: test_results/e2e_report/
          retention-days: 30

  # =================================================================
  # レポート集約 → GitHub Pages デプロイ
  # =================================================================
  deploy-report:
    name: "Deploy E2E Report"
    runs-on: ubuntu-latest
    needs: [e2e-api, e2e-llm, e2e-vlm]
    if: always()
    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}e2e/

    steps:
      - uses: actions/checkout@v4

      - name: Download all E2E reports
        uses: actions/download-artifact@v4
        with:
          pattern: e2e-report-*
          path: _artifacts

      - name: Merge reports
        run: |
          mkdir -p _site/e2e/captures

          # 各レイヤーのキャプチャを統合
          for dir in _artifacts/e2e-report-*/captures; do
            if [ -d "$dir" ]; then
              cp -f "$dir"/* _site/e2e/captures/ 2>/dev/null || true
            fi
          done

          # 最も多くのテスト結果を含むレポートを使用し、他をマージ
          python3 - <<'PYEOF'
          import json, glob, os
          from pathlib import Path
          from datetime import datetime, timezone

          all_tests = {}
          for f in sorted(glob.glob("_artifacts/e2e-report-*/results.json")):
              data = json.loads(Path(f).read_text())
              for t in data.get("tests", []):
                  all_tests[t["nodeid"]] = t

          results = list(all_tests.values())
          if not results:
              print("No test results found")
              exit(0)

          # index.html を再生成
          now = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M:%S UTC")
          passed = sum(1 for r in results if r["outcome"] == "passed")
          failed = sum(1 for r in results if r["outcome"] == "failed")
          skipped = sum(1 for r in results if r["outcome"] == "skipped")
          total = len(results)

          def esc(t):
              return t.replace("&","&amp;").replace("<","&lt;").replace(">","&gt;")

          groups = {}
          for r in results:
              parts = r["nodeid"].split("::")
              gk = parts[1] if len(parts) > 1 else parts[0]
              groups.setdefault(gk, []).append(r)

          rows = ""
          for gn, tests in groups.items():
              rows += f'<tr class="group-header"><td colspan="4">{esc(gn)}</td></tr>\n'
              for t in tests:
                  icon = {"passed":"✅","failed":"❌","skipped":"⏭️"}.get(t["outcome"],"❓")
                  desc = t.get("doc") or t["name"]
                  caps = ""
                  if t.get("captures"):
                      caps = '<div class="captures">' + "".join(
                          f'<a href="captures/{c}" target="_blank"><img src="captures/{c}" loading="lazy"/></a>'
                          for c in t["captures"]
                      ) + '</div>'
                  err = ""
                  if t.get("error") and t["outcome"] == "failed":
                      err = f'<div class="error-msg">{esc(t["error"])}</div>'
                  rows += (
                      f'<tr class="test-row {t["outcome"]}">'
                      f'<td class="status">{icon}</td>'
                      f'<td class="test-name">{esc(desc)}{err}</td>'
                      f'<td class="duration">{t["duration"]}s</td>'
                      f'<td>{caps}</td></tr>\n'
                  )

          html = f"""<!DOCTYPE html>
          <html lang="ja"><head><meta charset="UTF-8">
          <meta name="viewport" content="width=device-width,initial-scale=1.0">
          <title>ColonyForge E2E Test Report</title>
          <style>
          :root{{--bg:#0d1117;--surface:#161b22;--border:#30363d;--text:#e6edf3;--text-dim:#8b949e;--green:#3fb950;--red:#f85149;--yellow:#d29922;--blue:#58a6ff}}
          *{{margin:0;padding:0;box-sizing:border-box}}
          body{{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;padding:24px}}
          .container{{max-width:1200px;margin:0 auto}}h1{{font-size:24px;margin-bottom:8px}}
          .meta{{color:var(--text-dim);font-size:13px;margin-bottom:20px}}
          .summary{{display:flex;gap:16px;margin-bottom:24px;flex-wrap:wrap}}
          .summary-card{{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px 20px;text-align:center;min-width:100px}}
          .summary-card .count{{font-size:28px;font-weight:700}}.summary-card .label{{font-size:12px;color:var(--text-dim);text-transform:uppercase}}
          .count.passed{{color:var(--green)}}.count.failed{{color:var(--red)}}.count.skipped{{color:var(--yellow)}}.count.total{{color:var(--blue)}}
          table{{width:100%;border-collapse:collapse;background:var(--surface);border-radius:8px;overflow:hidden;border:1px solid var(--border)}}
          .group-header td{{background:#1c2128;font-weight:600;font-size:13px;padding:8px 12px;color:var(--blue);border-bottom:1px solid var(--border)}}
          .test-row td{{padding:8px 12px;border-bottom:1px solid var(--border);vertical-align:top;font-size:13px}}
          .test-row:hover{{background:#1c2128}}.test-row.passed .status{{color:var(--green)}}.test-row.failed .status{{color:var(--red)}}.test-row.skipped .status{{color:var(--yellow)}}
          .status{{width:30px;text-align:center;font-size:16px}}.test-name{{max-width:500px}}.duration{{width:60px;text-align:right;color:var(--text-dim);font-family:monospace}}
          .error-msg{{margin-top:4px;padding:4px 8px;font-size:11px;background:rgba(248,81,73,0.1);border-left:3px solid var(--red);color:var(--red);border-radius:2px;font-family:monospace;white-space:pre-wrap;word-break:break-all;max-height:80px;overflow:auto}}
          .captures{{display:flex;gap:6px;flex-wrap:wrap}}.captures img{{width:120px;height:80px;object-fit:cover;border-radius:4px;border:1px solid var(--border);cursor:pointer;transition:transform .2s}}.captures img:hover{{transform:scale(1.5);z-index:10;position:relative}}
          .filter-bar{{display:flex;gap:8px;margin-bottom:16px}}.filter-btn{{padding:4px 12px;border-radius:16px;border:1px solid var(--border);background:var(--surface);color:var(--text-dim);cursor:pointer;font-size:12px}}.filter-btn.active{{border-color:var(--blue);color:var(--blue)}}.filter-btn:hover{{border-color:var(--text-dim)}}
          </style></head><body><div class="container">
          <h1>ColonyForge E2E Test Report</h1><div class="meta">Generated: {now}</div>
          <div class="summary">
            <div class="summary-card"><div class="count total">{total}</div><div class="label">Total</div></div>
            <div class="summary-card"><div class="count passed">{passed}</div><div class="label">Passed</div></div>
            <div class="summary-card"><div class="count failed">{failed}</div><div class="label">Failed</div></div>
            <div class="summary-card"><div class="count skipped">{skipped}</div><div class="label">Skipped</div></div>
          </div>
          <div class="filter-bar">
            <button class="filter-btn active" onclick="filterTests('all')">All</button>
            <button class="filter-btn" onclick="filterTests('passed')">✅ Passed</button>
            <button class="filter-btn" onclick="filterTests('failed')">❌ Failed</button>
            <button class="filter-btn" onclick="filterTests('skipped')">⏭️ Skipped</button>
          </div>
          <table><thead><tr><th style="width:30px"></th><th>Test</th><th style="width:60px">Time</th><th>Captures</th></tr></thead>
          <tbody>{rows}</tbody></table></div>
          <script>
          function filterTests(s){{document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));event.target.classList.add('active');document.querySelectorAll('.test-row').forEach(r=>{{r.style.display=(s==='all'||r.classList.contains(s))?'':'none'}});document.querySelectorAll('.group-header').forEach(h=>{{let n=[];let s=h.nextElementSibling;while(s&&!s.classList.contains('group-header')){{if(s.classList.contains('test-row'))n.push(s);s=s.nextElementSibling}}h.style.display=n.some(r=>r.style.display!=='none')?'':'none'}})}}
          </script></body></html>"""

          Path("_site/e2e/index.html").write_text(html, encoding="utf-8")
          print(f"Report: {total} tests ({passed} passed, {failed} failed, {skipped} skipped)")
          PYEOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
