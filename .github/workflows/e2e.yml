# E2E テスト — master/develop マージ時のみ実行（Git Flow）
#
# クラウド LLM/VLM API (OpenAI, Anthropic) を使用するため、
# push トリガーのみ（pull_request では secrets にアクセスできない）。
#
# 安全対策:
#   - heavyweight マーカー付きテストを除外（API呼出 >50回のテスト）
#   - MAX_AGENT_ITERATIONS でエージェントループ回数を制限
#   - test_github_projection_e2e.py は heavyweight のためCI対象外
#
# 3 層構成:
#   L1: API フローテスト（外部依存なし、FastAPI TestClient のみ）
#   L2: LLM エージェントチェーンテスト（OpenAI API, 最大~30呼出）
#   L3: VLM ビジュアルテスト（Anthropic Claude Vision + Playwright MCP）
#
# コスト目安: ~$0.10-0.20/実行, ~$4-8/月（週5マージ想定）

name: E2E Tests

on:
  push:
    branches: [master, develop]

# 同一ブランチ上の前回実行をキャンセル
concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"

jobs:
  # =================================================================
  # L1: API フローテスト（外部依存なし）
  # =================================================================
  e2e-api:
    name: "E2E L1: API Flow"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run L1 E2E tests (API flow)
        run: |
          pytest tests/e2e/test_hive_flow.py \
            -v --tb=short \
            --timeout=60

  # =================================================================
  # L2: LLM エージェントチェーンテスト
  # =================================================================
  e2e-llm:
    name: "E2E L2: LLM Agent Chain"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # L1 が通ってから実行
    needs: [e2e-api]
    # LLM テストは非決定的なので失敗しても全体を止めない
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run L2 E2E tests (LLM agent chain)
        env:
          LLM_PROVIDER: "openai"
          LLM_MODEL: "gpt-4o-mini"
          LLM_API_KEY_ENV: "OPENAI_API_KEY"
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LLM_TIMEOUT: "60"
          MAX_AGENT_ITERATIONS: "5"  # クラウドAPIコスト制御
        run: |
          pytest tests/e2e/test_agent_chain_llm.py \
            -v --tb=short \
            --timeout=120 \
            -m "e2e and not heavyweight" \
            -x

      - name: Annotate on LLM test failure
        if: failure()
        run: |
          echo "::warning::LLM E2E tests failed — this may be due to non-deterministic LLM responses. Review test output."

  # =================================================================
  # L3: VLM ビジュアルテスト（Playwright MCP + Anthropic Vision）
  # =================================================================
  e2e-vlm:
    name: "E2E L3: VLM Visual"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [e2e-api]
    # VLM テストは非決定的なので失敗しても全体を止めない
    continue-on-error: true

    services:
      playwright-mcp:
        image: ghcr.io/anthropics/playwright-mcp:latest
        ports:
          - 8931:8931

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Run L3 E2E tests (VLM visual)
        env:
          VLM_PROVIDER: "anthropic"
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PLAYWRIGHT_MCP_URL: "http://localhost:8931"
        run: |
          pytest tests/e2e/test_kpi_dashboard_visual.py \
            -v --tb=short -m e2e \
            --timeout=180
      - name: Annotate on VLM test failure
        if: failure()
        run: |
          echo "::warning::VLM E2E tests failed — this may be due to non-deterministic VLM responses or Playwright MCP issues."
