<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>KPI Dashboard Test</title>
<style>
:root {
    --vscode-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    --vscode-font-size: 13px;
    --vscode-foreground: #cccccc;
    --vscode-editor-background: #1e1e1e;
    --vscode-sideBar-background: #252526;
    --vscode-widget-border: #474747;
    --vscode-descriptionForeground: #8e8e8e;
    --vscode-input-background: #3c3c3c;
    --vscode-editor-font-family: Consolas, monospace;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: var(--vscode-font-family);
    font-size: var(--vscode-font-size);
    color: var(--vscode-foreground);
    background: var(--vscode-editor-background);
    padding: 20px;
}
h1 { font-size: 16px; margin-bottom: 16px; }
.kpi-dashboard {
    border: 1px solid var(--vscode-widget-border);
    border-radius: 8px;
    background: var(--vscode-sideBar-background);
    padding: 12px 16px;
    max-width: 800px;
}
.kpi-header {
    display: flex; justify-content: space-between;
    align-items: center; margin-bottom: 10px;
}
.kpi-header h2 { font-size: 13px; font-weight: 600; }
.kpi-meta {
    font-size: 11px;
    color: var(--vscode-descriptionForeground);
}
.kpi-section { margin-bottom: 10px; }
.kpi-section h3 {
    font-size: 11px; font-weight: 600;
    color: var(--vscode-descriptionForeground);
    text-transform: uppercase; letter-spacing: 0.5px;
    margin-bottom: 6px;
}
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 6px;
}
.kpi-gauge {
    position: relative; background: var(--vscode-input-background);
    border-radius: 4px; overflow: hidden; height: 28px;
}
.kpi-gauge-bar {
    position: absolute; top: 0; left: 0; bottom: 0;
    opacity: 0.2; transition: width 0.5s ease;
}
.kpi-gauge-content {
    position: relative; display: flex;
    justify-content: space-between; align-items: center;
    padding: 0 8px; height: 100%; font-size: 11px;
}
.kpi-gauge-label {
    color: var(--vscode-foreground);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.kpi-gauge-value {
    font-weight: 700;
    font-family: var(--vscode-editor-font-family);
    white-space: nowrap;
}
.kpi-breakdown { display: flex; flex-wrap: wrap; gap: 6px; }
.kpi-tag {
    padding: 2px 8px; border-radius: 10px;
    font-size: 10px; font-weight: 600;
}
.kpi-tag.success { background: rgba(76,175,80,0.2); color: #4caf50; }
.kpi-tag.failure { background: rgba(244,67,54,0.2); color: #f44336; }
</style>
</head>
<body>
<h1>KPI Dashboard</h1>
<div class="kpi-dashboard" id="kpiDashboard"></div>

<script>
const DATA = {
    "total_episodes": 10,
    "colony_count": 3,
    "kpi": {
        "correctness": 0.8,
        "repeatability": 0.0,
        "lead_time_seconds": 121.59,
        "incident_rate": 0.3,
        "recurrence_rate": 0.0
    },
    "collaboration": {
        "rework_rate": null,
        "escalation_ratio": null,
        "n_proposal_yield": null,
        "cost_per_task_tokens": 1405.0,
        "collaboration_overhead": 0.3
    },
    "gate_accuracy": {
        "guard_pass_rate": null,
        "guard_conditional_pass_rate": null,
        "guard_fail_rate": null,
        "sentinel_detection_rate": null,
        "sentinel_false_alarm_rate": null
    },
    "outcomes": { "success": 8, "failure": 2 },
    "failure_classes": { "timeout": 1, "implementation_error": 1 }
};

function pct(v) { return v != null ? (v * 100).toFixed(1) + '%' : '\u2014'; }
function num(v, u) { return v != null ? v.toFixed(1) + (u || '') : '\u2014'; }
function gaugeColor(v, invert) {
    if (v == null) return '#9e9e9e';
    if (invert) v = 1 - v;
    if (v >= 0.8) return '#4caf50';
    if (v >= 0.5) return '#ff9800';
    return '#f44336';
}
function gauge(label, value, unit, invert, max) {
    const display = unit === '%' ? pct(value) : num(value, unit);
    const norm = (max && value != null) ? Math.min(value / max, 1.0) : value;
    const color = gaugeColor(norm, invert);
    const pctVal = norm != null ? Math.min(norm * 100, 100) : 0;
    return '<div class="kpi-gauge">' +
        '<div class="kpi-gauge-bar" style="width:' + pctVal + '%;background:' + color + '"></div>' +
        '<div class="kpi-gauge-content">' +
        '<span class="kpi-gauge-label">' + label + '</span>' +
        '<span class="kpi-gauge-value" style="color:' + color + '">' + display + '</span>' +
        '</div></div>';
}

function render(ev) {
    const kpi = ev.kpi || {};
    const collab = ev.collaboration || {};
    const gate = ev.gate_accuracy || {};

    let h = '<div class="kpi-header">' +
        '<h2>KPI Dashboard</h2>' +
        '<span class="kpi-meta">' + ev.total_episodes + ' episodes / ' + ev.colony_count + ' colonies</span>' +
        '</div>';

    h += '<div class="kpi-section"><h3>Task Performance</h3><div class="kpi-grid">';
    h += gauge('Correctness', kpi.correctness, '%', false);
    h += gauge('Repeatability', kpi.repeatability, '%', false);
    h += gauge('Lead Time', kpi.lead_time_seconds, 's', true, 300);
    h += gauge('Incident Rate', kpi.incident_rate, '%', true);
    h += gauge('Recurrence', kpi.recurrence_rate, '%', true);
    h += '</div></div>';

    h += '<div class="kpi-section"><h3>Collaboration Quality</h3><div class="kpi-grid">';
    h += gauge('Rework Rate', collab.rework_rate, '%', true);
    h += gauge('Escalation', collab.escalation_ratio, '%', true);
    h += gauge('N-Proposal Yield', collab.n_proposal_yield, '%', false);
    h += gauge('Cost/Task', collab.cost_per_task_tokens, ' tok', true, 5000);
    h += gauge('Overhead', collab.collaboration_overhead, '%', true);
    h += '</div></div>';

    h += '<div class="kpi-section"><h3>Gate Accuracy</h3><div class="kpi-grid">';
    h += gauge('Guard PASS', gate.guard_pass_rate, '%', false);
    h += gauge('Guard COND', gate.guard_conditional_pass_rate, '%', false);
    h += gauge('Guard FAIL', gate.guard_fail_rate, '%', true);
    h += gauge('Sentinel Det.', gate.sentinel_detection_rate, '%', false);
    h += gauge('False Alarm', gate.sentinel_false_alarm_rate, '%', true);
    h += '</div></div>';

    if (ev.outcomes) {
        h += '<div class="kpi-section"><h3>Outcomes</h3><div class="kpi-breakdown">';
        for (const [k, v] of Object.entries(ev.outcomes)) {
            const cls = k === 'success' ? 'success' : 'failure';
            h += '<span class="kpi-tag ' + cls + '">' + k + ': ' + v + '</span>';
        }
        h += '</div></div>';
    }
    if (ev.failure_classes) {
        h += '<div class="kpi-section"><h3>Failure Classes</h3><div class="kpi-breakdown">';
        for (const [k, v] of Object.entries(ev.failure_classes)) {
            h += '<span class="kpi-tag failure">' + k + ': ' + v + '</span>';
        }
        h += '</div></div>';
    }

    document.getElementById('kpiDashboard').innerHTML = h;
}

render(DATA);
</script>
</body>
</html>